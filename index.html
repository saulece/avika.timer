<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avika - Temporizador de Sushi</title>
    <link rel="stylesheet" href="avika-style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link rel="icon" href="data:,">
</head>
<body>
    <header>
        <h1>Avika - Temporizador de Sushi</h1>
        <div class="header-controls">
            <button id="btn-help" class="icon-btn" title="Mostrar ayuda"><i class="fas fa-question-circle"></i></button>
        </div>
    </header>
    
    <div class="container">
        <!-- Notificaciones -->
        <div id="notification"></div>
        
        <!-- Sección de categorías -->
        <div id="categories-section">
            <h2>Selecciona una categoría</h2>
            <div class="category-container">
                <button class="category-btn" data-category="frio" data-tooltip="Platillos fríos como rollos y makis">Platillos Fríos</button>
                <button class="category-btn" data-category="entrada-fria" data-tooltip="Entradas frías como ceviches y sashimis">Entradas Frías</button>
                <button class="category-btn" data-category="caliente" data-tooltip="Platillos calientes y sopas">Platillos Calientes</button>
                <button class="category-btn" data-category="entrada-caliente" data-tooltip="Entradas calientes como empanizados">Entradas Calientes</button>
                <button class="category-btn" data-category="combos" data-tooltip="Combos y promociones especiales">Combos</button>
            </div>
            
            <!-- Órdenes pendientes -->
            <div class="pending-orders-section">
                <h2>Platillos en preparación <span id="pending-count">0</span></h2>
                <div class="action-btns" style="margin-bottom: 10px;">
                    <button class="action-btn" id="btn-new-ticket" data-tooltip="Crear un nuevo ticket con múltiples platillos">Nuevo Ticket/Comanda</button>
                    <button class="action-btn" id="btn-force-complete" style="background-color: #ff9800;" data-tooltip="Solo usar en casos excepcionales cuando un ticket quedó atorado">Emergencia: Desbloquear</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Platillo</th>
                            <th>Inicio</th>
                            <th>Tiempo</th>
                            <th>Detalles</th>
                            <th>Acción</th>
                        </tr>
                    </thead>
                    <tbody id="pending-body">
                        <!-- Se llenará con JavaScript -->
                    </tbody>
                </table>
            </div>
            
            <!-- Órdenes completadas -->
            <div class="pending-orders-section">
                <h2>Platillos completados</h2>
                <div class="filter-controls">
                    <button id="btn-show-all-history" class="filter-btn" data-tooltip="Ver todas las órdenes completadas">Ver historial completo</button>
                    <button id="btn-show-recent" class="filter-btn active" data-tooltip="Ver solo las órdenes más recientes">Ver recientes</button>
                    <button id="btn-show-stats" class="filter-btn" data-tooltip="Ver estadísticas de tiempos promedios">Ver promedios</button>
                    <button id="btn-clear-history" class="filter-btn" data-tooltip="Eliminar historial de órdenes completadas">Limpiar historial</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Platillo</th>
                            <th>Inicio</th>
                            <th>Fin</th>
                            <th>Tiempo total</th>
                            <th>Detalles</th>
                        </tr>
                    </thead>
                    <tbody id="completed-body">
                        <!-- Se llenará con JavaScript -->
                    </tbody>
                </table>
                <button class="back-btn" id="btn-export" data-tooltip="Exportar datos para análisis">Exportar datos</button>
            </div>
        </div>
        
        <!-- Sección de platillos -->
        <div id="dishes-section" style="display: none;">
            <h2 id="selected-category-title">Categoría</h2>
            <div id="dishes-container" class="dishes-container" style="display: block;">
                <!-- Se llenará con JavaScript -->
                <div id="debug-info" style="margin-top: 20px; padding: 10px; background-color: #f9f9f9; border: 1px solid #ddd;">
                    <p>Si no ves los platillos, actualiza la página con Ctrl+F5</p>
                </div>
            </div>
            
            <button class="back-btn" id="btn-back-to-categories">Volver a Categorías</button>
        </div>
        
        <!-- Sección de preparación -->
        <div id="preparation-section" class="preparation-section">
            <h2 id="selected-dish-title">Platillo seleccionado</h2>
            
            <div class="compact-form-container">
                <div class="option-group" id="service-options">
                    <div class="option-title">Tipo de servicio:</div>
                    <div class="option-btns">
                        <button id="btn-comedor" class="option-btn selected">Comedor</button>
                        <button id="btn-domicilio" class="option-btn">Domicilio</button>
                        <button id="btn-para-llevar" class="option-btn">Ordena y Espera</button>
                    </div>
                </div>
                
                <div class="option-group" id="quantity-control">
                    <div class="option-title">Cantidad:</div>
                    <div class="qty-control">
                        <button class="qty-btn">-</button>
                        <span id="quantity-display" class="qty-display">1</span>
                        <button class="qty-btn">+</button>
                    </div>
                </div>
                
                <div class="option-group" id="customization-options">
                    <div class="option-title">Personalizaciones:</div>
                    <div class="option-btns" id="customization-container">
                        <!-- Se llenará dinámicamente -->
                    </div>
                </div>
                
                <div class="option-group">
                    <div class="option-title">Notas adicionales:</div>
                    <textarea id="notes-input" class="notes-input" placeholder="Cualquier instrucción adicional..."></textarea>
                </div>
                
                <div class="action-btns">
                    <button id="btn-cancel" class="action-btn cancel-btn">Cancelar</button>
                    <button id="btn-start" class="action-btn start-btn">Iniciar preparación</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de ayuda -->
    <div id="help-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h2>Guía Rápida de Uso</h2>
            
            <div class="help-section">
                <h3>Flujo de trabajo básico</h3>
                <ol>
                    <li>Selecciona una categoría de platillo</li>
                    <li>Elige el platillo específico</li>
                    <li>Configura personalizaciones, tipo de servicio y cantidad</li>
                    <li>Inicia la preparación</li>
                    <li>Marca como "Listo" cuando el platillo esté terminado</li>
                </ol>
            </div>
            
            <div class="help-section">
                <h3>Trabajar con tickets</h3>
                <ol>
                    <li>Haz clic en "Nuevo Ticket/Comanda"</li>
                    <li>Añade varios platillos al ticket</li>
                    <li>Selecciona el tipo de servicio para todo el ticket</li>
                    <li>Guarda el ticket</li>
                    <li>Marca como "Listo" cada platillo a medida que se completen</li>
                    <li>El ticket se moverá a completados cuando todos los platillos estén listos</li>
                </ol>
            </div>
            
            <div class="help-section">
                <h3>Estados de los platillos</h3>
                <ul>
                    <li><strong>En preparación:</strong> Platillo recién agregado</li>
                    <li><strong>Esperando otros platillos:</strong> Este platillo ya está listo pero otros del mismo ticket aún no</li>
                    <li><strong>Listo para salida:</strong> Para domicilios, indica que está listo para entregar al repartidor</li>
                </ul>
            </div>
        </div>
    </div>
    
    <!-- Cargar módulos en orden correcto -->
    <script src="avika-core.js"></script>
    <script src="js/modules/config.js"></script>
    <script src="js/modules/ui-controller.js"></script>
    <script src="js/modules/order-service.js"></script>
    <script src="js/modules/storage.js"></script>
    <script src="js/modules/stats.js"></script>
    <script src="avika-init.js"></script>
    
    <!-- Script para tooltips y ayuda -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Inicializar modal de ayuda
        var helpModal = document.getElementById('help-modal');
        var helpBtn = document.getElementById('btn-help');
        var closeBtn = helpModal.querySelector('.close-modal');
        
        helpBtn.onclick = function() {
            helpModal.style.display = 'block';
        }
        
        closeBtn.onclick = function() {
            helpModal.style.display = 'none';
        }
        
        // Cerrar modal haciendo clic fuera
        window.onclick = function(event) {
            if (event.target == helpModal) {
                helpModal.style.display = 'none';
            }
        }
        
        // Inicializar tooltips
        document.querySelectorAll('[data-tooltip]').forEach(function(element) {
            element.addEventListener('mouseenter', function() {
                var tooltip = document.createElement('div');
                tooltip.className = 'tooltip';
                tooltip.textContent = this.getAttribute('data-tooltip');
                
                // Posicionar tooltip
                document.body.appendChild(tooltip);
                var rect = this.getBoundingClientRect();
                tooltip.style.left = rect.left + (rect.width / 2) - (tooltip.offsetWidth / 2) + 'px';
                tooltip.style.top = rect.top - tooltip.offsetHeight - 5 + 'px';
                
                // Almacenar referencia al tooltip
                this.tooltip = tooltip;
            });
            
            element.addEventListener('mouseleave', function() {
                if (this.tooltip) {
                    document.body.removeChild(this.tooltip);
                    this.tooltip = null;
                }
            });
        });
    });
    </script>

    <!-- Script de correcciones integrado directamente -->
    <script>
    // Correcciones para Avika
    (function() {
        console.log("Aplicando correcciones para Avika...");
        
        // Esperar a que el DOM esté completamente cargado
        document.addEventListener('DOMContentLoaded', function() {
            // Corregir error de formatTime
            if (Avika && Avika.ui) {
                // Verificar si las tablas están utilizando 'self' en lugar de 'this'
                var originalUpdatePendingTable = Avika.ui.updatePendingTable;
                Avika.ui.updatePendingTable = function() {
                    try {
                        console.log("Ejecutando updatePendingTable corregido");
                        var self = this; // Asegurar que 'self' refiere a 'this'
                        
                        var pendingBody = document.getElementById('pending-body');
                        if (!pendingBody) {
                            console.error("Elemento pending-body no encontrado");
                            return;
                        }
                        
                        // Limpiar tabla
                        pendingBody.innerHTML = '';
                        
                        // Verificar si hay órdenes pendientes
                        if (!Avika.data.pendingOrders || Avika.data.pendingOrders.length === 0) {
                            var row = pendingBody.insertRow();
                            var cell = row.insertCell(0);
                            cell.colSpan = 5;
                            cell.textContent = "No hay platillos en preparación";
                            cell.style.textAlign = "center";
                            cell.style.padding = "20px";
                            
                            // Actualizar contador
                            var pendingCount = document.getElementById('pending-count');
                            if (pendingCount) {
                                pendingCount.textContent = "0";
                            }
                            
                            return;
                        }
                        
                        // El resto de la función se ejecutará sólo si hay errores
                        originalUpdatePendingTable.call(this);
                    } catch (e) {
                        console.error("Error en updatePendingTable:", e);
                        this.showNotification("Error al actualizar tabla: " + e.message);
                        
                        // Mostrar un mensaje de error en la tabla
                        var pendingBody = document.getElementById('pending-body');
                        if (pendingBody) {
                            var row = pendingBody.insertRow();
                            var cell = row.insertCell(0);
                            cell.colSpan = 5;
                            cell.innerHTML = "Error al actualizar tabla.<br>Consulta la consola para más detalles.";
                            cell.style.textAlign = "center";
                            cell.style.padding = "20px";
                            cell.style.color = "red";
                        }
                    }
                };
                
                // Corregir la función formatTime que está causando el error
                console.log("Verificando función formatTime");
                if (!Avika.ui.formatTime) {
                    Avika.ui.formatTime = function(date) {
                        if (!date) return '--:--:--';
                        
                        var hours = this.padZero(date.getHours());
                        var minutes = this.padZero(date.getMinutes());
                        var seconds = this.padZero(date.getSeconds());
                        return hours + ':' + minutes + ':' + seconds;
                    };
                }
                
                // Corregir la función addOrderRow
                Avika.ui.addOrderRow = function(tbody, order, index) {
                    var row = tbody.insertRow();
                    
                    // Platillo
                    var dishCell = row.insertCell(0);
                    dishCell.textContent = order.dish + (order.quantity > 1 ? ' (' + order.quantity + ')' : '');
                    
                    // Hora de inicio
                    var startCell = row.insertCell(1);
                    startCell.textContent = Avika.ui.formatTime(new Date(order.startTime));
                    
                    // Temporizador
                    var timerCell = row.insertCell(2);
                    timerCell.className = 'timer-cell';
                    timerCell.setAttribute('data-start-time', order.startTime);
                    timerCell.textContent = Avika.ui.calculateElapsedTime(order.startTime);
                    
                    // Detalles
                    var detailsCell = row.insertCell(3);
                    
                    // Servicio
                    var serviceText = '';
                    switch (order.service) {
                        case 'comedor': serviceText = 'Comedor'; break;
                        case 'domicilio': serviceText = 'Domicilio'; break;
                        case 'para-llevar': serviceText = 'Ordena y Espera'; break;
                        default: serviceText = order.service;
                    }
                    
                    // Personalización
                    var customText = '';
                    if (order.customizations && order.customizations.length > 0) {
                        order.customizations.forEach(function(code) {
                            if (Avika.config.customizationOptions[code]) {
                                customText += Avika.config.customizationOptions[code] + ', ';
                            }
                        });
                        customText = customText.slice(0, -2); // Eliminar última coma y espacio
                    }
                    
                    // Notas
                    var notesText = order.notes ? '<br>Nota: ' + order.notes : '';
                    
                    // Combinar toda la información
                    detailsCell.innerHTML = '<strong>' + serviceText + '</strong>' + 
                                            (customText ? '<br>' + customText : '') + 
                                            notesText;
                    
                    // Acciones
                    var actionsCell = row.insertCell(4);
                    
                    // Botón para marcar como completado
                    var completeBtn = document.createElement('button');
                    completeBtn.textContent = 'Listo';
                    completeBtn.className = 'action-btn';
                    
                    var self = Avika.ui; // Usar directamente Avika.ui en lugar de 'this'
                    completeBtn.onclick = function() {
                        self.completeOrder(index);
                    };
                    
                    actionsCell.appendChild(completeBtn);
                };
                
                // Reemplazar la función enableTicketMode con una versión mejorada
                Avika.ui.enableTicketMode = function() {
                    console.log("Activando modo ticket mejorado");
                    
                    try {
                        // Cambiar estado de la UI
                        this.state.ticketMode = true;
                        this.state.ticketItems = [];
                        
                        // Crear modal para ticket si no existe
                        var ticketModal = document.getElementById('ticket-modal');
                        if (!ticketModal) {
                            console.log("Creando modal para ticket");
                            
                            ticketModal = document.createElement('div');
                            ticketModal.id = 'ticket-modal';
                            ticketModal.className = 'modal';
                            
                            var modalContent = document.createElement('div');
                            modalContent.className = 'modal-content';
                            modalContent.style.maxWidth = '800px';
                            modalContent.style.width = '90%';
                            
                            // Botón para cerrar
                            var closeBtn = document.createElement('span');
                            closeBtn.className = 'close-modal';
                            closeBtn.innerHTML = '&times;';
                            closeBtn.onclick = function() {
                                ticketModal.style.display = 'none';
                                Avika.ui.state.ticketMode = false;
                            };
                            
                            // Título
                            var title = document.createElement('h2');
                            title.textContent = 'Nuevo Ticket / Comanda';
                            
                            // Selección de hora común para todos los platillos
                            var timeSection = document.createElement('div');
                            timeSection.className = 'option-group';
                            timeSection.innerHTML = `
                                <div class="option-title">Hora de entrada:</div>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <input id="ticket-hour" type="number" min="0" max="23" value="${new Date().getHours()}" style="width: 60px; text-align: center; font-size: 18px; padding: 5px;">
                                    <span style="font-size: 18px;">:</span>
                                    <input id="ticket-minute" type="number" min="0" max="59" value="${new Date().getMinutes()}" style="width: 60px; text-align: center; font-size: 18px; padding: 5px;">
                                    <span style="margin-left: 10px; font-size: 14px; color: #666;">(Hora común para todos los platillos)</span>
                                </div>
                            `;
                            
                            // Sistema de pestañas para categorías y platillos
                            var tabsSection = document.createElement('div');
                            tabsSection.className = 'ticket-tabs-section';
                            tabsSection.style.marginTop = '20px';
                            
                            // Pestañas de categorías
                            var tabsNav = document.createElement('div');
                            tabsNav.className = 'ticket-tabs-nav';
                            tabsNav.style.display = 'flex';
                            tabsNav.style.borderBottom = '1px solid #ddd';
                            tabsNav.style.marginBottom = '15px';
                            
                            // Añadir pestañas para cada categoría
                            var categories = [
                                { id: 'frio', name: 'Platillos Fríos' },
                                { id: 'entrada-fria', name: 'Entradas Frías' },
                                { id: 'caliente', name: 'Platillos Calientes' },
                                { id: 'entrada-caliente', name: 'Entradas Calientes' },
                                { id: 'combos', name: 'Combos' }
                            ];
                            
                            categories.forEach(function(cat, index) {
                                var tab = document.createElement('div');
                                tab.className = 'ticket-tab' + (index === 0 ? ' active' : '');
                                tab.setAttribute('data-category', cat.id);
                                tab.textContent = cat.name;
                                tab.style.padding = '10px 15px';
                                tab.style.cursor = 'pointer';
                                tab.style.borderBottom = index === 0 ? '2px solid #3498db' : 'none';
                                tab.style.fontWeight = index === 0 ? 'bold' : 'normal';
                                
                                tab.onclick = function() {
                                    // Desactivar todas las pestañas
                                    document.querySelectorAll('.ticket-tab').forEach(function(t) {
                                        t.style.borderBottom = 'none';
                                        t.style.fontWeight = 'normal';
                                        t.classList.remove('active');
                                    });
                                    
                                    // Activar esta pestaña
                                    this.style.borderBottom = '2px solid #3498db';
                                    this.style.fontWeight = 'bold';
                                    this.classList.add('active');
                                    
                                    // Mostrar platillos de esta categoría
                                    Avika.ui.showTicketDishes(this.getAttribute('data-category'));
                                };
                                
                                tabsNav.appendChild(tab);
                            });
                            
                            // Contenedor para platillos
                            var dishesContainer = document.createElement('div');
                            dishesContainer.id = 'ticket-dishes-container';
                            dishesContainer.style.display = 'grid';
                            dishesContainer.style.gridTemplateColumns = 'repeat(auto-fill, minmax(150px, 1fr))';
                            dishesContainer.style.gap = '10px';
                            dishesContainer.style.maxHeight = '200px';
                            dishesContainer.style.overflowY = 'auto';
                            
                            tabsSection.appendChild(tabsNav);
                            tabsSection.appendChild(dishesContainer);
                            
                            // Contenedor para platillos añadidos
                            var itemsContainer = document.createElement('div');
                            itemsContainer.id = 'ticket-items';
                            itemsContainer.className = 'ticket-items';
                            itemsContainer.style.marginTop = '20px';
                            
                            // Título para platillos añadidos
                            var itemsTitle = document.createElement('h3');
                            itemsTitle.textContent = 'Platillos añadidos:';
                            
                            // Tabla de platillos añadidos
                            var table = document.createElement('table');
                            table.className = 'ticket-table';
                            table.style.width = '100%';
                            
                            var thead = document.createElement('thead');
                            thead.innerHTML = '<tr><th>Cant.</th><th>Platillo</th><th>Personalización</th><th>Acciones</th></tr>';
                            
                            var tbody = document.createElement('tbody');
                            tbody.id = 'ticket-items-body';
                            
                            table.appendChild(thead);
                            table.appendChild(tbody);
                            
                            itemsContainer.appendChild(itemsTitle);
                            itemsContainer.appendChild(table);
                            
                            // Opciones de servicio para ticket
                            var serviceOptions = document.createElement('div');
                            serviceOptions.className = 'option-group';
                            serviceOptions.style.marginTop = '20px';
                            serviceOptions.innerHTML = `
                                <div class="option-title">Tipo de servicio para todo el ticket:</div>
                                <div class="option-btns">
                                    <button id="ticket-btn-comedor" class="option-btn selected">Comedor</button>
                                    <button id="ticket-btn-domicilio" class="option-btn">Domicilio</button>
                                    <button id="ticket-btn-para-llevar" class="option-btn">Ordena y espera</button>
                                </div>
                            `;
                            
                            // Notas para todo el ticket
                            var notesGroup = document.createElement('div');
                            notesGroup.className = 'option-group';
                            notesGroup.style.marginTop = '15px';
                            notesGroup.innerHTML = `
                                <div class="option-title">Notas generales para el ticket:</div>
                                <textarea id="ticket-notes" class="notes-input" placeholder="Notas generales que aplican a todo el ticket..."></textarea>
                            `;
                            
                            // Botones de acción
                            var actionBtns = document.createElement('div');
                            actionBtns.className = 'action-btns';
                            actionBtns.style.marginTop = '20px';
                            actionBtns.style.display = 'flex';
                            actionBtns.style.justifyContent = 'space-between';
                            actionBtns.innerHTML = `
                                <button id="btn-cancel-ticket" class="action-btn cancel-btn">Cancelar</button>
                                <button id="btn-save-ticket" class="action-btn start-btn">Guardar ticket</button>
                            `;
                            
                            // Añadir elementos al modal
                            modalContent.appendChild(closeBtn);
                            modalContent.appendChild(title);
                            modalContent.appendChild(timeSection);
                            modalContent.appendChild(tabsSection);
                            modalContent.appendChild(itemsContainer);
                            modalContent.appendChild(serviceOptions);
                            modalContent.appendChild(notesGroup);
                            modalContent.appendChild(actionBtns);
                            
                            ticketModal.appendChild(modalContent);
                            document.body.appendChild(ticketModal);
                            
                            console.log("Modal de ticket creado correctamente");
                        }
                        
                        // Asegurarse de que los botones tengan los eventos correctos
                        console.log("Asignando eventos a los botones del ticket modal");
                        
                        // Botones de servicio
                        var btnComedor = document.getElementById('ticket-btn-comedor');
                        if (btnComedor) {
                            btnComedor.onclick = function() {
                                Avika.ui.selectTicketService(this, 'comedor');
                            };
                        }
                        
                        var btnDomicilio = document.getElementById('ticket-btn-domicilio');
                        if (btnDomicilio) {
                            btnDomicilio.onclick = function() {
                                Avika.ui.selectTicketService(this, 'domicilio');
                            };
                        }
                        
                        var btnParaLlevar = document.getElementById('ticket-btn-para-llevar');
                        if (btnParaLlevar) {
                            btnParaLlevar.onclick = function() {
                                Avika.ui.selectTicketService(this, 'para-llevar');
                            };
                        }
                        
                        // Botón para cancelar ticket
                        var btnCancelTicket = document.getElementById('btn-cancel-ticket');
                        if (btnCancelTicket) {
                            btnCancelTicket.onclick = function() {
                                ticketModal.style.display = 'none';
                                Avika.ui.state.ticketMode = false;
                            };
                        }
                        
                        // Botón para guardar ticket
                        var btnSaveTicket = document.getElementById('btn-save-ticket');
                        if (btnSaveTicket) {
                            btnSaveTicket.onclick = function() {
                                Avika.ui.saveTicket();
                            };
                        }
                        
                        // Limpiar tabla de items
                        var ticketItemsBody = document.getElementById('ticket-items-body');
                        if (ticketItemsBody) {
                            ticketItemsBody.innerHTML = '';
                        }
                        
                        // Resetear servicio del ticket
                        this.state.ticketService = 'comedor';
                        
                        if (btnComedor) btnComedor.classList.add('selected');
                        if (btnDomicilio) btnDomicilio.classList.remove('selected');
                        if (btnParaLlevar) btnParaLlevar.classList.remove('selected');
                        
                        // Limpiar notas
                        var ticketNotes = document.getElementById('ticket-notes');
                        if (ticketNotes) ticketNotes.value = '';
                        
                        // Mostrar platillos de la primera categoría
                        this.showTicketDishes('frio');
                        
                        // Mostrar modal
                        console.log("Mostrando modal de ticket");
                        ticketModal.style.display = 'block';
                        
                    } catch (e) {
                        console.error("Error al activar modo ticket:", e);
                        Avika.ui.showErrorMessage("Error al activar modo ticket: " + e.message);
                    }
                };

                // Función para mostrar platillos dentro del modal de ticket
                Avika.ui.showTicketDishes = function(category) {
                    console.log("Mostrando platillos de categoría en ticket:", category);
                    
                    var dishesContainer = document.getElementById('ticket-dishes-container');
                    if (!dishesContainer) {
                        console.error("No se encontró el contenedor de platillos del ticket");
                        return;
                    }
                    
                    // Limpiar contenedor
                    dishesContainer.innerHTML = '';
                    
                    // Verificar si hay platillos para esta categoría
                    if (!Avika.config.dishes[category] || Avika.config.dishes[category].length === 0) {
                        dishesContainer.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 20px;">No hay platillos en esta categoría</div>';
                        return;
                    }
                    
                    // Mostrar platillos
                    Avika.config.dishes[category].forEach(function(dish) {
                        var button = document.createElement('button');
                        button.className = 'dish-btn';
                        button.textContent = dish;
                        button.style.padding = '10px';
                        button.style.textAlign = 'center';
                        button.style.borderRadius = '5px';
                        button.style.border = '1px solid #ddd';
                        button.style.background = '#fff';
                        button.style.cursor = 'pointer';
                        
                        button.onclick = function() {
                            Avika.ui.addDishToTicket(dish);
                        };
                        
                        dishesContainer.appendChild(button);
                    });
                };

                // Función para añadir platillo al ticket
                Avika.ui.addDishToTicket = function(dish) {
                    console.log("Añadiendo platillo al ticket:", dish);
                    
                    // Crear item para el ticket
                    var ticketItem = {
                        dish: dish,
                        quantity: 1,
                        customizations: [],
                        notes: ''
                    };
                    
                    // Añadir a la lista
                    this.state.ticketItems.push(ticketItem);
                    
                    // Actualizar tabla
                    this.updateTicketItems();
                    
                    // Mostrar notificación
                    this.showNotification("Platillo añadido al ticket: " + dish);
                };

                // Función para actualizar la tabla de items del ticket
                Avika.ui.updateTicketItems = function() {
                    console.log("Actualizando items del ticket");
                    
                    var ticketItemsBody = document.getElementById('ticket-items-body');
                    if (!ticketItemsBody) {
                        console.error("No se encontró el contenedor de items del ticket");
                        return;
                    }
                    
                    // Limpiar tabla
                    ticketItemsBody.innerHTML = '';
                    
                    // Si no hay items, mostrar mensaje
                    if (this.state.ticketItems.length === 0) {
                        var row = ticketItemsBody.insertRow();
                        var cell = row.insertCell(0);
                        cell.colSpan = 4;
                        cell.textContent = "No hay platillos añadidos al ticket";
                        cell.style.textAlign = "center";
                        cell.style.padding = "10px";
                        return;
                    }
                    
                    // Mostrar cada item
                    this.state.ticketItems.forEach(function(item, index) {
                        var row = ticketItemsBody.insertRow();
                        
                        // Cantidad
                        var quantityCell = row.insertCell(0);
                        quantityCell.textContent = item.quantity;
                        
                        // Platillo
                        var dishCell = row.insertCell(1);
                        dishCell.textContent = item.dish;
                        
                        // Personalización y notas
                        var customCell = row.insertCell(2);
                        
                        // Personalización
                        var customText = '';
                        if (item.customizations && item.customizations.length > 0) {
                            item.customizations.forEach(function(code) {
                                if (Avika.config.customizationOptions[code]) {
                                    customText += Avika.config.customizationOptions[code] + ', ';
                                }
                            });
                            customText = customText.slice(0, -2); // Eliminar última coma y espacio
                        }
                        
                        // Notas
                        var notesText = item.notes ? 'Notas: ' + item.notes : '';
                        
                        customCell.textContent = customText + (customText && notesText ? ' - ' : '') + notesText || '-';
                        
                        // Acciones
                        var actionsCell = row.insertCell(3);
                        var removeBtn = document.createElement('button');
                        removeBtn.textContent = 'Eliminar';
                        removeBtn.className = 'action-btn cancel-btn';
                        removeBtn.style.padding = '5px 10px';
                        removeBtn.style.fontSize = '0.8rem';
                        
                        var self = Avika.ui;
                        removeBtn.onclick = function() {
                            self.removeTicketItem(index);
                        };
                        
                        actionsCell.appendChild(removeBtn);
                    });
                };

                // Función para eliminar item del ticket
                Avika.ui.removeTicketItem = function(index) {
                    console.log("Eliminando item del ticket:", index);
                    
                    if (index >= 0 && index < this.state.ticketItems.length) {
                        this.state.ticketItems.splice(index, 1);
                        this.updateTicketItems();
                        this.showNotification("Platillo eliminado del ticket");
                    }
                };

                // Función para guardar el ticket con hora común
                Avika.ui.saveTicket = function() {
                    console.log("Guardando ticket con", this.state.ticketItems.length, "platillos");
                    
                    if (this.state.ticketItems.length === 0) {
                        this.showNotification("Error: No hay platillos en el ticket");
                        return;
                    }
                    
                    try {
                        // Obtener la hora seleccionada
                        var hourInput = document.getElementById('ticket-hour');
                        var minuteInput = document.getElementById('ticket-minute');
                        
                        var hour = parseInt(hourInput.value, 10);
                        var minute = parseInt(minuteInput.value, 10);
                        
                        // Validar los valores
                        if (isNaN(hour) || hour < 0 || hour > 23) {
                            this.showNotification("Error: Hora inválida (0-23)");
                            return;
                        }
                        
                        if (isNaN(minute) || minute < 0 || minute > 59) {
                            this.showNotification("Error: Minutos inválidos (0-59)");
                            return;
                        }
                        
                        // Crear fecha con la hora seleccionada
                        var selectedTime = new Date();
                        selectedTime.setHours(hour, minute, 0, 0);
                        
                        // Obtener tipo de servicio y notas
                        var serviceType = this.state.ticketService;
                        var notes = document.getElementById('ticket-notes').value.trim();
                        
                        // Crear nuevo ticket
                        var ticketId = 'ticket-' + Date.now();
                        
                        // Procesar cada platillo y agregarlo a órdenes pendientes
                        this.state.ticketItems.forEach(function(item) {
                            var newOrder = {
                                id: Date.now() + '-' + Math.floor(Math.random() * 1000),
                                dish: item.dish,
                                quantity: item.quantity,
                                customizations: item.customizations,
                                notes: item.notes,
                                service: serviceType,
                                ticketId: ticketId,
                                startTime: selectedTime,
                                startTimeISO: selectedTime.toISOString(),
                                finishTime: null,
                                status: 'pending'
                            };
                            
                            // Agregar a órdenes pendientes
                            if (!Avika.data.pendingOrders) {
                                Avika.data.pendingOrders = [];
                            }
                            
                            Avika.data.pendingOrders.push(newOrder);
                        });
                        
                        // Guardar datos
                        if (Avika.storage && typeof Avika.storage.guardarDatosLocales === 'function') {
                            Avika.storage.guardarDatosLocales();
                        }
                        
                        // Actualizar tabla de órdenes pendientes
                        this.updatePendingTable();
                        
                        // Cerrar modal
                        var ticketModal = document.getElementById('ticket-modal');
                        if (ticketModal) {
                            ticketModal.style.display = 'none';
                        }
                        
                        // Resetear estado
                        this.state.ticketMode = false;
                        this.state.ticketItems = [];
                        
                        // Notificación
                        var ticketItems = this.state.ticketItems.length;
                        this.showNotification("Ticket guardado con " + ticketItems + " platillos a las " + 
                                            this.padZero(hour) + ":" + this.padZero(minute));
                        
                    } catch (e) {
                        console.error("Error al guardar ticket:", e);
                        this.showErrorMessage("Error al guardar ticket: " + e.message);
                    }
                };

                // Función para seleccionar servicio en el ticket
                Avika.ui.selectTicketService = function(button, service) {
                    console.log("Seleccionando servicio de ticket:", service);
                    
                    // Obtener todos los botones de servicio
                    var btnComedor = document.getElementById('ticket-btn-comedor');
                    var btnDomicilio = document.getElementById('ticket-btn-domicilio');
                    var btnParaLlevar = document.getElementById('ticket-btn-para-llevar');
                    
                    // Quitar clase 'selected' de todos los botones
                    if (btnComedor) btnComedor.classList.remove('selected');
                    if (btnDomicilio) btnDomicilio.classList.remove('selected');
                    if (btnParaLlevar) btnParaLlevar.classList.remove('selected');
                    
                    // Añadir clase 'selected' al botón seleccionado
                    if (button) button.classList.add('selected');
                    
                    // Actualizar estado
                    this.state.ticketService = service;
                };
                
                // Corregir función calculateElapsedTime si no existe
                if (!Avika.ui.calculateElapsedTime) {
                    Avika.ui.calculateElapsedTime = function(startTimeStr) {
                        var startTime = new Date(startTimeStr);
                        var now = new Date();
                        var elapsed = Math.floor((now - startTime) / 1000); // en segundos
                        
                        var hours = Math.floor(elapsed / 3600);
                        var minutes = Math.floor((elapsed % 3600) / 60);
                        var seconds = elapsed % 60;
                        
                        var timeStr = '';
                        
                        if (hours > 0) {
                            timeStr += hours + 'h ';
                        }
                        
                        timeStr += this.padZero(minutes) + ':' + this.padZero(seconds);
                        
                        return timeStr;
                    };
                }
                
                // Volver a asignar eventos a los botones de categoría
                var categoryButtons = document.querySelectorAll('.category-btn[data-category]');
                categoryButtons.forEach(function(btn) {
                    // Crear una copia del botón para limpiar eventos previos
                    var btnClone = btn.cloneNode(true);
                    if (btn.parentNode) {
                        btn.parentNode.replaceChild(btnClone, btn);
                    }
                    
                    // Asignar nuevo evento
                    var category = btnClone.getAttribute('data-category');
                    btnClone.addEventListener('click', function() {
                        console.log("Clic en categoría:", category);
                        Avika.ui.selectCategory(category);
                    });
                });
                
                // Corregir botón de nuevo ticket
                var newTicketBtn = document.getElementById('btn-new-ticket');
                if (newTicketBtn) {
                    // Crear una copia del botón para limpiar eventos previos
                    var btnClone = newTicketBtn.cloneNode(true);
                    if (newTicketBtn.parentNode) {
                        newTicketBtn.parentNode.replaceChild(btnClone, newTicketBtn);
                    }
                    
                    // Asignar nuevo evento
                    btnClone.addEventListener('click', function() {
                        console.log("Clic en botón Nuevo Ticket");
                        Avika.ui.enableTicketMode();
                    });
                }
            }
            
            console.log("Correcciones aplicadas correctamente");
        });
    })();
    
    </script>
    <script>
        // Corregir estilos y funcionalidad del modal de tickets y botones
        (function() {
            console.log("Aplicando correcciones adicionales para estilos y funcionalidad...");
            
            document.addEventListener('DOMContentLoaded', function() {
                // Corregir problemas con la función formatTime que causa errores al completar una orden
                if (Avika && Avika.ui) {
                    // Asegurar que completeOrder funcione correctamente
                    var originalCompleteOrder = Avika.ui.completeOrder;
                    Avika.ui.completeOrder = function(index) {
                        try {
                            console.log("Completando orden con índice:", index);
                            
                            // Verificar que la orden existe
                            if (!Avika.data.pendingOrders || index < 0 || index >= Avika.data.pendingOrders.length) {
                                console.error("Orden no válida:", index);
                                this.showNotification("Error: Orden no válida");
                                return;
                            }
                            
                            var order = Avika.data.pendingOrders[index];
                            
                            // Actualizar estado y tiempo de finalización
                            order.status = 'completed';
                            order.finishTime = new Date();
                            
                            // Calcular tiempo transcurrido en formato legible
                            var startTime = new Date(order.startTime);
                            var elapsedMs = order.finishTime - startTime;
                            var elapsedSec = Math.floor(elapsedMs / 1000);
                            var minutes = Math.floor(elapsedSec / 60);
                            var seconds = elapsedSec % 60;
                            var prepTimeFormatted = (minutes < 10 ? "0" : "") + minutes + ":" + (seconds < 10 ? "0" : "") + seconds;
                            order.prepTime = prepTimeFormatted;
                            
                            // Formatear fechas para mostrar
                            order.startTimeFormatted = this.formatTimeDirectly(startTime);
                            order.finishTimeFormatted = this.formatTimeDirectly(order.finishTime);
                            
                            // Guardar datos para serialización correcta
                            var orderForStorage = JSON.parse(JSON.stringify(order));
                            if (orderForStorage.startTime) {
                                orderForStorage.startTimeISO = new Date(order.startTime).toISOString();
                            }
                            if (orderForStorage.finishTime) {
                                orderForStorage.finishTimeISO = new Date(order.finishTime).toISOString();
                            }
                            
                            // Mover a órdenes completadas
                            if (!Avika.data.completedOrders) {
                                Avika.data.completedOrders = [];
                            }
                            
                            Avika.data.completedOrders.unshift(orderForStorage);
                            
                            // Eliminar de órdenes pendientes
                            Avika.data.pendingOrders.splice(index, 1);
                            
                            // Guardar datos
                            if (Avika.storage && typeof Avika.storage.guardarDatosLocales === 'function') {
                                Avika.storage.guardarDatosLocales();
                            }
                            
                            // Actualizar tablas
                            this.updatePendingTable();
                            
                            if (typeof this.updateCompletedTable === 'function') {
                                this.updateCompletedTable(false);
                            }
                            
                            // Notificar
                            this.showNotification("Platillo '" + order.dish + "' marcado como completado");
                            
                        } catch (e) {
                            console.error("Error al completar orden:", e);
                            this.showErrorMessage("Error al completar orden: " + e.message);
                        }
                    };
                    
                    // Agregar una función directa para formatear la hora sin depender de this/self
                    Avika.ui.formatTimeDirectly = function(date) {
                        if (!date) return '--:--:--';
                        
                        var hours = date.getHours();
                        var minutes = date.getMinutes();
                        var seconds = date.getSeconds();
                        
                        hours = (hours < 10) ? '0' + hours : hours;
                        minutes = (minutes < 10) ? '0' + minutes : minutes;
                        seconds = (seconds < 10) ? '0' + seconds : seconds;
                        
                        return hours + ':' + minutes + ':' + seconds;
                    };
                    
                    // Mejorar la función enableTicketMode para corregir los estilos
                    var originalEnableTicketMode = Avika.ui.enableTicketMode;
                    Avika.ui.enableTicketMode = function() {
                        // Llamar a la función original primero
                        originalEnableTicketMode.call(this);
                        
                        // Corregir estilos después de que se haya creado el modal
                        setTimeout(function() {
                            // Corregir estilos de las pestañas de categorías
                            var tabsNav = document.querySelector('.ticket-tabs-nav');
                            if (tabsNav) {
                                tabsNav.style.overflow = 'auto';
                                tabsNav.style.WebkitOverflowScrolling = 'touch';
                                tabsNav.style.whiteSpace = 'nowrap';
                                tabsNav.style.display = 'flex';
                                tabsNav.style.width = '100%';
                                
                                var tabs = tabsNav.querySelectorAll('.ticket-tab');
                                tabs.forEach(function(tab) {
                                    tab.style.padding = '10px';
                                    tab.style.backgroundColor = '#f0f0f0';
                                    tab.style.marginRight = '5px';
                                    tab.style.borderRadius = '5px 5px 0 0';
                                    tab.style.cursor = 'pointer';
                                    tab.style.fontSize = '14px';
                                    
                                    // Asegurarse de que el texto sea siempre visible
                                    if (tab.classList.contains('active')) {
                                        tab.style.backgroundColor = '#3498db';
                                        tab.style.color = 'white';
                                    } else {
                                        tab.style.backgroundColor = '#f0f0f0';
                                        tab.style.color = '#333';
                                    }
                                    
                                    // Agregar evento para actualizar estilos al hacer clic
                                    tab.onclick = function() {
                                        // Actualizar estilos para todos los tabs
                                        tabs.forEach(function(t) {
                                            t.style.backgroundColor = '#f0f0f0';
                                            t.style.color = '#333';
                                            t.style.fontWeight = 'normal';
                                            t.classList.remove('active');
                                        });
                                        
                                        // Actualizar estilo para el tab seleccionado
                                        this.style.backgroundColor = '#3498db';
                                        this.style.color = 'white';
                                        this.style.fontWeight = 'bold';
                                        this.classList.add('active');
                                        
                                        // Mostrar platillos de esta categoría
                                        var category = this.getAttribute('data-category');
                                        Avika.ui.showTicketDishes(category);
                                    };
                                });
                            }
                            
                            // Corregir estilos de los botones de platillos
                            var dishesContainer = document.getElementById('ticket-dishes-container');
                            if (dishesContainer) {
                                dishesContainer.style.maxHeight = '200px';
                                dishesContainer.style.overflowY = 'auto';
                                
                                var buttons = dishesContainer.querySelectorAll('.dish-btn');
                                buttons.forEach(function(btn) {
                                    btn.style.padding = '12px';
                                    btn.style.backgroundColor = '#f9f9f9';
                                    btn.style.color = '#333';
                                    btn.style.border = '1px solid #ddd';
                                    btn.style.borderRadius = '5px';
                                    btn.style.cursor = 'pointer';
                                    btn.style.fontSize = '14px';
                                    btn.style.textAlign = 'center';
                                    btn.style.transition = 'all 0.2s ease';
                                    
                                    // Agregar hover effect
                                    btn.onmouseover = function() {
                                        this.style.backgroundColor = '#3498db';
                                        this.style.color = 'white';
                                        this.style.transform = 'translateY(-2px)';
                                    };
                                    
                                    btn.onmouseout = function() {
                                        this.style.backgroundColor = '#f9f9f9';
                                        this.style.color = '#333';
                                        this.style.transform = 'translateY(0)';
                                    };
                                });
                            }
                            
                            // Corregir botón Eliminar en la tabla de platillos añadidos
                            var removeBtns = document.querySelectorAll('#ticket-items-body .action-btn.cancel-btn');
                            removeBtns.forEach(function(btn) {
                                btn.textContent = 'Eliminar';
                                btn.style.backgroundColor = '#e74c3c';
                                btn.style.color = 'white';
                                btn.style.padding = '5px 10px';
                                btn.style.border = 'none';
                                btn.style.borderRadius = '4px';
                                btn.style.cursor = 'pointer';
                                btn.style.fontSize = '13px';
                                btn.style.width = 'auto';
                                btn.style.minWidth = '60px';
                            });
                            
                            // Corregir estilos de los botones de servicio
                            var serviceBtns = document.querySelectorAll('#ticket-modal .option-btns .option-btn');
                            serviceBtns.forEach(function(btn) {
                                btn.style.padding = '10px';
                                btn.style.backgroundColor = '#f9f9f9';
                                btn.style.color = '#333';
                                btn.style.border = '1px solid #ddd';
                                btn.style.borderRadius = '5px';
                                btn.style.cursor = 'pointer';
                                btn.style.fontSize = '14px';
                                btn.style.textAlign = 'center';
                                
                                if (btn.classList.contains('selected')) {
                                    btn.style.backgroundColor = '#3498db';
                                    btn.style.color = 'white';
                                    btn.style.borderColor = '#3498db';
                                }
                            });
                            
                            // Corregir botones de acción principales
                            var saveBtn = document.getElementById('btn-save-ticket');
                            var cancelBtn = document.getElementById('btn-cancel-ticket');
                            
                            if (saveBtn) {
                                saveBtn.style.backgroundColor = '#2ecc71';
                                saveBtn.style.color = 'white';
                                saveBtn.style.border = 'none';
                                saveBtn.style.padding = '12px 24px';
                                saveBtn.style.borderRadius = '5px';
                                saveBtn.style.cursor = 'pointer';
                                saveBtn.style.fontSize = '16px';
                                saveBtn.style.fontWeight = 'bold';
                                saveBtn.style.width = '48%';
                            }
                            
                            if (cancelBtn) {
                                cancelBtn.style.backgroundColor = '#e74c3c';
                                cancelBtn.style.color = 'white';
                                cancelBtn.style.border = 'none';
                                cancelBtn.style.padding = '12px 24px';
                                cancelBtn.style.borderRadius = '5px';
                                cancelBtn.style.cursor = 'pointer';
                                cancelBtn.style.fontSize = '16px';
                                cancelBtn.style.width = '48%';
                            }
                        }, 100);
                    };
                    
                    // Mejorar la actualización de la tabla de platillos pendientes
                    var originalUpdatePendingTable = Avika.ui.updatePendingTable;
                    Avika.ui.updatePendingTable = function() {
                        try {
                            // Llamar a la función original
                            originalUpdatePendingTable.call(this);
                            
                            // Corregir estilos de los botones Listo y Colapsar
                            setTimeout(function() {
                                // Corregir botones de acción como "Listo"
                                var actionBtns = document.querySelectorAll('#pending-body .action-btn');
                                actionBtns.forEach(function(btn) {
                                    if (btn.textContent === 'Listo') {
                                        btn.style.backgroundColor = '#2ecc71';
                                        btn.style.color = 'white';
                                        btn.style.border = 'none';
                                        btn.style.padding = '6px 12px';
                                        btn.style.borderRadius = '4px';
                                        btn.style.cursor = 'pointer';
                                        btn.style.fontSize = '14px';
                                        btn.style.width = '100%';
                                        btn.style.maxWidth = '100px';
                                    }
                                });
                                
                                // Corregir botones Colapsar
                                var collapseBtns = document.querySelectorAll('#pending-body [data-ticket-id] button');
                                collapseBtns.forEach(function(btn) {
                                    if (btn.textContent.includes('Colapsar')) {
                                        btn.style.backgroundColor = '#3498db';
                                        btn.style.color = 'white';
                                        btn.style.border = 'none';
                                        btn.style.padding = '5px 10px';
                                        btn.style.borderRadius = '4px';
                                        btn.style.cursor = 'pointer';
                                        btn.style.fontSize = '13px';
                                    }
                                });
                            }, 100);
                        } catch (e) {
                            console.error("Error en updatePendingTable mejorado:", e);
                        }
                    };
                    
                    // Mejorar la función showTicketDishes para mejor visualización
                    Avika.ui.showTicketDishes = function(category) {
                        console.log("Mostrando platillos de categoría en ticket (mejorado):", category);
                        
                        var dishesContainer = document.getElementById('ticket-dishes-container');
                        if (!dishesContainer) {
                            console.error("No se encontró el contenedor de platillos del ticket");
                            return;
                        }
                        
                        // Limpiar contenedor
                        dishesContainer.innerHTML = '';
                        
                        // Verificar si hay platillos para esta categoría
                        if (!Avika.config.dishes[category] || Avika.config.dishes[category].length === 0) {
                            dishesContainer.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 20px; color: #666;">No hay platillos en esta categoría</div>';
                            return;
                        }
                        
                        // Mostrar platillos con mejor estilo
                        Avika.config.dishes[category].forEach(function(dish) {
                            var button = document.createElement('button');
                            button.className = 'dish-btn';
                            button.textContent = dish;
                            button.style.padding = '12px';
                            button.style.backgroundColor = '#f9f9f9';
                            button.style.color = '#333';
                            button.style.border = '1px solid #ddd';
                            button.style.borderRadius = '5px';
                            button.style.cursor = 'pointer';
                            button.style.fontSize = '14px';
                            button.style.textAlign = 'center';
                            button.style.transition = 'all 0.2s ease';
                            
                            // Hover effects
                            button.onmouseover = function() {
                                this.style.backgroundColor = '#3498db';
                                this.style.color = 'white';
                                this.style.transform = 'translateY(-2px)';
                            };
                            
                            button.onmouseout = function() {
                                this.style.backgroundColor = '#f9f9f9';
                                this.style.color = '#333';
                                this.style.transform = 'translateY(0)';
                            };
                            
                            button.onclick = function() {
                                Avika.ui.addDishToTicket(dish);
                            };
                            
                            dishesContainer.appendChild(button);
                        });
                    };
                }
                
                console.log("Correcciones adicionales de estilos aplicadas correctamente");
            });
        })();
        </script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log("Aplicando correcciones para botones...");
            
            // Reinicializar todos los botones de categoría
            var categoryButtons = document.querySelectorAll('.category-btn[data-category]');
            categoryButtons.forEach(function(btn) {
                // Clonar para eliminar eventos anteriores
                var newBtn = btn.cloneNode(true);
                btn.parentNode.replaceChild(newBtn, btn);
                
                // Agregar nuevo evento
                var category = newBtn.getAttribute('data-category');
                newBtn.addEventListener('click', function() {
                    Avika.ui.selectCategory(category);
                });
            });
            
            // Corregir botón de nuevo ticket
            var newTicketBtn = document.getElementById('btn-new-ticket');
            if (newTicketBtn) {
                var newBtn = newTicketBtn.cloneNode(true);
                newTicketBtn.parentNode.replaceChild(newBtn, newTicketBtn);
                newBtn.addEventListener('click', function() {
                    if (typeof Avika.ui.enableTicketMode === 'function') {
                        Avika.ui.enableTicketMode();
                    } else {
                        console.error("Función enableTicketMode no encontrada");
                    }
                });
            }
            
            // Corregir botones de servicio
            ['btn-comedor', 'btn-domicilio', 'btn-para-llevar'].forEach(function(id) {
                var btn = document.getElementById(id);
                if (btn) {
                    var newBtn = btn.cloneNode(true);
                    btn.parentNode.replaceChild(newBtn, btn);
                    
                    var service = id.replace('btn-', '');
                    newBtn.addEventListener('click', function() {
                        Avika.data.currentService = service;
                        
                        // Quitar selección de todos los botones
                        document.querySelectorAll('#service-options .option-btn').forEach(function(b) {
                            b.classList.remove('selected');
                        });
                        
                        // Añadir selección a este botón
                        this.classList.add('selected');
                    });
                }
            });
            
            // Corregir botón de iniciar preparación
            var startBtn = document.getElementById('btn-start');
            if (startBtn) {
                var newBtn = startBtn.cloneNode(true);
                startBtn.parentNode.replaceChild(newBtn, startBtn);
                newBtn.addEventListener('click', function() {
                    console.log("Iniciando preparación...");
                    
                    // Si la función startPreparation existe, usarla
                    if (typeof Avika.orders.startPreparation === 'function') {
                        Avika.orders.startPreparation();
                    } else if (typeof Avika.ui.startPreparation === 'function') {
                        Avika.ui.startPreparation();
                    } else {
                        console.error("Función startPreparation no encontrada");
                        
                        // Implementación básica como fallback
                        var newOrder = {
                            id: Date.now().toString(),
                            dish: Avika.data.currentDish,
                            quantity: Avika.data.currentQuantity,
                            customizations: Avika.data.currentCustomizations || [],
                            service: Avika.data.currentService,
                            notes: document.getElementById('notes-input').value || '',
                            startTime: new Date()
                        };
                        
                        if (!Avika.data.pendingOrders) Avika.data.pendingOrders = [];
                        Avika.data.pendingOrders.push(newOrder);
                        
                        // Guardar y actualizar UI
                        if (Avika.storage && typeof Avika.storage.guardarDatosLocales === 'function') {
                            Avika.storage.guardarDatosLocales();
                        }
                        
                        if (typeof Avika.ui.updatePendingTable === 'function') {
                            Avika.ui.updatePendingTable();
                        }
                        
                        // Volver a categorías
                        document.getElementById('categories-section').style.display = 'block';
                        document.getElementById('preparation-section').style.display = 'none';
                    }
                });
            }
            
            // Corregir botones de cantidad
            var qtyButtons = document.querySelectorAll('.qty-btn');
            qtyButtons.forEach(function(btn) {
                var newBtn = btn.cloneNode(true);
                btn.parentNode.replaceChild(newBtn, btn);
                
                newBtn.addEventListener('click', function() {
                    var isIncrement = this.textContent === '+';
                    var qtyDisplay = document.getElementById('quantity-display');
                    
                    if (!qtyDisplay) return;
                    
                    var current = parseInt(qtyDisplay.textContent) || 1;
                    
                    if (isIncrement) {
                        current = Math.min(current + 1, 10);
                    } else {
                        current = Math.max(current - 1, 1);
                    }
                    
                    qtyDisplay.textContent = current;
                    Avika.data.currentQuantity = current;
                });
            });
            
            console.log("Correcciones para botones aplicadas");
        });
        // Añadir al final del script anterior
// Implementar función selectCategory si no existe o tiene errores
if (!Avika.ui.selectCategory || typeof Avika.ui.selectCategory !== 'function') {
    Avika.ui.selectCategory = function(category) {
        console.log("Seleccionando categoría:", category);
        
        // Guardar categoría seleccionada
        Avika.data.currentCategory = category;
        
        // Actualizar título
        var categoryTitle = document.getElementById('selected-category-title');
        if (categoryTitle) {
            categoryTitle.textContent = Avika.config.categoryNames[category] || category;
        }
        
        // Limpiar contenedor de platillos
        var dishesContainer = document.getElementById('dishes-container');
        if (!dishesContainer) {
            console.error("Contenedor de platillos no encontrado");
            return;
        }
        
        dishesContainer.innerHTML = '';
        
        // Verificar si hay platillos en esta categoría
        if (!Avika.config.dishes[category] || Avika.config.dishes[category].length === 0) {
            dishesContainer.innerHTML = '<p>No hay platillos en esta categoría</p>';
            return;
        }
        
        // Agregar botones para cada platillo
        Avika.config.dishes[category].forEach(function(dish) {
            var button = document.createElement('button');
            button.className = 'dish-btn';
            button.textContent = dish;
            
            // Verificar si es combo especial
            var isSpecial = Avika.config.specialCombos && 
                          Avika.config.specialCombos.indexOf(dish) !== -1;
            
            if (isSpecial) {
                button.classList.add('special-combo');
            }
            
            button.addEventListener('click', function() {
                Avika.ui.selectDish(dish, isSpecial);
            });
            
            dishesContainer.appendChild(button);
        });
        
        // Mostrar sección de platillos
        document.getElementById('categories-section').style.display = 'none';
        document.getElementById('dishes-section').style.display = 'block';
    };
}

// Implementar función selectDish si no existe
if (!Avika.ui.selectDish || typeof Avika.ui.selectDish !== 'function') {
    Avika.ui.selectDish = function(dish, isSpecial) {
        console.log("Seleccionando platillo:", dish, "Especial:", isSpecial);
        
        // Guardar platillo seleccionado
        Avika.data.currentDish = dish;
        Avika.data.isSpecialCombo = isSpecial || false;
        
        // Actualizar título
        var dishTitle = document.getElementById('selected-dish-title');
        if (dishTitle) {
            dishTitle.textContent = dish;
        }
        
        // Resetear personalización
        Avika.data.currentCustomizations = [];
        var customizationContainer = document.getElementById('customization-container');
        if (customizationContainer) {
            customizationContainer.innerHTML = '';
            
            // Añadir opciones de personalización
            if (Avika.config.customizationOptions) {
                for (var code in Avika.config.customizationOptions) {
                    var option = Avika.config.customizationOptions[code];
                    
                    var button = document.createElement('button');
                    button.className = 'option-btn';
                    button.textContent = option;
                    button.setAttribute('data-code', code);
                    
                    button.addEventListener('click', function() {
                        var code = this.getAttribute('data-code');
                        Avika.ui.toggleCustomization(this, code);
                    });
                    
                    customizationContainer.appendChild(button);
                }
            }
        }
        
        // Resetear cantidad
        Avika.data.currentQuantity = 1;
        var quantityDisplay = document.getElementById('quantity-display');
        if (quantityDisplay) {
            quantityDisplay.textContent = '1';
        }
        
        // Resetear servicio
        Avika.data.currentService = 'comedor';
        var serviceBtns = document.querySelectorAll('#service-options .option-btn');
        serviceBtns.forEach(function(btn) {
            btn.classList.remove('selected');
        });
        var btnComedor = document.getElementById('btn-comedor');
        if (btnComedor) {
            btnComedor.classList.add('selected');
        }
        
        // Mostrar sección de preparación
        document.getElementById('dishes-section').style.display = 'none';
        document.getElementById('preparation-section').style.display = 'block';
    };
}

// Implementar función toggleCustomization si no existe
if (!Avika.ui.toggleCustomization || typeof Avika.ui.toggleCustomization !== 'function') {
    Avika.ui.toggleCustomization = function(button, code) {
        // Verificar si ya está seleccionada
        var index = Avika.data.currentCustomizations.indexOf(code);
        
        if (index === -1) {
            // Agregar
            Avika.data.currentCustomizations.push(code);
            button.classList.add('selected');
        } else {
            // Quitar
            Avika.data.currentCustomizations.splice(index, 1);
            button.classList.remove('selected');
        }
    };
}
// Añadir al final del script anterior
// Implementar updatePendingTable si tiene errores
Avika.ui.updatePendingTable = function() {
    try {
        console.log("Actualizando tabla de órdenes pendientes");
        
        var pendingBody = document.getElementById('pending-body');
        if (!pendingBody) {
            console.error("Elemento pending-body no encontrado");
            return;
        }
        
        // Limpiar tabla
        pendingBody.innerHTML = '';
        
        // Verificar si hay órdenes pendientes
        if (!Avika.data.pendingOrders || Avika.data.pendingOrders.length === 0) {
            var row = pendingBody.insertRow();
            var cell = row.insertCell(0);
            cell.colSpan = 5;
            cell.textContent = "No hay platillos en preparación";
            cell.style.textAlign = "center";
            cell.style.padding = "20px";
            
            // Actualizar contador
            var pendingCount = document.getElementById('pending-count');
            if (pendingCount) {
                pendingCount.textContent = "0";
            }
            
            return;
        }
        
        // Actualizar contador
        var pendingCount = document.getElementById('pending-count');
        if (pendingCount) {
            pendingCount.textContent = Avika.data.pendingOrders.length;
        }
        
        // Mostrar cada orden
        Avika.data.pendingOrders.forEach(function(order, index) {
            var row = pendingBody.insertRow();
            
            // Platillo
            var dishCell = row.insertCell(0);
            dishCell.textContent = order.dish + (order.quantity > 1 ? ' (' + order.quantity + ')' : '');
            
            // Hora de inicio
            var startCell = row.insertCell(1);
            var startTime = order.startTime instanceof Date ? order.startTime : new Date(order.startTime);
            startCell.textContent = Avika.ui.formatTime(startTime);
            
            // Temporizador
            var timerCell = row.insertCell(2);
            timerCell.className = 'timer-cell';
            timerCell.setAttribute('data-start-time', startTime.toISOString());
            timerCell.textContent = Avika.ui.calculateElapsedTime(startTime);
            
            // Detalles
            var detailsCell = row.insertCell(3);
            
            // Servicio
            var serviceText = '';
            switch (order.service) {
                case 'comedor': serviceText = 'Comedor'; break;
                case 'domicilio': serviceText = 'Domicilio'; break;
                case 'para-llevar': serviceText = 'Ordena y Espera'; break;
                default: serviceText = order.service;
            }
            
            // Personalización
            var customText = '';
            if (order.customizations && order.customizations.length > 0) {
                order.customizations.forEach(function(code) {
                    if (Avika.config.customizationOptions[code]) {
                        customText += Avika.config.customizationOptions[code] + ', ';
                    }
                });
                customText = customText.slice(0, -2); // Eliminar última coma y espacio
            }
            
            // Notas
            var notesText = order.notes ? '<br>Nota: ' + order.notes : '';
            
            // Combinar toda la información
            detailsCell.innerHTML = '<strong>' + serviceText + '</strong>' + 
                                   (customText ? '<br>' + customText : '') + 
                                   notesText;
            
            // Acciones
            var actionsCell = row.insertCell(4);
            
            // Botón para marcar como completado
            var completeBtn = document.createElement('button');
            completeBtn.textContent = 'Listo';
            completeBtn.className = 'action-btn';
            completeBtn.style.backgroundColor = '#2ecc71';
            completeBtn.style.color = 'white';
            completeBtn.style.border = 'none';
            completeBtn.style.padding = '10px';
            completeBtn.style.borderRadius = '4px';
            completeBtn.style.cursor = 'pointer';
            
            completeBtn.addEventListener('click', function() {
                Avika.ui.completeOrder(index);
            });
            
            actionsCell.appendChild(completeBtn);
        });
    } catch (e) {
        console.error("Error al actualizar tabla de pendientes:", e);
    }
};

// Implementar completeOrder si no existe o tiene errores
if (!Avika.ui.completeOrder || typeof Avika.ui.completeOrder !== 'function') {
    Avika.ui.completeOrder = function(index) {
        try {
            console.log("Completando orden en índice:", index);
            
            if (!Avika.data.pendingOrders || index < 0 || index >= Avika.data.pendingOrders.length) {
                console.error("Índice inválido o no hay órdenes pendientes");
                return;
            }
            
            var order = Avika.data.pendingOrders[index];
            var endTime = new Date();
            
            // Calcular tiempo de preparación
            var startTime = order.startTime instanceof Date ? order.startTime : new Date(order.startTime);
            var prepTimeMillis = endTime - startTime;
            var prepTimeSecs = Math.floor(prepTimeMillis / 1000);
            var prepMins = Math.floor(prepTimeSecs / 60);
            var prepSecs = prepTimeSecs % 60;
            
            var prepTimeFormatted = Avika.ui.padZero(prepMins) + ':' + Avika.ui.padZero(prepSecs);
            
            // Completar orden
            order.finishTime = endTime;
            order.prepTime = prepTimeFormatted;
            
            // Crear copia para órdenes completadas
            var completedOrder = JSON.parse(JSON.stringify(order));
            
            // Mover a órdenes completadas
            if (!Avika.data.completedOrders) {
                Avika.data.completedOrders = [];
            }
            
            Avika.data.completedOrders.unshift(completedOrder);
            
            // Eliminar de órdenes pendientes
            Avika.data.pendingOrders.splice(index, 1);
            
            // Guardar datos
            if (Avika.storage && typeof Avika.storage.guardarDatosLocales === 'function') {
                Avika.storage.guardarDatosLocales();
            }
            
            // Actualizar tablas
            this.updatePendingTable();
            
            if (typeof this.updateCompletedTable === 'function') {
                this.updateCompletedTable();
            }
            
            // Notificar
            if (typeof this.showNotification === 'function') {
                this.showNotification("Platillo '" + order.dish + "' marcado como completado");
            } else {
                alert("Platillo '" + order.dish + "' marcado como completado");
            }
        } catch (e) {
            console.error("Error al completar orden:", e);
        }
    };
}

// Implementar updateAllTimers si no existe
if (!Avika.ui.updateAllTimers || typeof Avika.ui.updateAllTimers !== 'function') {
    Avika.ui.updateAllTimers = function() {
        var timerCells = document.querySelectorAll('.timer-cell[data-start-time]');
        
        timerCells.forEach(function(cell) {
            var startTimeStr = cell.getAttribute('data-start-time');
            if (startTimeStr) {
                cell.textContent = Avika.ui.calculateElapsedTime(startTimeStr);
                
                // Añadir clases para estilos basados en tiempo
                var startTime = new Date(startTimeStr);
                var now = new Date();
                var elapsedSecs = Math.floor((now - startTime) / 1000);
                
                // Reiniciar clases
                cell.classList.remove('warning', 'alert');
                
                // Añadir clases según tiempo transcurrido
                if (elapsedSecs > 600) { // Más de 10 minutos
                    cell.classList.add('alert');
                } else if (elapsedSecs > 300) { // Más de 5 minutos
                    cell.classList.add('warning');
                }
            }
        });
    };
    
    // Configurar intervalo para actualizar temporizadores
    setInterval(function() {
        Avika.ui.updateAllTimers();
    }, 1000);
}
// Añadir al final del script anterior
// Implementar showNotification si no existe
if (!Avika.ui.showNotification || typeof Avika.ui.showNotification !== 'function') {
    Avika.ui.showNotification = function(message, duration) {
        console.log("Notificación:", message);
        
        var notification = document.getElementById('notification');
        if (!notification) {
            notification = document.createElement('div');
            notification.id = 'notification';
            notification.style.position = 'fixed';
            notification.style.bottom = '20px';
            notification.style.right = '20px';
            notification.style.backgroundColor = '#2ecc71';
            notification.style.color = 'white';
            notification.style.padding = '12px 20px';
            notification.style.borderRadius = '4px';
            notification.style.boxShadow = '0 2px 10px rgba(0,0,0,0.2)';
            notification.style.zIndex = '9999';
            notification.style.transition = 'opacity 0.3s ease';
            document.body.appendChild(notification);
        }
        
        notification.textContent = message;
        notification.style.display = 'block';
        notification.style.opacity = '1';
        
        if (this.notificationTimeout) {
            clearTimeout(this.notificationTimeout);
        }
        
        this.notificationTimeout = setTimeout(function() {
            notification.style.opacity = '0';
            setTimeout(function() {
                notification.style.display = 'none';
            }, 300);
        }, duration || 3000);
    };
}
<!-- Añadir esto antes del cierre del body si no existe -->
<div id="notification" style="display:none;"></div>

<!-- Asegúrate de que estos elementos existen -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Verificar que existe el elemento pending-body
    if (!document.getElementById('pending-body')) {
        console.error("Elemento pending-body no encontrado. Creando uno temporal.");
        var pendingBody = document.createElement('tbody');
        pendingBody.id = 'pending-body';
        
        // Buscar una tabla donde añadirlo
        var tables = document.querySelectorAll('table');
        if (tables.length > 0) {
            tables[0].appendChild(pendingBody);
        }
    }
    
    // Verificar que existe el elemento pending-count
    if (!document.getElementById('pending-count')) {
        console.error("Elemento pending-count no encontrado. Creando uno temporal.");
        var pendingCount = document.createElement('span');
        pendingCount.id = 'pending-count';
        pendingCount.textContent = '0';
        
        // Buscar un h2 donde añadirlo
        var headers = document.querySelectorAll('h2');
        if (headers.length > 0) {
            headers[0].appendChild(document.createTextNode(' '));
            headers[0].appendChild(pendingCount);
        }
    }
});
</script>
</body>
</html>