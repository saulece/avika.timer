<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avika - Temporizador de Sushi</title>
    <link rel="stylesheet" href="avika-style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link rel="icon" href="data:,">
</head>
<body>
    <header>
        <h1>Avika - Temporizador de Sushi</h1>
        <div class="header-controls">
            <button id="btn-help" class="icon-btn" title="Mostrar ayuda"><i class="fas fa-question-circle"></i></button>
        </div>
    </header>
    
    <div class="container">
        <!-- Notificaciones -->
        <div id="notification"></div>
        
        <!-- Sección de categorías -->
        <div id="categories-section">
            <h2>Selecciona una categoría</h2>
            <div class="category-container">
                <button class="category-btn" data-category="frio" data-tooltip="Platillos fríos como rollos y makis">Platillos Fríos</button>
                <button class="category-btn" data-category="entrada-fria" data-tooltip="Entradas frías como ceviches y sashimis">Entradas Frías</button>
                <button class="category-btn" data-category="caliente" data-tooltip="Platillos calientes y sopas">Platillos Calientes</button>
                <button class="category-btn" data-category="entrada-caliente" data-tooltip="Entradas calientes como empanizados">Entradas Calientes</button>
                <button class="category-btn" data-category="combos" data-tooltip="Combos y promociones especiales">Combos</button>
            </div>
            
            <!-- Órdenes pendientes -->
            <div class="pending-orders-section">
                <h2>Platillos en preparación <span id="pending-count">0</span></h2>
                <div class="action-btns" style="margin-bottom: 10px;">
                    <button class="action-btn" id="btn-new-ticket" data-tooltip="Crear un nuevo ticket con múltiples platillos">Nuevo Ticket/Comanda</button>
                    <button class="action-btn" id="btn-force-complete" style="background-color: #ff9800;" data-tooltip="Solo usar en casos excepcionales cuando un ticket quedó atorado">Emergencia: Desbloquear</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Platillo</th>
                            <th>Inicio</th>
                            <th>Tiempo</th>
                            <th>Detalles</th>
                            <th>Acción</th>
                        </tr>
                    </thead>
                    <tbody id="pending-body">
                        <!-- Se llenará con JavaScript -->
                    </tbody>
                </table>
            </div>
            
            <!-- Órdenes completadas -->
            <div class="pending-orders-section">
                <h2>Platillos completados</h2>
                <div class="filter-controls">
                    <button id="btn-show-all-history" class="filter-btn" data-tooltip="Ver todas las órdenes completadas">Ver historial completo</button>
                    <button id="btn-show-recent" class="filter-btn active" data-tooltip="Ver solo las órdenes más recientes">Ver recientes</button>
                    <button id="btn-show-stats" class="filter-btn" data-tooltip="Ver estadísticas de tiempos promedios">Ver promedios</button>
                    <button id="btn-clear-history" class="filter-btn" data-tooltip="Eliminar historial de órdenes completadas">Limpiar historial</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Platillo</th>
                            <th>Inicio</th>
                            <th>Fin</th>
                            <th>Tiempo total</th>
                            <th>Detalles</th>
                        </tr>
                    </thead>
                    <tbody id="completed-body">
                        <!-- Se llenará con JavaScript -->
                    </tbody>
                </table>
                <button class="back-btn" id="btn-export" data-tooltip="Exportar datos para análisis">Exportar datos</button>
            </div>
        </div>
        
        <!-- Sección de platillos -->
        <div id="dishes-section" style="display: none;">
            <h2 id="selected-category-title">Categoría</h2>
            <div id="dishes-container" class="dishes-container" style="display: block;">
                <!-- Se llenará con JavaScript -->
                <div id="debug-info" style="margin-top: 20px; padding: 10px; background-color: #f9f9f9; border: 1px solid #ddd;">
                    <p>Si no ves los platillos, actualiza la página con Ctrl+F5</p>
                </div>
            </div>
            
            <button class="back-btn" id="btn-back-to-categories">Volver a Categorías</button>
        </div>
        
        <!-- Sección de preparación -->
        <div id="preparation-section" class="preparation-section">
            <h2 id="selected-dish-title">Platillo seleccionado</h2>
            
            <div class="compact-form-container">
                <div class="option-group" id="service-options">
                    <div class="option-title">Tipo de servicio:</div>
                    <div class="option-btns">
                        <button id="btn-comedor" class="option-btn selected">Comedor</button>
                        <button id="btn-domicilio" class="option-btn">Domicilio</button>
                        <button id="btn-para-llevar" class="option-btn">Ordena y Espera</button>
                    </div>
                </div>
                
                <div class="option-group" id="quantity-control">
                    <div class="option-title">Cantidad:</div>
                    <div class="qty-control">
                        <button class="qty-btn">-</button>
                        <span id="quantity-display" class="qty-display">1</span>
                        <button class="qty-btn">+</button>
                    </div>
                </div>
                
                <div class="option-group" id="customization-options">
                    <div class="option-title">Personalizaciones:</div>
                    <div class="option-btns" id="customization-container">
                        <!-- Se llenará dinámicamente -->
                    </div>
                </div>
                
                <div class="option-group">
                    <div class="option-title">Notas adicionales:</div>
                    <textarea id="notes-input" class="notes-input" placeholder="Cualquier instrucción adicional..."></textarea>
                </div>
                
                <div class="action-btns">
                    <button id="btn-cancel" class="action-btn cancel-btn">Cancelar</button>
                    <button id="btn-start" class="action-btn start-btn">Iniciar preparación</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de ayuda -->
    <div id="help-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h2>Guía Rápida de Uso</h2>
            
            <div class="help-section">
                <h3>Flujo de trabajo básico</h3>
                <ol>
                    <li>Selecciona una categoría de platillo</li>
                    <li>Elige el platillo específico</li>
                    <li>Configura personalizaciones, tipo de servicio y cantidad</li>
                    <li>Inicia la preparación</li>
                    <li>Marca como "Listo" cuando el platillo esté terminado</li>
                </ol>
            </div>
            
            <div class="help-section">
                <h3>Trabajar con tickets</h3>
                <ol>
                    <li>Haz clic en "Nuevo Ticket/Comanda"</li>
                    <li>Añade varios platillos al ticket</li>
                    <li>Selecciona el tipo de servicio para todo el ticket</li>
                    <li>Guarda el ticket</li>
                    <li>Marca como "Listo" cada platillo a medida que se completen</li>
                    <li>El ticket se moverá a completados cuando todos los platillos estén listos</li>
                </ol>
            </div>
            
            <div class="help-section">
                <h3>Estados de los platillos</h3>
                <ul>
                    <li><strong>En preparación:</strong> Platillo recién agregado</li>
                    <li><strong>Esperando otros platillos:</strong> Este platillo ya está listo pero otros del mismo ticket aún no</li>
                    <li><strong>Listo para salida:</strong> Para domicilios, indica que está listo para entregar al repartidor</li>
                </ul>
            </div>
        </div>
    </div>
    
    <!-- Cargar módulos en orden correcto -->
    <script src="avika-core.js"></script>
    <script src="js/modules/config.js"></script>
    <script src="js/modules/ui-controller.js"></script>
    <script src="js/modules/order-service.js"></script>
    <script src="js/modules/storage.js"></script>
    <script src="js/modules/stats.js"></script>
    <script src="avika-init.js"></script>
    
    <!-- Script para tooltips y ayuda -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Inicializar modal de ayuda
        var helpModal = document.getElementById('help-modal');
        var helpBtn = document.getElementById('btn-help');
        var closeBtn = helpModal.querySelector('.close-modal');
        
        helpBtn.onclick = function() {
            helpModal.style.display = 'block';
        }
        
        closeBtn.onclick = function() {
            helpModal.style.display = 'none';
        }
        
        // Cerrar modal haciendo clic fuera
        window.onclick = function(event) {
            if (event.target == helpModal) {
                helpModal.style.display = 'none';
            }
        }
        
        // Inicializar tooltips
        document.querySelectorAll('[data-tooltip]').forEach(function(element) {
            element.addEventListener('mouseenter', function() {
                var tooltip = document.createElement('div');
                tooltip.className = 'tooltip';
                tooltip.textContent = this.getAttribute('data-tooltip');
                
                // Posicionar tooltip
                document.body.appendChild(tooltip);
                var rect = this.getBoundingClientRect();
                tooltip.style.left = rect.left + (rect.width / 2) - (tooltip.offsetWidth / 2) + 'px';
                tooltip.style.top = rect.top - tooltip.offsetHeight - 5 + 'px';
                
                // Almacenar referencia al tooltip
                this.tooltip = tooltip;
            });
            
            element.addEventListener('mouseleave', function() {
                if (this.tooltip) {
                    document.body.removeChild(this.tooltip);
                    this.tooltip = null;
                }
            });
        });
    });
    </script>

    <!-- Script de correcciones integrado directamente -->
    <script>
    // Correcciones para Avika
    (function() {
        console.log("Aplicando correcciones para Avika...");
        
        // Esperar a que el DOM esté completamente cargado
        document.addEventListener('DOMContentLoaded', function() {
            // Corregir error de formatTime
            if (Avika && Avika.ui) {
                // Verificar si las tablas están utilizando 'self' en lugar de 'this'
                var originalUpdatePendingTable = Avika.ui.updatePendingTable;
                Avika.ui.updatePendingTable = function() {
                    try {
                        console.log("Ejecutando updatePendingTable corregido");
                        var self = this; // Asegurar que 'self' refiere a 'this'
                        
                        var pendingBody = document.getElementById('pending-body');
                        if (!pendingBody) {
                            console.error("Elemento pending-body no encontrado");
                            return;
                        }
                        
                        // Limpiar tabla
                        pendingBody.innerHTML = '';
                        
                        // Verificar si hay órdenes pendientes
                        if (!Avika.data.pendingOrders || Avika.data.pendingOrders.length === 0) {
                            var row = pendingBody.insertRow();
                            var cell = row.insertCell(0);
                            cell.colSpan = 5;
                            cell.textContent = "No hay platillos en preparación";
                            cell.style.textAlign = "center";
                            cell.style.padding = "20px";
                            
                            // Actualizar contador
                            var pendingCount = document.getElementById('pending-count');
                            if (pendingCount) {
                                pendingCount.textContent = "0";
                            }
                            
                            return;
                        }
                        
                        // El resto de la función se ejecutará sólo si hay errores
                        originalUpdatePendingTable.call(this);
                    } catch (e) {
                        console.error("Error en updatePendingTable:", e);
                        this.showNotification("Error al actualizar tabla: " + e.message);
                        
                        // Mostrar un mensaje de error en la tabla
                        var pendingBody = document.getElementById('pending-body');
                        if (pendingBody) {
                            var row = pendingBody.insertRow();
                            var cell = row.insertCell(0);
                            cell.colSpan = 5;
                            cell.innerHTML = "Error al actualizar tabla.<br>Consulta la consola para más detalles.";
                            cell.style.textAlign = "center";
                            cell.style.padding = "20px";
                            cell.style.color = "red";
                        }
                    }
                };
                
                // Corregir la función formatTime que está causando el error
                console.log("Verificando función formatTime");
                if (!Avika.ui.formatTime) {
                    Avika.ui.formatTime = function(date) {
                        if (!date) return '--:--:--';
                        
                        var hours = this.padZero(date.getHours());
                        var minutes = this.padZero(date.getMinutes());
                        var seconds = this.padZero(date.getSeconds());
                        return hours + ':' + minutes + ':' + seconds;
                    };
                }
                
                // Corregir la función addOrderRow
                Avika.ui.addOrderRow = function(tbody, order, index) {
                    var row = tbody.insertRow();
                    
                    // Platillo
                    var dishCell = row.insertCell(0);
                    dishCell.textContent = order.dish + (order.quantity > 1 ? ' (' + order.quantity + ')' : '');
                    
                    // Hora de inicio
                    var startCell = row.insertCell(1);
                    startCell.textContent = Avika.ui.formatTime(new Date(order.startTime));
                    
                    // Temporizador
                    var timerCell = row.insertCell(2);
                    timerCell.className = 'timer-cell';
                    timerCell.setAttribute('data-start-time', order.startTime);
                    timerCell.textContent = Avika.ui.calculateElapsedTime(order.startTime);
                    
                    // Detalles
                    var detailsCell = row.insertCell(3);
                    
                    // Servicio
                    var serviceText = '';
                    switch (order.service) {
                        case 'comedor': serviceText = 'Comedor'; break;
                        case 'domicilio': serviceText = 'Domicilio'; break;
                        case 'para-llevar': serviceText = 'Ordena y espera'; break;
                        default: serviceText = order.service;
                    }
                    
                    // Personalización
                    var customText = '';
                    if (order.customizations && order.customizations.length > 0) {
                        order.customizations.forEach(function(code) {
                            if (Avika.config.customizationOptions[code]) {
                                customText += Avika.config.customizationOptions[code] + ', ';
                            }
                        });
                        customText = customText.slice(0, -2); // Eliminar última coma y espacio
                    }
                    
                    // Notas
                    var notesText = order.notes ? '<br>Nota: ' + order.notes : '';
                    
                    // Combinar toda la información
                    detailsCell.innerHTML = '<strong>' + serviceText + '</strong>' + 
                                            (customText ? '<br>' + customText : '') + 
                                            notesText;
                    
                    // Acciones
                    var actionsCell = row.insertCell(4);
                    
                    // Botón para marcar como completado
                    var completeBtn = document.createElement('button');
                    completeBtn.textContent = 'Listo';
                    completeBtn.className = 'action-btn';
                    
                    var self = Avika.ui; // Usar directamente Avika.ui en lugar de 'this'
                    completeBtn.onclick = function() {
                        self.completeOrder(index);
                    };
                    
                    actionsCell.appendChild(completeBtn);
                };
                
                // Corregir función enableTicketMode
                var originalEnableTicketMode = Avika.ui.enableTicketMode;
                Avika.ui.enableTicketMode = function() {
                    try {
                        console.log("Activando modo ticket corregido");
                        
                        // Cambiar estado de la UI
                        this.state.ticketMode = true;
                        this.state.ticketItems = [];
                        
                        // Crear modal para ticket
                        var ticketModal = document.getElementById('ticket-modal');
                        if (!ticketModal) {
                            console.log("Creando modal para ticket");
                            
                            ticketModal = document.createElement('div');
                            ticketModal.id = 'ticket-modal';
                            ticketModal.className = 'modal';
                            ticketModal.style.display = 'none';
                            
                            var modalContent = document.createElement('div');
                            modalContent.className = 'modal-content';
                            
                            // Botón para cerrar
                            var closeBtn = document.createElement('span');
                            closeBtn.className = 'close-modal';
                            closeBtn.innerHTML = '&times;';
                            closeBtn.onclick = function() {
                                ticketModal.style.display = 'none';
                                Avika.ui.state.ticketMode = false;
                            };
                            
                            // Título
                            var title = document.createElement('h2');
                            title.textContent = 'Nuevo Ticket / Comanda';
                            
                            // Contenedor para productos añadidos
                            var itemsContainer = document.createElement('div');
                            itemsContainer.id = 'ticket-items';
                            itemsContainer.className = 'ticket-items';
                            
                            // Tabla de platillos añadidos
                            var table = document.createElement('table');
                            table.className = 'ticket-table';
                            
                            var thead = document.createElement('thead');
                            thead.innerHTML = '<tr><th>Cant.</th><th>Platillo</th><th>Personalización</th><th>Acciones</th></tr>';
                            
                            var tbody = document.createElement('tbody');
                            tbody.id = 'ticket-items-body';
                            
                            table.appendChild(thead);
                            table.appendChild(tbody);
                            itemsContainer.appendChild(table);
                            
                            // Opciones de servicio para ticket
                            var serviceOptions = document.createElement('div');
                            serviceOptions.className = 'option-group';
                            serviceOptions.innerHTML = `
                                <div class="option-title">Tipo de servicio para todo el ticket:</div>
                                <div class="option-btns">
                                    <button id="ticket-btn-comedor" class="option-btn selected">Comedor</button>
                                    <button id="ticket-btn-domicilio" class="option-btn">Domicilio</button>
                                    <button id="ticket-btn-para-llevar" class="option-btn">Ordena y espera</button>
                                </div>
                            `;
                            
                            // Notas para todo el ticket
                            var notesGroup = document.createElement('div');
                            notesGroup.className = 'option-group';
                            notesGroup.innerHTML = `
                                <div class="option-title">Notas generales para el ticket:</div>
                                <textarea id="ticket-notes" class="notes-input" placeholder="Notas generales que aplican a todo el ticket..."></textarea>
                            `;
                            
                            // Botones de acción
                            var actionBtns = document.createElement('div');
                            actionBtns.className = 'action-btns';
                            actionBtns.innerHTML = `
                                <button id="btn-add-to-ticket" class="action-btn">Agregar platillo</button>
                                <button id="btn-save-ticket" class="action-btn start-btn">Guardar ticket</button>
                            `;
                            
                            // Añadir elementos al modal
                            modalContent.appendChild(closeBtn);
                            modalContent.appendChild(title);
                            modalContent.appendChild(itemsContainer);
                            modalContent.appendChild(serviceOptions);
                            modalContent.appendChild(notesGroup);
                            modalContent.appendChild(actionBtns);
                            
                            ticketModal.appendChild(modalContent);
                            document.body.appendChild(ticketModal);
                            
                            console.log("Modal de ticket creado correctamente");
                        }
                        
                        // Asegurarse de que los botones tengan los eventos correctos
                        console.log("Asignando eventos a los botones del ticket modal");
                        
                        // Botones de servicio
                        var btnComedor = document.getElementById('ticket-btn-comedor');
                        if (btnComedor) {
                            btnComedor.onclick = function() {
                                Avika.ui.selectTicketService(this, 'comedor');
                            };
                        }
                        
                        var btnDomicilio = document.getElementById('ticket-btn-domicilio');
                        if (btnDomicilio) {
                            btnDomicilio.onclick = function() {
                                Avika.ui.selectTicketService(this, 'domicilio');
                            };
                        }
                        
                        var btnParaLlevar = document.getElementById('ticket-btn-para-llevar');
                        if (btnParaLlevar) {
                            btnParaLlevar.onclick = function() {
                                Avika.ui.selectTicketService(this, 'para-llevar');
                            };
                        }
                        
                        // Botón para agregar platillos
                        var btnAddToTicket = document.getElementById('btn-add-to-ticket');
                        if (btnAddToTicket) {
                            btnAddToTicket.onclick = function() {
                                ticketModal.style.display = 'none';
                                Avika.ui.showSection('categories-section');
                            };
                        }
                        
                        // Botón para guardar ticket
                        var btnSaveTicket = document.getElementById('btn-save-ticket');
                        if (btnSaveTicket) {
                            btnSaveTicket.onclick = function() {
                                Avika.ui.saveTicket();
                            };
                        }
                        
                        // Limpiar tabla de items
                        var ticketItemsBody = document.getElementById('ticket-items-body');
                        if (ticketItemsBody) {
                            ticketItemsBody.innerHTML = '';
                        }
                        
                        // Resetear servicio del ticket
                        this.state.ticketService = 'comedor';
                        
                        if (btnComedor) btnComedor.classList.add('selected');
                        if (btnDomicilio) btnDomicilio.classList.remove('selected');
                        if (btnParaLlevar) btnParaLlevar.classList.remove('selected');
                        
                        // Limpiar notas
                        var ticketNotes = document.getElementById('ticket-notes');
                        if (ticketNotes) ticketNotes.value = '';
                        
                        // Mostrar modal
                        console.log("Mostrando modal de ticket");
                        ticketModal.style.display = 'block';
                        
                    } catch (e) {
                        console.error("Error al activar modo ticket:", e);
                        Avika.ui.showErrorMessage("Error al activar modo ticket: " + e.message);
                    }
                };
                
                // Volver a asignar eventos a los botones de categoría
                var categoryButtons = document.querySelectorAll('.category-btn[data-category]');
                categoryButtons.forEach(function(btn) {
                    // Crear una copia del botón para limpiar eventos previos
                    var btnClone = btn.cloneNode(true);
                    if (btn.parentNode) {
                        btn.parentNode.replaceChild(btnClone, btn);
                    }
                    
                    // Asignar nuevo evento
                    var category = btnClone.getAttribute('data-category');
                    btnClone.addEventListener('click', function() {
                        console.log("Clic en categoría:", category);
                        Avika.ui.selectCategory(category);
                    });
                });
                
                // Corregir botón de nuevo ticket
                var newTicketBtn = document.getElementById('btn-new-ticket');
                if (newTicketBtn) {
                    // Crear una copia del botón para limpiar eventos previos
                    var btnClone = newTicketBtn.cloneNode(true);
                    if (newTicketBtn.parentNode) {
                        newTicketBtn.parentNode.replaceChild(btnClone, newTicketBtn);
                    }
                    
                    // Asignar nuevo evento
                    btnClone.addEventListener('click', function() {
                        console.log("Clic en botón Nuevo Ticket");
                        Avika.ui.enableTicketMode();
                    });
                }
            }
            
            console.log("Correcciones aplicadas correctamente");
        });
    })();
    </script>
</body>
</html>