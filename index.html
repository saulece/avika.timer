<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avika - Temporizador de Sushi</title>
    <link rel="stylesheet" href="avika-style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link rel="icon" href="data:,">
</head>
<body>
    <header>
        <h1>Avika - Temporizador de Sushi</h1>
        <div class="header-controls">
            <button id="btn-help" class="icon-btn" title="Mostrar ayuda"><i class="fas fa-question-circle"></i></button>
        </div>
    </header>
    
    <div class="container">
        <!-- Notificaciones -->
<div id="notification" style="display:none;"></div>
        
        <!-- Sección de categorías -->
        <div id="categories-section">
            <h2>Selecciona una categoría</h2>
            <div class="category-container">
                <button class="category-btn" data-category="frio" data-tooltip="Platillos fríos como rollos y makis">Platillos Fríos</button>
                <button class="category-btn" data-category="entrada-fria" data-tooltip="Entradas frías como ceviches y sashimis">Entradas Frías</button>
                <button class="category-btn" data-category="caliente" data-tooltip="Platillos calientes y sopas">Platillos Calientes</button>
                <button class="category-btn" data-category="entrada-caliente" data-tooltip="Entradas calientes como empanizados">Entradas Calientes</button>
                <button class="category-btn" data-category="combos" data-tooltip="Combos y promociones especiales">Combos</button>
            </div>
            
            <!-- Órdenes pendientes -->
            <div class="pending-orders-section">
                <h2>Platillos en preparación <span id="pending-count">0</span></h2>
                <div class="action-btns" style="margin-bottom: 10px;">
                    <button class="action-btn" id="btn-new-ticket" data-tooltip="Crear un nuevo ticket con múltiples platillos">Nuevo Ticket/Comanda</button>
                    <button class="action-btn" id="btn-force-complete" style="background-color: #ff9800;" data-tooltip="Solo usar en casos excepcionales cuando un ticket quedó atorado">Emergencia: Desbloquear</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Platillo</th>
                            <th>Inicio</th>
                            <th>Tiempo</th>
                            <th>Detalles</th>
                            <th>Acción</th>
                        </tr>
                    </thead>
                    <tbody id="pending-body">
                        <!-- Se llenará con JavaScript -->
                    </tbody>
                </table>
            </div>
            
            <!-- Órdenes completadas -->
            <div class="pending-orders-section">
                <h2>Platillos completados</h2>
                <div class="filter-controls">
                    <button id="btn-show-all-history" class="filter-btn" data-tooltip="Ver todas las órdenes completadas">Ver historial completo</button>
                    <button id="btn-show-recent" class="filter-btn active" data-tooltip="Ver solo las órdenes más recientes">Ver recientes</button>
                    <button id="btn-show-stats" class="filter-btn" data-tooltip="Ver estadísticas de tiempos promedios">Ver promedios</button>
                    <button id="btn-clear-history" class="filter-btn" data-tooltip="Eliminar historial de órdenes completadas">Limpiar historial</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Platillo</th>
                            <th>Inicio</th>
                            <th>Fin</th>
                            <th>Tiempo total</th>
                            <th>Detalles</th>
                        </tr>
                    </thead>
                    <tbody id="completed-body">
                        <!-- Se llenará con JavaScript -->
                    </tbody>
                </table>
                <button class="back-btn" id="btn-export" data-tooltip="Exportar datos para análisis">Exportar datos</button>
            </div>
        </div>
        
        <!-- Sección de platillos -->
        <div id="dishes-section" style="display: none;">
            <h2 id="selected-category-title">Categoría</h2>
            <div id="dishes-container" class="dishes-container" style="display: block;">
                <!-- Se llenará con JavaScript -->
                <div id="debug-info" style="margin-top: 20px; padding: 10px; background-color: #f9f9f9; border: 1px solid #ddd;">
                    <p>Si no ves los platillos, actualiza la página con Ctrl+F5</p>
                </div>
            </div>
            
            <button class="back-btn" id="btn-back-to-categories">Volver a Categorías</button>
        </div>
        
        <!-- Sección de preparación -->
        <div id="preparation-section" class="preparation-section">
            <h2 id="selected-dish-title">Platillo seleccionado</h2>
            
            <div class="compact-form-container">
                <div class="option-group" id="service-options">
                    <div class="option-title">Tipo de servicio:</div>
                    <div class="option-btns">
                        <button id="btn-comedor" class="option-btn selected">Comedor</button>
                        <button id="btn-domicilio" class="option-btn">Domicilio</button>
                        <button id="btn-para-llevar" class="option-btn">Ordena y Espera</button>
                    </div>
                </div>
                
                <div class="option-group" id="quantity-control">
                    <div class="option-title">Cantidad:</div>
                    <div class="qty-control">
                        <button class="qty-btn">-</button>
                        <span id="quantity-display" class="qty-display">1</span>
                        <button class="qty-btn">+</button>
                    </div>
                </div>
                
                <div class="option-group" id="customization-options">
                    <div class="option-title">Personalizaciones:</div>
                    <div class="option-btns" id="customization-container">
                        <!-- Se llenará dinámicamente -->
                    </div>
                </div>
                
                <div class="option-group">
                    <div class="option-title">Notas adicionales:</div>
                    <textarea id="notes-input" class="notes-input" placeholder="Cualquier instrucción adicional..."></textarea>
                </div>
                
                <div class="action-btns">
                    <button id="btn-cancel" class="action-btn cancel-btn">Cancelar</button>
                    <button id="btn-start" class="action-btn start-btn">Iniciar preparación</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de ayuda -->
    <div id="help-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h2>Guía Rápida de Uso</h2>
            
            <div class="help-section">
                <h3>Flujo de trabajo básico</h3>
                <ol>
                    <li>Selecciona una categoría de platillo</li>
                    <li>Elige el platillo específico</li>
                    <li>Configura personalizaciones, tipo de servicio y cantidad</li>
                    <li>Inicia la preparación</li>
                    <li>Marca como "Listo" cuando el platillo esté terminado</li>
                </ol>
            </div>
            
            <div class="help-section">
                <h3>Trabajar con tickets</h3>
                <ol>
                    <li>Haz clic en "Nuevo Ticket/Comanda"</li>
                    <li>Añade varios platillos al ticket</li>
                    <li>Selecciona el tipo de servicio para todo el ticket</li>
                    <li>Guarda el ticket</li>
                    <li>Marca como "Listo" cada platillo a medida que se completen</li>
                    <li>El ticket se moverá a completados cuando todos los platillos estén listos</li>
                </ol>
            </div>
            
            <div class="help-section">
                <h3>Estados de los platillos</h3>
                <ul>
                    <li><strong>En preparación:</strong> Platillo recién agregado</li>
                    <li><strong>Esperando otros platillos:</strong> Este platillo ya está listo pero otros del mismo ticket aún no</li>
                    <li><strong>Listo para salida:</strong> Para domicilios, indica que está listo para entregar al repartidor</li>
                </ul>
            </div>
        </div>
    </div>
    
    <!-- Cargar módulos en orden correcto -->
    <script src="avika-core.js"></script>
    <script src="js/modules/config.js"></script>
    <script src="js/modules/ui-controller.js"></script>
    <script src="js/modules/order-service.js"></script>
    <script src="js/modules/storage.js"></script>
    <script src="js/modules/stats.js"></script>
    <script src="avika-init.js"></script>
    
    <!-- Script para tooltips y ayuda -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Inicializar modal de ayuda
        var helpModal = document.getElementById('help-modal');
        var helpBtn = document.getElementById('btn-help');
        var closeBtn = helpModal.querySelector('.close-modal');
        
        helpBtn.onclick = function() {
            helpModal.style.display = 'block';
        }
        
        closeBtn.onclick = function() {
            helpModal.style.display = 'none';
        }
        
        // Cerrar modal haciendo clic fuera
        window.onclick = function(event) {
            if (event.target == helpModal) {
                helpModal.style.display = 'none';
            }
        }
        
        // Inicializar tooltips
        document.querySelectorAll('[data-tooltip]').forEach(function(element) {
            element.addEventListener('mouseenter', function() {
                var tooltip = document.createElement('div');
                tooltip.className = 'tooltip';
                tooltip.textContent = this.getAttribute('data-tooltip');
                
                // Posicionar tooltip
                document.body.appendChild(tooltip);
                var rect = this.getBoundingClientRect();
                tooltip.style.left = rect.left + (rect.width / 2) - (tooltip.offsetWidth / 2) + 'px';
                tooltip.style.top = rect.top - tooltip.offsetHeight - 5 + 'px';
                
                // Almacenar referencia al tooltip
                this.tooltip = tooltip;
            });
            
            element.addEventListener('mouseleave', function() {
                if (this.tooltip) {
                    document.body.removeChild(this.tooltip);
                    this.tooltip = null;
                }
            });
        });
    });
    </script>

    <!-- Unificación de la solución de inicialización -->
    <script>
    (function() {
        console.log("Aplicando inicialización unificada para Avika...");
        
        document.addEventListener('DOMContentLoaded', function() {
            // PARTE 1: ASEGURAR FUNCIONES CENTRALES DE FECHA
            
            // Función única y centralizada para formatear fechas
            window.AvikaDateManager = {
                // Método para formatear números con ceros
                padZero: function(num) {
                    if (typeof num !== 'number') {
                        console.warn("padZero recibió un valor no numérico:", num);
                        num = parseInt(num) || 0;
                    }
                return (num < 10 ? '0' : '') + num;
                },
            
                // Método para formatear tiempo (HH:MM:SS)
                formatTime: function(date) {
                if (!date) return '--:--:--';
                
                try {
                        // Convertir a objeto Date si es string
                    var d = date instanceof Date ? date : new Date(date);
                    
                        // Verificar que la fecha sea válida
                    if (isNaN(d.getTime())) {
                            console.warn("Fecha inválida en formatTime:", date);
                        return '--:--:--';
                    }
                    
                        return this.padZero(d.getHours()) + ':' + 
                               this.padZero(d.getMinutes()) + ':' + 
                               this.padZero(d.getSeconds());
                } catch (e) {
                    console.error("Error en formatTime:", e);
                    return '--:--:--';
                }
                },
                
                // Método para calcular tiempo transcurrido
                calculateElapsedTime: function(startTimeStr) {
                    try {
                        var startTime = startTimeStr instanceof Date ? startTimeStr : new Date(startTimeStr);
                        
                        // Verificar fecha válida
                        if (isNaN(startTime.getTime())) {
                            console.warn("Fecha de inicio inválida en calculateElapsedTime:", startTimeStr);
                            return '--:--';
                        }
                        
                    var now = new Date();
                    var elapsed = Math.floor((now - startTime) / 1000); // en segundos
                    
                    var hours = Math.floor(elapsed / 3600);
                    var minutes = Math.floor((elapsed % 3600) / 60);
                    var seconds = elapsed % 60;
                    
                    var timeStr = '';
                    
                    if (hours > 0) {
                        timeStr += hours + 'h ';
                    }
                    
                        timeStr += this.padZero(minutes) + ':' + this.padZero(seconds);
                    
                    return timeStr;
                } catch (e) {
                    console.error("Error al calcular tiempo transcurrido:", e);
                    return "--:--";
                    }
                },
                
                // Método para serializar fechas de forma segura
                serializeDate: function(date) {
                    if (!date) return null;
                    
                    try {
                        var d = date instanceof Date ? date : new Date(date);
                        
                        if (isNaN(d.getTime())) {
                            console.warn("Fecha inválida en serializeDate:", date);
                            return null;
                        }
                        
                        return d.toISOString();
                    } catch (e) {
                        console.error("Error al serializar fecha:", e);
                        return null;
                    }
                },
                
                // Método para deserializar fechas de forma segura
                deserializeDate: function(dateString) {
                    if (!dateString) return null;
                    
                    try {
                        var d = new Date(dateString);
                        
                        if (isNaN(d.getTime())) {
                            console.warn("String de fecha inválida en deserializeDate:", dateString);
                            return null;
                        }
                        
                        return d;
                    } catch (e) {
                        console.error("Error al deserializar fecha:", e);
                        return null;
                    }
                }
            };
            
            // PARTE 2: ESTABLECER REFERENCIAS UNIFICADAS
            
            // Asignar funciones de fecha al objeto global Avika
            if (!window.Avika) window.Avika = {};
            if (!Avika.ui) Avika.ui = {};
            if (!Avika.data) {
                Avika.data = {
                    currentCategory: '',
                    currentDish: '',
                    currentCustomizations: [],
                    currentService: 'comedor',
                    currentQuantity: 1,
                    isSpecialCombo: false,
                    pendingOrders: [],
                    completedOrders: [],
                    timerInterval: null
                };
            }
            
            // Establecer referencias desde todos los lugares donde se usan
            Avika.ui.padZero = window.AvikaDateManager.padZero.bind(window.AvikaDateManager);
            Avika.ui.formatTime = window.AvikaDateManager.formatTime.bind(window.AvikaDateManager);
            Avika.ui.calculateElapsedTime = window.AvikaDateManager.calculateElapsedTime.bind(window.AvikaDateManager);
            
            // Referencias globales para compatibilidad con código existente
            window.padZero = Avika.ui.padZero;
            window.formatTime = Avika.ui.formatTime;
            window.calculateElapsedTime = Avika.ui.calculateElapsedTime;
            
            // Referencias en el objeto Avika para compatibilidad
            Avika.padZero = Avika.ui.padZero;
            Avika.formatTime = Avika.ui.formatTime;
            Avika.calculateElapsedTime = Avika.ui.calculateElapsedTime;
            
            // PARTE 3: UNIFICAR NOTIFICACIONES
            
            // Función unificada de notificación
            Avika.ui.showNotification = function(message, duration) {
                try {
                console.log("Notificación:", message);
                
                var notification = document.getElementById('notification');
                if (!notification) {
                    notification = document.createElement('div');
                    notification.id = 'notification';
                    notification.style.position = 'fixed';
                    notification.style.bottom = '20px';
                    notification.style.right = '20px';
                    notification.style.backgroundColor = '#2ecc71';
                    notification.style.color = 'white';
                    notification.style.padding = '12px 20px';
                    notification.style.borderRadius = '4px';
                    notification.style.boxShadow = '0 2px 10px rgba(0,0,0,0.2)';
                    notification.style.zIndex = '9999';
                    notification.style.transition = 'opacity 0.3s ease';
                    document.body.appendChild(notification);
                }
                
                notification.textContent = message;
                notification.style.display = 'block';
                notification.style.opacity = '1';
                
                if (Avika.ui.notificationTimeout) {
                    clearTimeout(Avika.ui.notificationTimeout);
                }
                
                Avika.ui.notificationTimeout = setTimeout(function() {
                    notification.style.opacity = '0';
                    setTimeout(function() {
                        notification.style.display = 'none';
                    }, 300);
                }, duration || 3000);
                } catch (e) {
                    console.error("Error al mostrar notificación:", e);
                }
            };
            
            // Función unificada de error
            Avika.ui.showErrorMessage = function(message) {
                try {
                console.error("Error:", message);
                
                var errorContainer = document.getElementById('error-message');
                if (!errorContainer) {
                    errorContainer = document.createElement('div');
                    errorContainer.id = 'error-message';
                    errorContainer.style.position = 'fixed';
                    errorContainer.style.top = '50%';
                    errorContainer.style.left = '50%';
                    errorContainer.style.transform = 'translate(-50%, -50%)';
                    errorContainer.style.backgroundColor = '#e74c3c';
                    errorContainer.style.color = 'white';
                    errorContainer.style.padding = '15px 20px';
                    errorContainer.style.borderRadius = '5px';
                    errorContainer.style.boxShadow = '0 4px 8px rgba(0,0,0,0.2)';
                    errorContainer.style.zIndex = '9999';
                    errorContainer.style.maxWidth = '80%';
                    errorContainer.style.textAlign = 'center';
                    document.body.appendChild(errorContainer);
                }
                
                errorContainer.innerHTML = '<span id="close-error" style="position:absolute;right:10px;top:10px;cursor:pointer;font-weight:bold;">&times;</span>' +
                                       '<p style="margin:0;">' + message + '</p>';
                
                errorContainer.style.display = 'block';
                
                var closeBtn = document.getElementById('close-error');
                if (closeBtn) {
                    closeBtn.onclick = function() {
                        errorContainer.style.display = 'none';
                    };
                }
                
                setTimeout(function() {
                    if (errorContainer.style.display !== 'none') {
                        errorContainer.style.display = 'none';
                    }
                }, 10000);
                } catch (e) {
                    console.error("Error al mostrar mensaje de error:", e);
                    alert("Error: " + message);
                }
            };
            
            // PARTE 4: INICIALIZACIÓN SEGURA
            
            // Verificar si los módulos necesarios están cargados
            function checkModulesLoaded() {
                var requiredObjects = [
                    { name: 'Avika.config', obj: Avika.config },
                    { name: 'Avika.ui', obj: Avika.ui },
                    { name: 'Avika.orders', obj: Avika.orders },
                    { name: 'Avika.storage', obj: Avika.storage },
                    { name: 'Avika.stats', obj: Avika.stats }
                ];
                
                var missingModules = [];
                
                requiredObjects.forEach(function(item) {
                    if (!item.obj) {
                        missingModules.push(item.name);
                    }
                });
                
                if (missingModules.length > 0) {
                    console.error("Faltan módulos requeridos:", missingModules.join(', '));
                    return false;
                }
                
                    return true;
            }
            
            // Iniciar una sola vez
            if (!window.avikaInitialized) {
                if (checkModulesLoaded()) {
                    console.log("Todos los módulos cargados, iniciando aplicación...");
                    
                    // Si existe la función modernizada en el controller UI, usarla
                    if (Avika.ui && typeof Avika.ui.initEvents === 'function') {
                        Avika.ui.initEvents();
                            } else {
                        console.warn("Usando inicialización de respaldo");
                        // Inicialización de botones de categoría
                        document.querySelectorAll('.category-btn').forEach(function(btn) {
                            btn.addEventListener('click', function() {
                                var category = this.getAttribute('data-category');
                                if (Avika.ui && typeof Avika.ui.selectCategory === 'function') {
                                    Avika.ui.selectCategory(category);
                                }
                            });
                        });
            
            // Inicializar temporizadores
                    if (Avika.data.timerInterval) {
                        clearInterval(Avika.data.timerInterval);
                    }
                    
                    Avika.data.timerInterval = setInterval(function() {
                            if (Avika.ui && typeof Avika.ui.updateAllTimers === 'function') {
                        Avika.ui.updateAllTimers();
                            }
                    }, 1000);
                    
                        // Cargar datos guardados
                        if (Avika.storage && typeof Avika.storage.cargarDatosGuardados === 'function') {
                            Avika.storage.cargarDatosGuardados();
                        }
                        
                        // Actualizar tablas
                        if (Avika.ui && typeof Avika.ui.updatePendingTable === 'function') {
                            Avika.ui.updatePendingTable();
                        }
                        
                        if (Avika.ui && typeof Avika.ui.updateCompletedTable === 'function') {
                                Avika.ui.updateCompletedTable(false);
                            }
                    }
                    
                    // Marcar como inicializada
                    window.avikaInitialized = true;
                    console.log("Avika inicializado correctamente");
                    
                    // Mostrar notificación de inicialización
                    if (Avika.ui && typeof Avika.ui.showNotification === 'function') {
                        Avika.ui.showNotification("Aplicación cargada correctamente", 2000);
                    }
                                } else {
                    console.error("No se puede inicializar Avika: faltan módulos");
                    var errorMsg = "Error: No se pueden cargar todos los módulos necesarios. Intenta recargar la página.";
                    if (Avika.ui && typeof Avika.ui.showErrorMessage === 'function') {
                        Avika.ui.showErrorMessage(errorMsg);
                            } else {
                        alert(errorMsg);
                    }
                }
                    } else {
                console.log("Avika ya fue inicializado previamente");
            }
        });
    })();
    </script>
    <script src="fix-update-table.js"></script>
    <script src="fix-update-table.js"></script>
<script src="fix-timeselect.js"></script>
</body>
</html>