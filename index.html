<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Avika - Temporizador</title>
    <style>
        /* Estilos base optimizados para iPhone */
        :root {
            --bg-color: #f0f0f0;
            --container-bg: #ffffff;
            --text-color: #333333;
            --header-bg: #e74c3c;
            --header-text: white;
            --primary-btn: #3498db;
            --primary-btn-text: white;
            --success-btn: #2ecc71;
            --danger-btn: #e74c3c;
            --warning-btn: #f0ad4e;
            --info-btn: #5bc0de;
            --border-color: #ddd;
            --table-header-bg: #3498db;
            --table-header-text: white;
            --notification-bg: #2ecc71;
            --highlight-bg: #f9f9f9;
            --shadow-color: rgba(0,0,0,0.1);
            --btn-hover: #2980b9;
            
            /* Variables para tiempos */
            --time-excellent: #2ecc71;
            --time-good: #7fdbff;
            --time-warning: #f39c12;
            --time-bad: #e74c3c;
            
            /* Transiciones */
            --transition-speed: 0.3s;
            
            /* Fuentes */
            --font-main: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            --font-monospace: 'Menlo', monospace;
        }

        .dark-mode {
            --bg-color: #121212;
            --container-bg: #1e1e1e;
            --text-color: #e0e0e0;
            --header-bg: #c0392b;
            --header-text: #f0f0f0;
            --primary-btn: #2980b9;
            --primary-btn-text: #f0f0f0;
            --success-btn: #27ae60;
            --danger-btn: #c0392b;
            --warning-btn: #d35400;
            --info-btn: #2980b9;
            --border-color: #444;
            --table-header-bg: #2980b9;
            --table-header-text: #f0f0f0;
            --notification-bg: #27ae60;
            --highlight-bg: #2a2a2a;
            --shadow-color: rgba(0,0,0,0.3);
            --btn-hover: #3498db;
            
            /* Colores de tiempos en modo oscuro */
            --time-excellent: #27ae60;
            --time-good: #2980b9;
            --time-warning: #d35400;
            --time-bad: #c0392b;
        }

        /* Estilos generales */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: var(--font-main);
            margin: 0;
            padding: 15px;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color var(--transition-speed), color var(--transition-speed);
            line-height: 1.6;
            -webkit-user-select: none;
            user-select: none;
            overscroll-behavior: none;
            -webkit-overflow-scrolling: touch;
            touch-action: manipulation;
        }

        /* Encabezado */
        header {
            background-color: var(--header-bg);
            color: var(--header-text);
            padding: 15px;
            text-align: center;
            margin-bottom: 20px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px var(--shadow-color);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        header h1 {
            margin: 0;
            flex: 1;
            font-size: 1.5rem;
        }

        .header-controls {
            display: flex;
            gap: 10px;
        }

        .icon-btn {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--header-text);
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: background-color var(--transition-speed);
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: manipulation;
        }

        .icon-btn:active {
            background-color: rgba(255, 255, 255, 0.2);
        }

        /* Contenedor principal */
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding-bottom: 80px; /* Para evitar que el último elemento quede oculto detrás del dock de iOS */
        }

        /* Secciones */
        section {
            background-color: var(--container-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px var(--shadow-color);
            margin-bottom: 20px;
            transition: background-color var(--transition-speed);
        }

        /* Contenedor de categorías */
        .category-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .category-btn {
            background-color: var(--primary-btn);
            color: var(--primary-btn-text);
            border: none;
            padding: 15px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            height: 70px;
            transition: background-color var(--transition-speed), transform 0.2s;
            box-shadow: 0 2px 4px var(--shadow-color);
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: manipulation;
        }

        .category-btn:active {
            background-color: var(--btn-hover);
            transform: scale(0.98);
        }

        /* Sección de platillos */
        .dishes-section {
            display: none;
        }

        .dishes-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .dish-btn {
            background-color: var(--container-bg);
            color: var(--text-color);
            border: 1px solid var(--primary-btn);
            padding: 12px 10px;
            font-size: 14px;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: background-color var(--transition-speed), 
                        color var(--transition-speed), 
                        transform 0.2s;
            height: 60px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            touch-action: manipulation;
            position: relative;
        }

        .dish-btn:active {
            background-color: var(--primary-btn);
            color: var(--primary-btn-text);
            transform: scale(0.98);
        }

        .dish-btn.special-combo {
            border: 2px solid var(--danger-btn);
            position: relative;
        }

        .dish-btn.special-combo::after {
            content: "★";
            position: absolute;
            top: 5px;
            right: 5px;
            color: var(--danger-btn);
            font-size: 14px;
        }

        /* Sección de preparación */
        .preparation-section {
            display: none;
            background-color: var(--container-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 3px 10px var(--shadow-color);
            margin-top: 20px;
        }

        .option-group {
            margin-bottom: 20px;
        }

        .option-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--text-color);
            font-size: 1.1rem;
        }

        .option-btns {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .option-btn {
            background-color: var(--highlight-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color var(--transition-speed), color var(--transition-speed);
            font-size: 14px;
            flex: 1;
            min-width: 100px;
            text-align: center;
            touch-action: manipulation;
        }

        .option-btn.selected {
            background-color: var(--primary-btn);
            color: var(--primary-btn-text);
            border-color: var(--primary-btn);
        }

        /* Control de cantidad */
        .qty-control {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .qty-btn {
            background-color: var(--primary-btn);
            color: var(--primary-btn-text);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color var(--transition-speed);
            touch-action: manipulation;
        }

        .qty-btn:active {
            background-color: var(--btn-hover);
        }

        .qty-display {
            font-size: 20px;
            font-weight: bold;
            min-width: 40px;
            text-align: center;
            color: var(--text-color);
        }

        /* Área de notas */
        .notes-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background-color: var(--container-bg);
            color: var(--text-color);
            resize: vertical;
            min-height: 80px;
            font-family: var(--font-main);
            transition: border-color var(--transition-speed);
            font-size: 16px; /* Evita el zoom automático en iOS */
        }

        .notes-input:focus {
            outline: none;
            border-color: var(--primary-btn);
        }

        /* Botones de acción */
        .action-btns {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }

        .action-btn {
            flex: 1;
            padding: 14px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color var(--transition-speed), 
                        transform 0.2s,
                        box-shadow 0.2s;
            box-shadow: 0 2px 4px var(--shadow-color);
            touch-action: manipulation;
        }

        .action-btn:active {
            transform: scale(0.98);
            box-shadow: 0 1px 2px var(--shadow-color);
        }

        .cancel-btn {
            background-color: var(--danger-btn);
            color: white;
        }

        .start-btn {
            background-color: var(--success-btn);
            color: white;
        }

        .back-btn {
            background-color: var(--warning-btn);
            color: white;
            padding: 12px 18px;
            margin: 15px 0;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color var(--transition-speed), transform 0.2s;
            box-shadow: 0 2px 4px var(--shadow-color);
            touch-action: manipulation;
        }

        .back-btn:active {
            transform: scale(0.98);
        }

        /* Tablas */
        .pending-orders-section {
            margin-top: 30px;
            background-color: var(--container-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px var(--shadow-color);
        }

        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .timer-cell {
            font-weight: bold;
            color: var(--text-color);
            font-size: 16px;
            font-family: var(--font-monospace);
        }

        .timer-cell.warning {
            color: var(--time-warning);
        }

        .timer-cell.alert {
            color: var(--time-bad);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }

        .finish-btn {
            background-color: var(--success-btn);
            color: white;
            border: none;
            padding: 10px 8px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
            margin-bottom: 5px;
            transition: background-color var(--transition-speed), transform 0.2s;
            box-shadow: 0 2px 4px var(--shadow-color);
            font-size: 14px;
            touch-action: manipulation;
        }

        .finish-btn:active {
            transform: scale(0.98);
        }

        .finish-btn.hot-kitchen {
            background-color: var(--danger-btn);
        }

        .finish-btn.cold-kitchen {
            background-color: var(--info-btn);
        }

        .finish-btn.delivery {
            background-color: #f39c12;
        }

        .finish-btn.delivery-arrived {
            background-color: #3498db;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
            font-size: 14px;
        }

        th, td {
            border: 1px solid var(--border-color);
            padding: 8px 6px;
            text-align: left;
            color: var(--text-color);
            transition: background-color var(--transition-speed);
        }

        th {
            background-color: var(--table-header-bg);
            color: var(--table-header-text);
            position: sticky;
            top: 0;
            font-size: 12px;
        }

        tr:active td {
            background-color: var(--highlight-bg);
        }

        /* Clases para tiempos */
        .time-excellent {
            color: var(--time-excellent);
            font-weight: bold;
        }

        .time-good {
            color: var(--time-good);
        }

        .time-warning {
            color: var(--time-warning);
        }

        .time-bad {
            color: var(--time-bad);
            font-weight: bold;
        }

        /* Notificaciones */
        #notification {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--notification-bg);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px var(--shadow-color);
            max-width: 350px;
            z-index: 1000;
            display: none;
            animation: fadeIn 0.3s;
            font-weight: 500;
            text-align: center;
            width: 85%;
        }

        .notification-success {
            background-color: var(--success-btn);
        }

        .notification-warning {
            background-color: var(--warning-btn);
        }

        .notification-error {
            background-color: var(--danger-btn);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translate(-50%, 20px); }
            to { opacity: 1; transform: translate(-50%, 0); }
        }

        /* Mejoras de accesibilidad */
        :focus {
            outline: 2px solid var(--primary-btn);
            outline-offset: 2px;
        }

        /* Animaciones */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .dishes-section, .preparation-section {
            animation: fadeInUp 0.3s ease-out;
        }

        /* PWA mejoras */
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .button-group .back-btn {
            flex: 1;
            margin: 0;
            font-size: 14px;
            white-space: nowrap;
            padding: 10px;
            text-align: center;
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            z-index: 1001;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .modal.active {
            opacity: 1;
            pointer-events: all;
        }

        .modal-content {
            background-color: var(--container-bg);
            padding: 20px;
            border-radius: 8px;
            max-width: 90%;
            max-height: 90%;
            overflow: auto;
            -webkit-overflow-scrolling: touch;
            margin: 10px;
        }

        /* Filtros */
        .filter-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .filter-btn {
            background-color: var(--highlight-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color var(--transition-speed), 
                        color var(--transition-speed),
                        transform 0.2s;
            font-size: 14px;
            touch-action: manipulation;
        }

        .filter-btn:active {
            transform: scale(0.98);
        }

        .filter-btn.active {
            background-color: var(--primary-btn);
            color: var(--primary-btn-text);
            border-color: var(--primary-btn);
        }

        /* Encabezados */
        h2 {
            margin-bottom: 15px;
            color: var(--text-color);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 8px;
            font-size: 18px;
        }

        .section-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .count-badge {
            background-color: var(--primary-btn);
            color: white;
            font-size: 12px;
            padding: 3px 8px;
            border-radius: 10px;
            font-weight: bold;
        }

        /* Mensajes vacíos */
        .empty-message {
            text-align: center;
            color: #777;
            font-style: italic;
            padding: 15px;
        }

        /* Detalles de pedido */
        .details-cell {
            font-size: 12px;
            line-height: 1.3;
        }

        /* App instalación guía */
        .install-guide {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: rgba(0,0,0,0.85);
            color: white;
            padding: 15px;
            font-size: 14px;
            display: none;
            z-index: 10000;
        }

        .install-guide p {
            margin-bottom: 10px;
        }

        .install-guide button {
            background-color: white;
            color: black;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            touch-action: manipulation;
        }

        /* Mejoras específicas para iOS */
        @supports (-webkit-touch-callout: none) {
            /* CSS específico para iOS */
            input, button, textarea, select {
                font-size: 16px; /* Previene zoom automático */
            }
            
            /* Corrige el comportamiento de botones en iOS */
            button, .option-btn, .finish-btn, .action-btn, .back-btn, .category-btn, .dish-btn, .filter-btn {
                touch-action: manipulation;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>Avika - Temporizador</h1>
        <div class="header-controls">
            <button id="toggle-theme" class="icon-btn">🌙</button>
        </div>
    </header>
    
    <div class="container">
        <!-- Notificaciones -->
        <div id="notification"></div>
        
        <!-- Sección de categorías -->
        <div id="categories-section">
            <h2>Selecciona una categoría</h2>
            <div class="category-container">
                <button class="category-btn" id="btn-frio">Platillos Fríos</button>
                <button class="category-btn" id="btn-entrada-fria">Entradas Frías</button>
                <button class="category-btn" id="btn-caliente">Platillos Calientes</button>
                <button class="category-btn" id="btn-entrada-caliente">Entradas Calientes</button>
                <button class="category-btn" id="btn-combos">Combos</button>
            </div>
            
            <!-- Órdenes pendientes -->
            <div class="pending-orders-section">
                <div class="section-title">
                    <h2>Platillos en preparación</h2>
                    <div class="count-badge" id="pending-count">0</div>
                </div>
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Platillo</th>
                                <th>Inicio</th>
                                <th>Tiempo</th>
                                <th>Detalles</th>
                                <th>Acción</th>
                            </tr>
                        </thead>
                        <tbody id="pending-body">
                            <!-- Se llenará con JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Órdenes completadas -->
            <div class="pending-orders-section">
                <h2>Platillos completados</h2>
                <div class="filter-controls">
                    <button id="btn-show-all-history" class="filter-btn">Ver historial</button>
                    <button id="btn-show-recent" class="filter-btn active">Ver recientes</button>
                </div>
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Platillo</th>
                                <th>Inicio</th>
                                <th>Fin</th>
                                <th>Total</th>
                                <th>Detalles</th>
                            </tr>
                        </thead>
                        <tbody id="completed-body">
                            <!-- Se llenará con JavaScript -->
                        </tbody>
                    </table>
                </div>
                <div class="button-group">
                    <button class="back-btn" id="btn-promedios" style="background-color: #3498db;">Ver Promedios</button>
                    <button class="back-btn" id="btn-export">Exportar a Excel</button>
                    <button class="back-btn" id="btn-clear" style="background-color: #e74c3c;">Limpiar</button>
                </div>
            </div>
        </div>
        
        <!-- Sección de platillos -->
        <div id="dishes-section" style="display: none;">
            <h2 id="selected-category-title">Categoría</h2>
            <div id="dishes-container" class="dishes-container">
                <!-- Se llenará con JavaScript -->
            </div>
            
            <button class="back-btn" id="btn-back-to-categories">Volver a Categorías</button>
        </div>
        
        <!-- Sección de preparación -->
        <div id="preparation-section" class="preparation-section" style="display: none;">
            <h2 id="selected-dish-title">Platillo</h2>
            
            <div id="personalization-section">
                <div class="option-group">
                    <div class="option-title">Personalización</div>
                    <div class="option-btns" id="personalization-options">
                        <!-- Se llenará dinámicamente con JS -->
                    </div>
                </div>
            </div>
            
            <div class="option-group">
                <div class="option-title">Tipo de Servicio</div>
                <div class="option-btns">
                    <button class="option-btn selected" id="btn-comedor">Comedor</button>
                    <button class="option-btn" id="btn-domicilio">Domicilio</button>
                    <button class="option-btn" id="btn-para-llevar">Ordena y Espera</button>
                </div>
            </div>
            
            <div class="option-group">
                <div class="option-title">Cantidad</div>
                <div class="qty-control">
                    <button class="qty-btn" id="btn-decrease">-</button>
                    <span class="qty-display" id="quantity-display">1</span>
                    <button class="qty-btn" id="btn-increase">+</button>
                </div>
            </div>
            
            <div class="option-group">
                <div class="option-title">Notas Especiales</div>
                <textarea class="notes-input" id="notes-input" placeholder="Ej: Cliente alérgico a mariscos" rows="3"></textarea>
            </div>
            
            <div class="action-btns">
                <button class="action-btn cancel-btn" id="btn-cancel">Cancelar</button>
                <button class="action-btn start-btn" id="btn-start">Iniciar Preparación</button>
            </div>
            <button class="back-btn" id="btn-back-to-dishes" style="width: 100%; margin-top: 10px;">Atrás</button>
        </div>
    </div>
    
    <!-- Modal para promedios -->
    <div id="promedios-modal" class="modal">
        <div class="modal-content">
            <div id="promedios-contenido">
                <!-- Se llenará con JavaScript -->
            </div>
            <button class="back-btn" id="modal-close" style="width: 100%; margin-top: 15px;">Cerrar</button>
        </div>
    </div>
    
    <!-- Guía de instalación -->
    <div class="install-guide" id="install-guide">
        <p>Para una mejor experiencia, añade esta app a tu pantalla de inicio</p>
        <p>1. Toca el icono <strong>compartir</strong> <span style="font-size: 18px">⬆️</span> abajo</p>
        <p>2. Desplázate y selecciona <strong>"Añadir a pantalla de inicio"</strong></p>
        <button id="hide-guide">Entendido</button>
    </div>

    <script>
    // Variables globales (estado)
    var currentCategory = '';
    var currentDish = '';
    var currentCustomizations = [];
    var currentService = 'comedor';
    var currentQuantity = 1;
    var isSpecialCombo = false;
    // Función para regresar a la pantalla principal
    function resetApp() {
        document.getElementById('dishes-section').style.display = 'none';
        document.getElementById('preparation-section').style.display = 'none';
        document.getElementById('categories-section').style.display = 'block';
        
        // Reset estados
        currentCategory = '';
        currentDish = '';
        currentCustomizations = [];
        currentService = 'comedor';
        currentQuantity = 1;
        document.getElementById('quantity-display').textContent = "1";
        document.getElementById('notes-input').value = '';
        
        // Reset UI de servicio
        document.querySelectorAll('.option-btn[id^="btn-"]').forEach(el => {
            el.classList.remove('selected');
        });
        document.getElementById('btn-comedor').classList.add('selected');
    }

    // Guardar datos en localStorage
    function guardarDatosLocales() {
        localStorage.setItem('avika_pendingOrders', JSON.stringify(pendingOrders));
        localStorage.setItem('avika_completedOrders', JSON.stringify(completedOrders));
    }

    // Cargar datos de localStorage
    function cargarDatosLocales() {
        const pendingData = localStorage.getItem('avika_pendingOrders');
        const completedData = localStorage.getItem('avika_completedOrders');
        
        if (pendingData) {
            pendingOrders = JSON.parse(pendingData);
        }
        
        if (completedData) {
            completedOrders = JSON.parse(completedData);
        }
    }

    // Función para iniciar el timer que actualiza los tiempos de pedidos pendientes
    function iniciarTimer() {
        // Limpiar intervalo existente si hay uno
        if (timerInterval) {
            clearInterval(timerInterval);
        }
        
        // Actualizar cada segundo
        timerInterval = setInterval(() => {
            // Solo actualizar si hay pedidos pendientes
            if (pendingOrders.length > 0) {
                updatePendingTable();
            }
        }, 1000);
    }

    // Mostrar notificación
    function showNotification(message, type = 'success') {
        const notification = document.getElementById('notification');
        notification.textContent = message;
        notification.style.display = 'block';
        
        // Asignar clase según tipo
        notification.className = '';
        notification.classList.add('notification', `notification-${type}`);
        
        // Ocultar después de 3 segundos
        setTimeout(() => {
            notification.style.display = 'none';
        }, 3000);
    }

    // Alternar entre tema claro y oscuro
    function toggleTheme() {
        document.body.classList.toggle('dark-mode');
        const themeButton = document.getElementById('toggle-theme');
        
        if (document.body.classList.contains('dark-mode')) {
            themeButton.textContent = '☀️';
            localStorage.setItem('avika_theme', 'dark');
        } else {
            themeButton.textContent = '🌙';
            localStorage.setItem('avika_theme', 'light');
        }
    }

    // Obtener nombre del servicio
    function getServiceName(serviceId) {
        const services = {
            'comedor': 'Comedor',
            'domicilio': 'Domicilio',
            'para-llevar': 'Ordena y Espera'
        };
        return services[serviceId] || serviceId;
    }

    // Función de utilidad para generar ID
    function generateId() {
        return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }

    // Función para formatear hora
    function formatTime(date) {
        return date.toLocaleTimeString('es-MX', {
            hour: '2-digit',
            minute: '2-digit',
            hour12: true
        });
    }

    // Agregar ceros iniciales
    function padZero(num) {
        return num < 10 ? '0' + num : num;
    }

    // Mostrar modal de promedios
    function showPromedios() {
        if (completedOrders.length === 0) {
            showNotification('No hay datos suficientes para calcular promedios', 'warning');
            return;
        }
        
        const container = document.getElementById('promedios-contenido');
        container.innerHTML = '<h3>Tiempo Promedio por Platillo</h3>';<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Avika - Temporizador</title>
    <style>
        /* Estilos base optimizados para iPhone */
        :root {
            --bg-color: #f0f0f0;
            --container-bg: #ffffff;
            --text-color: #333333;
            --header-bg: #e74c3c;
            --header-text: white;
            --primary-btn: #3498db;
            --primary-btn-text: white;
            --success-btn: #2ecc71;
            --danger-btn: #e74c3c;
            --warning-btn: #f0ad4e;
            --info-btn: #5bc0de;
            --border-color: #ddd;
            --table-header-bg: #3498db;
            --table-header-text: white;
            --notification-bg: #2ecc71;
            --highlight-bg: #f9f9f9;
            --shadow-color: rgba(0,0,0,0.1);
            --btn-hover: #2980b9;
            
            /* Variables para tiempos */
            --time-excellent: #2ecc71;
            --time-good: #7fdbff;
            --time-warning: #f39c12;
            --time-bad: #e74c3c;
            
            /* Transiciones */
            --transition-speed: 0.3s;
            
            /* Fuentes */
            --font-main: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            --font-monospace: 'Menlo', monospace;
        }

        .dark-mode {
            --bg-color: #121212;
            --container-bg: #1e1e1e;
            --text-color: #e0e0e0;
            --header-bg: #c0392b;
            --header-text: #f0f0f0;
            --primary-btn: #2980b9;
            --primary-btn-text: #f0f0f0;
            --success-btn: #27ae60;
            --danger-btn: #c0392b;
            --warning-btn: #d35400;
            --info-btn: #2980b9;
            --border-color: #444;
            --table-header-bg: #2980b9;
            --table-header-text: #f0f0f0;
            --notification-bg: #27ae60;
            --highlight-bg: #2a2a2a;
            --shadow-color: rgba(0,0,0,0.3);
            --btn-hover: #3498db;
            
            /* Colores de tiempos en modo oscuro */
            --time-excellent: #27ae60;
            --time-good: #2980b9;
            --time-warning: #d35400;
            --time-bad: #c0392b;
        }

        /* Estilos generales */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: var(--font-main);
            margin: 0;
            padding: 15px;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color var(--transition-speed), color var(--transition-speed);
            line-height: 1.6;
            -webkit-user-select: none;
            user-select: none;
            overscroll-behavior: none;
            -webkit-overflow-scrolling: touch;
            touch-action: manipulation;
        }

        /* Encabezado */
        header {
            background-color: var(--header-bg);
            color: var(--header-text);
            padding: 15px;
            text-align: center;
            margin-bottom: 20px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px var(--shadow-color);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        header h1 {
            margin: 0;
            flex: 1;
            font-size: 1.5rem;
        }

        .header-controls {
            display: flex;
            gap: 10px;
        }

        .icon-btn {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--header-text);
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: background-color var(--transition-speed);
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: manipulation;
        }

        .icon-btn:active {
            background-color: rgba(255, 255, 255, 0.2);
        }

        /* Contenedor principal */
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding-bottom: 80px; /* Para evitar que el último elemento quede oculto detrás del dock de iOS */
        }

        /* Secciones */
        section {
            background-color: var(--container-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px var(--shadow-color);
            margin-bottom: 20px;
            transition: background-color var(--transition-speed);
        }

        /* Contenedor de categorías */
        .category-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .category-btn {
            background-color: var(--primary-btn);
            color: var(--primary-btn-text);
            border: none;
            padding: 15px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            height: 70px;
            transition: background-color var(--transition-speed), transform 0.2s;
            box-shadow: 0 2px 4px var(--shadow-color);
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: manipulation;
        }

        .category-btn:active {
            background-color: var(--btn-hover);
            transform: scale(0.98);
        }

        /* Sección de platillos */
        .dishes-section {
            display: none;
        }

        .dishes-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .dish-btn {
            background-color: var(--container-bg);
            color: var(--text-color);
            border: 1px solid var(--primary-btn);
            padding: 12px 10px;
            font-size: 14px;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: background-color var(--transition-speed), 
                        color var(--transition-speed), 
                        transform 0.2s;
            height: 60px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            touch-action: manipulation;
            position: relative;
        }

        .dish-btn:active {
            background-color: var(--primary-btn);
            color: var(--primary-btn-text);
            transform: scale(0.98);
        }

        .dish-btn.special-combo {
            border: 2px solid var(--danger-btn);
            position: relative;
        }

        .dish-btn.special-combo::after {
            content: "★";
            position: absolute;
            top: 5px;
            right: 5px;
            color: var(--danger-btn);
            font-size: 14px;
        }

        /* Sección de preparación */
        .preparation-section {
            display: none;
            background-color: var(--container-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 3px 10px var(--shadow-color);
            margin-top: 20px;
        }

        .option-group {
            margin-bottom: 20px;
        }

        .option-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--text-color);
            font-size: 1.1rem;
        }

        .option-btns {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .option-btn {
            background-color: var(--highlight-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color var(--transition-speed), color var(--transition-speed);
            font-size: 14px;
            flex: 1;
            min-width: 100px;
            text-align: center;
            touch-action: manipulation;
        }

        .option-btn.selected {
            background-color: var(--primary-btn);
            color: var(--primary-btn-text);
            border-color: var(--primary-btn);
        }

        /* Control de cantidad */
        .qty-control {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .qty-btn {
            background-color: var(--primary-btn);
            color: var(--primary-btn-text);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color var(--transition-speed);
            touch-action: manipulation;
        }

        .qty-btn:active {
            background-color: var(--btn-hover);
        }

        .qty-display {
            font-size: 20px;
            font-weight: bold;
            min-width: 40px;
            text-align: center;
            color: var(--text-color);
        }

        /* Área de notas */
        .notes-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background-color: var(--container-bg);
            color: var(--text-color);
            resize: vertical;
            min-height: 80px;
            font-family: var(--font-main);
            transition: border-color var(--transition-speed);
            font-size: 16px; /* Evita el zoom automático en iOS */
        }

        .notes-input:focus {
            outline: none;
            border-color: var(--primary-btn);
        }

        /* Botones de acción */
        .action-btns {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }

        .action-btn {
            flex: 1;
            padding: 14px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color var(--transition-speed), 
                        transform 0.2s,
                        box-shadow 0.2s;
            box-shadow: 0 2px 4px var(--shadow-color);
            touch-action: manipulation;
        }

        .action-btn:active {
            transform: scale(0.98);
            box-shadow: 0 1px 2px var(--shadow-color);
        }

        .cancel-btn {
            background-color: var(--danger-btn);
            color: white;
        }

        .start-btn {
            background-color: var(--success-btn);
            color: white;
        }

        .back-btn {
            background-color: var(--warning-btn);
            color: white;
            padding: 12px 18px;
            margin: 15px 0;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color var(--transition-speed), transform 0.2s;
            box-shadow: 0 2px 4px var(--shadow-color);
            touch-action: manipulation;
        }

        .back-btn:active {
            transform: scale(0.98);
        }

        /* Tablas */
        .pending-orders-section {
            margin-top: 30px;
            background-color: var(--container-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px var(--shadow-color);
        }

        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .timer-cell {
            font-weight: bold;
            color: var(--text-color);
            font-size: 16px;
            font-family: var(--font-monospace);
        }

        .timer-cell.warning {
            color: var(--time-warning);
        }

        .timer-cell.alert {
            color: var(--time-bad);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }

        .finish-btn {
            background-color: var(--success-btn);
            color: white;
            border: none;
            padding: 10px 8px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
            margin-bottom: 5px;
            transition: background-color var(--transition-speed), transform 0.2s;
            box-shadow: 0 2px 4px var(--shadow-color);
            font-size: 14px;
            touch-action: manipulation;
        }

        .finish-btn:active {
            transform: scale(0.98);
        }

        .finish-btn.hot-kitchen {
            background-color: var(--danger-btn);
        }

        .finish-btn.cold-kitchen {
            background-color: var(--info-btn);
        }

        .finish-btn.delivery {
            background-color: #f39c12;
        }

        .finish-btn.delivery-arrived {
            background-color: #3498db;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
            font-size: 14px;
        }

        th, td {
            border: 1px solid var(--border-color);
            padding: 8px 6px;
            text-align: left;
            color: var(--text-color);
            transition: background-color var(--transition-speed);
        }

        th {
            background-color: var(--table-header-bg);
            color: var(--table-header-text);
            position: sticky;
            top: 0;
            font-size: 12px;
        }

        tr:active td {
            background-color: var(--highlight-bg);
        }

        /* Clases para tiempos */
        .time-excellent {
            color: var(--time-excellent);
            font-weight: bold;
        }

        .time-good {
            color: var(--time-good);
        }

        .time-warning {
            color: var(--time-warning);
        }

        .time-bad {
            color: var(--time-bad);
            font-weight: bold;
        }

        /* Notificaciones */
        #notification {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--notification-bg);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px var(--shadow-color);
            max-width: 350px;
            z-index: 1000;
            display: none;
            animation: fadeIn 0.3s;
            font-weight: 500;
            text-align: center;
            width: 85%;
        }

        .notification-success {
            background-color: var(--success-btn);
        }

        .notification-warning {
            background-color: var(--warning-btn);
        }

        .notification-error {
            background-color: var(--danger-btn);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translate(-50%, 20px); }
            to { opacity: 1; transform: translate(-50%, 0); }
        }

        /* Mejoras de accesibilidad */
        :focus {
            outline: 2px solid var(--primary-btn);
            outline-offset: 2px;
        }

        /* Animaciones */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .dishes-section, .preparation-section {
            animation: fadeInUp 0.3s ease-out;
        }

        /* PWA mejoras */
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .button-group .back-btn {
            flex: 1;
            margin: 0;
            font-size: 14px;
            white-space: nowrap;
            padding: 10px;
            text-align: center;
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            z-index: 1001;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .modal.active {
            opacity: 1;
            pointer-events: all;
        }

        .modal-content {
            background-color: var(--container-bg);
            padding: 20px;
            border-radius: 8px;
            max-width: 90%;
            max-height: 90%;
            overflow: auto;
            -webkit-overflow-scrolling: touch;
            margin: 10px;
        }

        /* Filtros */
        .filter-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .filter-btn {
            background-color: var(--highlight-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color var(--transition-speed), 
                        color var(--transition-speed),
                        transform 0.2s;
            font-size: 14px;
            touch-action: manipulation;
        }

        .filter-btn:active {
            transform: scale(0.98);
        }

        .filter-btn.active {
            background-color: var(--primary-btn);
            color: var(--primary-btn-text);
            border-color: var(--primary-btn);
        }

        /* Encabezados */
        h2 {
            margin-bottom: 15px;
            color: var(--text-color);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 8px;
            font-size: 18px;
        }

        .section-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .count-badge {
            background-color: var(--primary-btn);
            color: white;
            font-size: 12px;
            padding: 3px 8px;
            border-radius: 10px;
            font-weight: bold;
        }

        /* Mensajes vacíos */
        .empty-message {
            text-align: center;
            color: #777;
            font-style: italic;
            padding: 15px;
        }

        /* Detalles de pedido */
        .details-cell {
            font-size: 12px;
            line-height: 1.3;
        }

        /* App instalación guía */
        .install-guide {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: rgba(0,0,0,0.85);
            color: white;
            padding: 15px;
            font-size: 14px;
            display: none;
            z-index: 10000;
        }

        .install-guide p {
            margin-bottom: 10px;
        }

        .install-guide button {
            background-color: white;
            color: black;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            touch-action: manipulation;
        }

        /* Mejoras específicas para iOS */
        @supports (-webkit-touch-callout: none) {
            /* CSS específico para iOS */
            input, button, textarea, select {
                font-size: 16px; /* Previene zoom automático */
            }
            
            /* Corrige el comportamiento de botones en iOS */
            button, .option-btn, .finish-btn, .action-btn, .back-btn, .category-btn, .dish-btn, .filter-btn {
                touch-action: manipulation;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>Avika - Temporizador</h1>
        <div class="header-controls">
            <button id="toggle-theme" class="icon-btn">🌙</button>
        </div>
    </header>
    
    <div class="container">
        <!-- Notificaciones -->
        <div id="notification"></div>
        
        <!-- Sección de categorías -->
        <div id="categories-section">
            <h2>Selecciona una categoría</h2>
            <div class="category-container">
                <button class="category-btn" id="btn-frio">Platillos Fríos</button>
                <button class="category-btn" id="btn-entrada-fria">Entradas Frías</button>
                <button class="category-btn" id="btn-caliente">Platillos Calientes</button>
                <button class="category-btn" id="btn-entrada-caliente">Entradas Calientes</button>
                <button class="category-btn" id="btn-combos">Combos</button>
            </div>
            
            <!-- Órdenes pendientes -->
            <div class="pending-orders-section">
                <div class="section-title">
                    <h2>Platillos en preparación</h2>
                    <div class="count-badge" id="pending-count">0</div>
                </div>
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Platillo</th>
                                <th>Inicio</th>
                                <th>Tiempo</th>
                                <th>Detalles</th>
                                <th>Acción</th>
                            </tr>
                        </thead>
                        <tbody id="pending-body">
                            <!-- Se llenará con JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Órdenes completadas -->
            <div class="pending-orders-section">
                <h2>Platillos completados</h2>
                <div class="filter-controls">
                    <button id="btn-show-all-history" class="filter-btn">Ver historial</button>
                    <button id="btn-show-recent" class="filter-btn active">Ver recientes</button>
                </div>
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Platillo</th>
                                <th>Inicio</th>
                                <th>Fin</th>
                                <th>Total</th>
                                <th>Detalles</th>
                            </tr>
                        </thead>
                        <tbody id="completed-body">
                            <!-- Se llenará con JavaScript -->
                        </tbody>
                    </table>
                </div>
                <div class="button-group">
                    <button class="back-btn" id="btn-promedios" style="background-color: #3498db;">Ver Promedios</button>
                    <button class="back-btn" id="btn-export">Exportar a Excel</button>
                    <button class="back-btn" id="btn-clear" style="background-color: #e74c3c;">Limpiar</button>
                </div>
            </div>
        </div>
        
        <!-- Sección de platillos -->
        <div id="dishes-section" style="display: none;">
            <h2 id="selected-category-title">Categoría</h2>
            <div id="dishes-container" class="dishes-container">
                <!-- Se llenará con JavaScript -->
            </div>
            
            <button class="back-btn" id="btn-back-to-categories">Volver a Categorías</button>
        </div>
        
        <!-- Sección de preparación -->
        <div id="preparation-section" class="preparation-section" style="display: none;">
            <h2 id="selected-dish-title">Platillo</h2>
            
            <div id="personalization-section">
                <div class="option-group">
                    <div class="option-title">Personalización</div>
                    <div class="option-btns" id="personalization-options">
                        <!-- Se llenará dinámicamente con JS -->
                    </div>
                </div>
            </div>
            
            <div class="option-group">
                <div class="option-title">Tipo de Servicio</div>
                <div class="option-btns">
                    <button class="option-btn selected" id="btn-comedor">Comedor</button>
                    <button class="option-btn" id="btn-domicilio">Domicilio</button>
                    <button class="option-btn" id="btn-para-llevar">Ordena y Espera</button>
                </div>
            </div>
            
            <div class="option-group">
                <div class="option-title">Cantidad</div>
                <div class="qty-control">
                    <button class="qty-btn" id="btn-decrease">-</button>
                    <span class="qty-display" id="quantity-display">1</span>
                    <button class="qty-btn" id="btn-increase">+</button>
                </div>
            </div>
            
            <div class="option-group">
                <div class="option-title">Notas Especiales</div>
                <textarea class="notes-input" id="notes-input" placeholder="Ej: Cliente alérgico a mariscos" rows="3"></textarea>
            </div>
            
            <div class="action-btns">
                <button class="action-btn cancel-btn" id="btn-cancel">Cancelar</button>
                <button class="action-btn start-btn" id="btn-start">Iniciar Preparación</button>
            </div>
            <button class="back-btn" id="btn-back-to-dishes" style="width: 100%; margin-top: 10px;">Atrás</button>
        </div>
    </div>
    
    <!-- Modal para promedios -->
    <div id="promedios-modal" class="modal">
        <div class="modal-content">
            <div id="promedios-contenido">
                <!-- Se llenará con JavaScript -->
            </div>
            <button class="back-btn" id="modal-close" style="width: 100%; margin-top: 15px;">Cerrar</button>
        </div>
    </div>
    
    <!-- Guía de instalación -->
    <div class="install-guide" id="install-guide">
        <p>Para una mejor experiencia, añade esta app a tu pantalla de inicio</p>
        <p>1. Toca el icono <strong>compartir</strong> <span style="font-size: 18px">⬆️</span> abajo</p>
        <p>2. Desplázate y selecciona <strong>"Añadir a pantalla de inicio"</strong></p>
        <button id="hide-guide">Entendido</button>
    </div>

    <script>
    // Variables globales (estado)
    var currentCategory = '';
    var currentDish = '';
    var currentCustomizations = [];
    var currentService = 'comedor';
    var currentQuantity = 1;
    var isSpecialCombo = false;

    // Arrays para almacenar pedidos
    var pendingOrders = [];
    var completedOrders = [];
    var timerInterval;

    // Opciones de personalización predeterminadas
    var customizationOptions = {
        'sin-alga': 'Sin Alga',
        'extra-picante': 'Extra Picante',
        'cambio-proteina': 'Cambiar Proteína'
    };

    // Datos de platillos
    var dishes = {
        'frio': [
            'Baby Squid', 'Tiradito de Atún Togarashi', 'Tiradito de Camarón', 'Maguro Peruano',
            'Tostadita Nikkei', 'Tostada de ceviche verde', 'Tostadita Tataki', 'Tostadita Crunchy',
            'Cocktail Avika', 'Ceviche Limeño', 'Ceviche Peruano',
            'Sashimi de Robalo', 'Sashimi de Atún', 'Sashimi Mixto', 'Sashimi de Salmón',
            'Kanikama Roll', 'Curry Roll', 'Philadelphia Roll', 'Spicy Roll', 'Aguacate Roll',
            'Avi Roll', 'Mango Roll', 'Mikuso Roll', 'Acevichado Roll', 'Dragon Roll', 
            'Furai Roll', 'Coco Roll', 'Red Fire Roll', 'Ebi Crunch Roll', 'Teriyaki Crunch Roll',
            'TNT Roll', 'Ika Ebi Roll', 'Tuna Roll', 'Rocotto Roll', 'Parrillero Roll',
            'Rib Eye Roll', 'Avika Roll'
        ],
        'entrada-fria': [
            'Baby Squid', 'Tiradito de Atún Togarashi', 'Tiradito de Camarón', 'Maguro Peruano',
            'Tostadita Nikkei', 'Tostada de ceviche verde', 'Tostadita Tataki', 'Tostadita Crunchy',
            'Cocktail Avika', 'Ceviche Limeño', 'Ceviche Peruano'
        ],
        'caliente': [
            'Arroz Yakimeshi', 'Arroz Peruano', 'Arroz Wok', 'Arroz Thai con Mariscos',
            'Teriyaki', 'Yakisoba', 'Nuggets', 'Pechuga Teriyaki', 'Lomo Saltado', 'Rib Eye Grill',
            'Camarón Nutty', 'Camarón Iwa', 'Pasta de Mar', 'Ebi Chips', 'Pulpo Marine',
            'Tuna Thai', 'Atún salsa Rocotto', 'Filete Thai Asia', 'Filete Ninjago',
            'Filete Zakana Thai', 'Salmón Kion', 'Sake New Style', 'Pargo al Ika Ebi'
        ],
        'entrada-caliente': [
            'Kushiage', 'Rollitos Kani', 'Toritos Tempura', 'Taquitos Crujientes', 
            'Miso Shiro', 'Sopa Udon', 'Sopa Ramen de Cerdo', 'Sopa Mariscos Thai',
            'Tacos Nikkei', 'Tacos de Costra de Queso', 'Brocheta Yakitori', 'Ika Ebi Togarashi'
        ],
        'combos': [
            'Combo Tokio', 'Combo Osaka', 'Combo Bagua', 'Combo Pisco', 'Combo Lima'
        ]
    };

    // Lista de platillos especiales
    var specialDishes = [
        'Baby Squid', 'Tiradito de Camarón', 'Maguro Peruano', 'Tostadita Crunchy',
        'Spicy Roll', 'Red Fire Roll', 'Ebi Crunch Roll', 'TNT Roll', 'Rib Eye Roll',
        'Avika Roll', 'Toritos Tempura', 'Taquitos Crujientes', 'Ika Ebi Togarashi',
        'Ebi Chips', 'Pulpo Marine', 'Filete Zakana Thai', 'Salmón Kion',
        'Combo Tokio', 'Combo Osaka', 'Combo Bagua'
    ];

    // Mostrar sección de categorías al inicio
    document.addEventListener('DOMContentLoaded', function() {
        // Cargar datos guardados
        cargarDatosLocales();
        
        // Actualizar tablas
        updatePendingTable();
        updateCompletedTable();
        
        // Iniciar timer para actualizar tiempos
        iniciarTimer();
        
        // Inicializar eventos
        setupEventListeners();
        
        // Aplicar tema guardado
        if (localStorage.getItem('avika_theme') === 'dark') {
            document.body.classList.add('dark-mode');
            document.getElementById('toggle-theme').textContent = '☀️';
        }
        
        // Mostrar guía de instalación si es necesario
        if (localStorage.getItem('avika_hideGuide') !== 'true') {
            document.getElementById('install-guide').style.display = 'block';
        }
    });

    // Configurar todos los eventos de la aplicación
    function setupEventListeners() {
        // Botones de categoría
        document.getElementById('btn-frio').addEventListener('click', function() {
            currentCategory = 'frio';
            mostrarPlatillos('frio', 'Platillos Fríos');
        });
        
        document.getElementById('btn-entrada-fria').addEventListener('click', function() {
            currentCategory = 'entrada-fria';
            mostrarPlatillos('entrada-fria', 'Entradas Frías');
        });
        
        document.getElementById('btn-caliente').addEventListener('click', function() {
            currentCategory = 'caliente';
            mostrarPlatillos('caliente', 'Platillos Calientes');
        });
        
        document.getElementById('btn-entrada-caliente').addEventListener('click', function() {
            currentCategory = 'entrada-caliente';
            mostrarPlatillos('entrada-caliente', 'Entradas Calientes');
        });
        
        document.getElementById('btn-combos').addEventListener('click', function() {
            currentCategory = 'combos';
            mostrarPlatillos('combos', 'Combos');
        });
        
        // Botón para volver a categorías
        document.getElementById('btn-back-to-categories').addEventListener('click', function() {
            document.getElementById('dishes-section').style.display = 'none';
            document.getElementById('categories-section').style.display = 'block';
        });
        
        // Botón para volver a platillos
        document.getElementById('btn-back-to-dishes').addEventListener('click', function() {
            document.getElementById('preparation-section').style.display = 'none';
            document.getElementById('dishes-section').style.display = 'block';
        });
        
        // Botones de servicio
        document.getElementById('btn-comedor').addEventListener('click', function() {
            document.querySelectorAll('.option-btn[id^="btn-"]').forEach(el => {
                el.classList.remove('selected');
            });
            this.classList.add('selected');
            currentService = 'comedor';
        });
        
        document.getElementById('btn-domicilio').addEventListener('click', function() {
            document.querySelectorAll('.option-btn[id^="btn-"]').forEach(el => {
                el.classList.remove('selected');
            });
            this.classList.add('selected');
            currentService = 'domicilio';
        });
        
        document.getElementById('btn-para-llevar').addEventListener('click', function() {
            document.querySelectorAll('.option-btn[id^="btn-"]').forEach(el => {
                el.classList.remove('selected');
            });
            this.classList.add('selected');
            currentService = 'para-llevar';
        });
        
        // Botones de cantidad
        document.getElementById('btn-decrease').addEventListener('click', function() {
            if (currentQuantity > 1) {
                currentQuantity--;
                document.getElementById('quantity-display').textContent = currentQuantity;
            }
        });
        
        document.getElementById('btn-increase').addEventListener('click', function() {
            currentQuantity++;
            document.getElementById('quantity-display').textContent = currentQuantity;
        });
        
        // Botones de acción
        document.getElementById('btn-start').addEventListener('click', startPreparation);
        document.getElementById('btn-cancel').addEventListener('click', resetApp);
        
        // Botones de filtro
        document.getElementById('btn-show-all-history').addEventListener('click', function() {
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            updateCompletedTable();
        });
        
        document.getElementById('btn-show-recent').addEventListener('click', function() {
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            updateCompletedTable();
        });
        
        // Botón de tema
        document.getElementById('toggle-theme').addEventListener('click', toggleTheme);
        
        // Botón de guía de instalación
        document.getElementById('hide-guide').addEventListener('click', function() {
            document.getElementById('install-guide').style.display = 'none';
            localStorage.setItem('avika_hideGuide', 'true');
        });
        
        // Botón de promedios
        document.getElementById('btn-promedios').addEventListener('click', showPromedios);
        document.getElementById('modal-close').addEventListener('click', function() {
            document.getElementById('promedios-modal').classList.remove('active');
        });
        
        // Botón de exportar
        document.getElementById('btn-export').addEventListener('click', exportToCSV);
        
        // Botón de limpiar
        document.getElementById('btn-clear').addEventListener('click', function() {
            if (confirm('¿Estás seguro de que deseas eliminar todos los datos? Esta acción no se puede deshacer.')) {
                pendingOrders = [];
                completedOrders = [];
                updatePendingTable();
                updateCompletedTable();
                guardarDatosLocales();
                showNotification('Todos los datos han sido eliminados', 'warning');
            }
        });
    }

    // Mostrar los platillos de una categoría
    function mostrarPlatillos(categoria, titulo) {
        document.getElementById('categories-section').style.display = 'none';
        document.getElementById('dishes-section').style.display = 'block';
        document.getElementById('selected-category-title').textContent = titulo;
        
        const container = document.getElementById('dishes-container');
        container.innerHTML = '';
        
        dishes[categoria].forEach(dish => {
            const btn = document.createElement('button');
            btn.className = 'dish-btn';
            btn.textContent = dish;
            
            // Si es un platillo especial, aplicar clase especial
            if (specialDishes.includes(dish)) {
                btn.className += ' special-combo';
                
                // Si es un combo, marcar como especial
                if (categoria === 'combos') {
                    isSpecialCombo = true;
                }
            }
            
            btn.addEventListener('click', function() {
                seleccionarPlatillo(dish);
            });
            
            container.appendChild(btn);
        });
    }

    // Seleccionar un platillo y mostrar opciones de personalización
    function seleccionarPlatillo(platillo) {
        currentDish = platillo;
        document.getElementById('dishes-section').style.display = 'none';
        document.getElementById('preparation-section').style.display = 'block';
        document.getElementById('selected-dish-title').textContent = platillo;
        
        // Cargar opciones de personalización
        const optionsContainer = document.getElementById('personalization-options');
        optionsContainer.innerHTML = '';
        
        for (const id in customizationOptions) {
            const btn = document.createElement('button');
            btn.className = 'option-btn';
            btn.textContent = customizationOptions[id];
            btn.setAttribute('data-option', id);
            
            btn.addEventListener('click', function() {
                this.classList.toggle('selected');
                updateCustomizations();
            });
            
            optionsContainer.appendChild(btn);
        }
    }

    // Actualizar lista de personalizaciones seleccionadas
    function updateCustomizations() {
        currentCustomizations = [];
        
        document.querySelectorAll('.option-btn.selected').forEach(el => {
            if (el.hasAttribute('data-option')) {
                currentCustomizations.push(customizationOptions[el.getAttribute('data-option')]);
            }
        });
    }

    // Iniciar preparación de un platillo
    function startPreparation() {
        // Crear el pedido
        const order = {
            id: generateId(),
            dish: currentDish,
            category: currentCategory,
            customizations: currentCustomizations,
            service: currentService,
            quantity: currentQuantity,
            notes: document.getElementById('notes-input').value,
            startTime: new Date(),
            startTimeFormatted: formatTime(new Date())
        };
        
        // Agregar a pendientes
        pendingOrders.push(order);
        
        // Actualizar tabla y mostrar notificación
        updatePendingTable();
        showNotification(`Nuevo pedido: ${order.dish} × ${order.quantity}`);
        
        // Regresar a la vista principal
        resetApp();
        guardarDatosLocales();
    }

    // Actualizar tabla de pedidos pendientes
    function updatePendingTable() {
        const tableBody = document.getElementById('pending-body');
        const pendingCount = document.getElementById('pending-count');
        
        // Actualizar contador
        pendingCount.textContent = pendingOrders.length;
        
        // Limpiar tabla
        tableBody.innerHTML = '';
        
        // Si no hay pedidos
        if (pendingOrders.length === 0) {
            const row = document.createElement('tr');
            row.innerHTML = '<td colspan="5" class="empty-message">No hay platillos en preparación</td>';
            tableBody.appendChild(row);
            return;
        }
        
        // Agregar cada pedido a la tabla
        pendingOrders.forEach(order => {
            const row = document.createElement('tr');
            
            // Calcular tiempo transcurrido
            const now = new Date();
            const startTime = new Date(order.startTime);
            const elapsedMs = now - startTime;
            const elapsedSecs = Math.floor(elapsedMs / 1000);
            const mins = Math.floor(elapsedSecs / 60);
            const secs = elapsedSecs % 60;
            
            // Determinar clase CSS según tiempo transcurrido
            let timerClass = '';
            if (mins >= 10) {
                timerClass = 'alert';
            } else if (mins >= 5) {
                timerClass = 'warning';
            }
            
            // Información a mostrar
            const customInfo = order.customizations.length > 0 
                ? `<strong>Personalización:</strong> ${order.customizations.join(', ')}<br>` 
                : '';
            const serviceInfo = `<strong>Servicio:</strong> ${getServiceName(order.service)}<br>`;
            const quantityInfo = order.quantity > 1 ? `<strong>Cantidad:</strong> ${order.quantity}<br>` : '';
            const notesInfo = order.notes ? `<strong>Notas:</strong> ${order.notes}` : '';
            
            row.innerHTML = `
                <td>${order.dish}</td>
                <td>${order.startTimeFormatted}</td>
                <td class="timer-cell ${timerClass}">${padZero(mins)}:${padZero(secs)}</td>
                <td class="details-cell">
                    ${customInfo}
                    ${serviceInfo}
                    ${quantityInfo}
                    ${notesInfo}
                </td>
                <td>
                    ${getActionButton(order)}
                </td>
            `;
            
            tableBody.appendChild(row);
        });
    }

    // Actualizar tabla de órdenes completadas
    function updateCompletedTable() {
        const tableBody = document.getElementById('completed-body');
        tableBody.innerHTML = '';
        
        // Si no hay pedidos completados
        if (completedOrders.length === 0) {
            const row = document.createElement('tr');
            row.innerHTML = '<td colspan="5" class="empty-message">No hay platillos completados</td>';
            tableBody.appendChild(row);
            return;
        }
        
        // Determina cuántos mostrar (todos o solo recientes)
        const showAllHistory = document.getElementById('btn-show-all-history').classList.contains('active');
        const ordersToShow = showAllHistory ? completedOrders : completedOrders.slice(0, 10);
        
        // Agregar cada pedido completado a la tabla
        ordersToShow.forEach(order => {
            const row = document.createElement('tr');
            
            // Información a mostrar
            const customInfo = order.customizations.length > 0 
                ? `<strong>Personalización:</strong> ${order.customizations.join(', ')}<br>` 
                : '';
            const serviceInfo = `<strong>Servicio:</strong> ${getServiceName(order.service)}<br>`;
            const quantityInfo = order.quantity > 1 ? `<strong>Cantidad:</strong> ${order.quantity}<br>` : '';
            const notesInfo = order.notes ? `<strong>Notas:</strong> ${order.notes}` : '';
            const deliveryInfo = order.deliveryTime ? `<strong>Tiempo de entrega:</strong> ${order.deliveryTime}<br>` : '';
            
            // Determina clase CSS según tiempo total
            let timeClass = 'time-excellent';
            const prepTime = order.prepTime || '';
            if (prepTime) {
                const mins = parseInt(prepTime.split(':')[0]);
                if (mins >= 15) {
                    timeClass = 'time-bad';
                } else if (mins >= 10) {
                    timeClass = 'time-warning';
                } else if (mins >= 5) {
                    timeClass = 'time-good';
                }
            }
            
            row.innerHTML = `
                <td>${order.dish}</td>
                <td>${order.startTimeFormatted}</td>
                <td>${order.endTimeFormatted}</td>
                <td class="${timeClass}">${order.prepTime}</td>
                <td class="details-cell">
                    ${customInfo}
                    ${serviceInfo}
                    ${quantityInfo}
                    ${deliveryInfo}
                    ${notesInfo}
                </td>
            `;
            
            tableBody.appendChild(row);
        });
    }

    // Finalizar preparación
    function finishPreparation(id) {
        const orderIndex = pendingOrders.findIndex(order => order.id === id);
        
        if (orderIndex === -1) return;
        
        const order = pendingOrders[orderIndex];
        
        const endTime = new Date();
        const prepTimeMillis = endTime - new Date(order.startTime);
        const prepTimeSecs = Math.floor(prepTimeMillis / 1000);
        const prepMins = Math.floor(prepTimeSecs / 60);
        const prepSecs = prepTimeSecs % 60;
        
        const prepTimeFormatted = padZero(prepMins) + ':' + padZero(prepSecs) + ' minutos';
        
        order.endTime = endTime;
        order.endTimeFormatted = formatTime(endTime);
        order.prepTime = prepTimeFormatted;
        
        completedOrders.unshift(order);
        pendingOrders.splice(orderIndex, 1);
        
        showNotification(`¡${order.dish} finalizado en ${prepTimeFormatted}!`);
        
        updatePendingTable();
        updateCompletedTable();
        guardarDatosLocales();
    }

    // Registra la salida del repartidor
    function markDeliveryDeparture(id) {
        const orderIndex = pendingOrders.findIndex(order => order.id === id);
        
        if (orderIndex === -1) return;
        
        const order = pendingOrders[orderIndex];
        
        // Registra el tiempo de salida
        order.deliveryDepartureTime = new Date();
        order.deliveryDepartureTimeFormatted = formatTime(order.deliveryDepartureTime);
        
        showNotification('Salida del repartidor registrada para ' + order.dish);
        updatePendingTable();
        guardarDatosLocales();
    }

    // Registra la entrega al cliente
    function markDeliveryArrival(id) {
        const orderIndex = pendingOrders.findIndex(order => order.id === id);
        
        if (orderIndex === -1) return;
        
        const order = pendingOrders[orderIndex];
        
        // Registra el tiempo de entrega
        order.deliveryArrivalTime = new Date();
        order.deliveryArrivalTimeFormatted = formatTime(order.deliveryArrivalTime);
        
        // Calcula tiempo total
        const endTime = order.deliveryArrivalTime;
        const prepTimeMillis = endTime - new Date(order.startTime);
        const prepTimeSecs = Math.floor(prepTimeMillis / 1000);
        const prepMins = Math.floor(prepTimeSecs / 60);
        const prepSecs = prepTimeSecs % 60;
        
        const prepTimeFormatted = padZero(prepMins) + ':' + padZero(prepSecs) + ' minutos';
        
        order.endTime = endTime;
        order.endTimeFormatted = formatTime(endTime);
        order.prepTime = prepTimeFormatted;
        
        // Calcula tiempo específico de entrega
        const deliveryTimeMillis = endTime - new Date(order.deliveryDepartureTime);
        const deliveryTimeSecs = Math.floor(deliveryTimeMillis / 1000);
        const deliveryMins = Math.floor(deliveryTimeSecs / 60);
        const deliverySecs = deliveryTimeSecs % 60;
        
        order.deliveryTime = padZero(deliveryMins) + ':' + padZero(deliverySecs) + ' minutos';
        
        completedOrders.unshift(order);
        pendingOrders.splice(orderIndex, 1);
        
        showNotification(`¡${order.dish} entregado al cliente! Tiempo total: ${prepTimeFormatted}`);
        
        updatePendingTable();
        updateCompletedTable();
        guardarDatosLocales();
    }
    // Función para regresar a la pantalla principal
    function resetApp() {
        document.getElementById('dishes-section').style.display = 'none';
        document.getElementById('preparation-section').style.display = 'none';
        document.getElementById('categories-section').style.display = 'block';
        
        // Reset estados
        currentCategory = '';
        currentDish = '';
        currentCustomizations = [];
        currentService = 'comedor';
        currentQuantity = 1;
        document.getElementById('quantity-display').textContent = "1";
        document.getElementById('notes-input').value = '';
        
        // Reset UI de servicio
        document.querySelectorAll('.option-btn[id^="btn-"]').forEach(el => {
            el.classList.remove('selected');
        });
        document.getElementById('btn-comedor').classList.add('selected');
    }

    // Guardar datos en localStorage
    function guardarDatosLocales() {
        localStorage.setItem('avika_pendingOrders', JSON.stringify(pendingOrders));
        localStorage.setItem('avika_completedOrders', JSON.stringify(completedOrders));
    }

    // Cargar datos de localStorage
    function cargarDatosLocales() {
        const pendingData = localStorage.getItem('avika_pendingOrders');
        const completedData = localStorage.getItem('avika_completedOrders');
        
        if (pendingData) {
            pendingOrders = JSON.parse(pendingData);
        }
        
        if (completedData) {
            completedOrders = JSON.parse(completedData);
        }
    }

    // Función para iniciar el timer que actualiza los tiempos de pedidos pendientes
    function iniciarTimer() {
        // Limpiar intervalo existente si hay uno
        if (timerInterval) {
            clearInterval(timerInterval);
        }
        
        // Actualizar cada segundo
        timerInterval = setInterval(() => {
            // Solo actualizar si hay pedidos pendientes
            if (pendingOrders.length > 0) {
                updatePendingTable();
            }
        }, 1000);
    }

    // Mostrar notificación
    function showNotification(message, type = 'success') {
        const notification = document.getElementById('notification');
        notification.textContent = message;
        notification.style.display = 'block';
        
        // Asignar clase según tipo
        notification.className = '';
        notification.classList.add('notification', `notification-${type}`);
        
        // Ocultar después de 3 segundos
        setTimeout(() => {
            notification.style.display = 'none';
        }, 3000);
    }

    // Alternar entre tema claro y oscuro
    function toggleTheme() {
        document.body.classList.toggle('dark-mode');
        const themeButton = document.getElementById('toggle-theme');
        
        if (document.body.classList.contains('dark-mode')) {
            themeButton.textContent = '☀️';
            localStorage.setItem('avika_theme', 'dark');
        } else {
            themeButton.textContent = '🌙';
            localStorage.setItem('avika_theme', 'light');
        }
    }

    // Obtener nombre del servicio
    function getServiceName(serviceId) {
        const services = {
            'comedor': 'Comedor',
            'domicilio': 'Domicilio',
            'para-llevar': 'Ordena y Espera'
        };
        return services[serviceId] || serviceId;
    }

    // Función de utilidad para generar ID
    function generateId() {
        return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }

    // Función para formatear hora
    function formatTime(date) {
        return date.toLocaleTimeString('es-MX', {
            hour: '2-digit',
            minute: '2-digit',
            hour12: true
        });
    }

    // Agregar ceros iniciales
    function padZero(num) {
        return num < 10 ? '0' + num : num;
    }

    // Mostrar modal de promedios
    function showPromedios() {
        if (completedOrders.length === 0) {
            showNotification('No hay datos suficientes para calcular promedios', 'warning');
            return;
        }
        
        const container = document.getElementById('promedios-contenido');
        container.innerHTML = '<h3>Tiempo Promedio por Platillo</h3>';
        
        // Agrupar por platillo
        const platillos = {};
        completedOrders.forEach(order => {
            const platillo = order.dish;
            if (!platillos[platillo]) {
                platillos[platillo] = [];
            }
            
            // Extraer minutos del tiempo formateado
            if (order.prepTime) {
                const minutos = parseInt(order.prepTime.split(':')[0]);
                platillos[platillo].push(minutos);
            }
        });
        
        // Calcular promedios
        const promedios = [];
        for (const platillo in platillos) {
            const tiempos = platillos[platillo];
            if (tiempos.length > 0) {
                const promedio = tiempos.reduce((a, b) => a + b, 0) / tiempos.length;
                promedios.push({
                    platillo: platillo,
                    promedio: promedio,
                    count: tiempos.length
                });
            }
        }
        
        // Ordenar por promedio
        promedios.sort((a, b) => a.promedio - b.promedio);
        
        // Crear tabla
        let html = `
            <table style="width: 100%; margin-top: 15px;">
                <thead>
                    <tr>
                        <th>Platillo</th>
                        <th>Tiempo Promedio</th>
                        <th>Cantidad</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        promedios.forEach(item => {
            let timeClass = 'time-excellent';
            if (item.promedio >= 15) {
                timeClass = 'time-bad';
            } else if (item.promedio >= 10) {
                timeClass = 'time-warning';
            } else if (item.promedio >= 5) {
                timeClass = 'time-good';
            }
            
            html += `
                <tr>
                    <td>${item.platillo}</td>
                    <td class="${timeClass}">${item.promedio.toFixed(1)} min</td>
                    <td>${item.count}</td>
                </tr>
            `;
        });
        
        html += `
                </tbody>
            </table>
        `;
        
        container.innerHTML += html;
        document.getElementById('promedios-modal').classList.add('active');
    }

    // Exportar datos a CSV
    function exportToCSV() {
        if (completedOrders.length === 0) {
            showNotification('No hay datos para exportar', 'warning');
            return;
        }
        
        // Crear CSV
        let csv = 'Platillo,Inicio,Fin,Tiempo,Servicio,Personalización,Notas\n';
        
        completedOrders.forEach(order => {
            const personalizacion = order.customizations.join(' + ');
            const notas = order.notes ? order.notes.replace(/,/g, ';') : '';
            
            csv += `"${order.dish}","${order.startTimeFormatted}","${order.endTimeFormatted}","${order.prepTime}","${getServiceName(order.service)}","${personalizacion}","${notas}"\n`;
        });
        
        // Crear blob y descargar
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        
        link.setAttribute('href', url);
        link.setAttribute('download', `avika_pedidos_${formatDateForFile(new Date())}.csv`);
        link.style.visibility = 'hidden';
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showNotification('Datos exportados correctamente');
    }

    // Formatear fecha para nombre de archivo
    function formatDateForFile(date) {
        const day = padZero(date.getDate());
        const month = padZero(date.getMonth() + 1);
        const year = date.getFullYear();
        const hours = padZero(date.getHours());
        const mins = padZero(date.getMinutes());
        
        return `${year}${month}${day}_${hours}${mins}`;
    }
    </script>
</body>
</html><!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Avika - Temporizador</title>
    <style>
        /* Estilos base optimizados para iPhone */
        :root {
            --bg-color: #f0f0f0;
            --container-bg: #ffffff;
            --text-color: #333333;
            --header-bg: #e74c3c;
            --header-text: white;
            --primary-btn: #3498db;
            --primary-btn-text: white;
            --success-btn: #2ecc71;
            --danger-btn: #e74c3c;
            --warning-btn: #f0ad4e;
            --info-btn: #5bc0de;
            --border-color: #ddd;
            --table-header-bg: #3498db;
            --table-header-text: white;
            --notification-bg: #2ecc71;
            --highlight-bg: #f9f9f9;
            --shadow-color: rgba(0,0,0,0.1);
            --btn-hover: #2980b9;
            
            /* Variables para tiempos */
            --time-excellent: #2ecc71;
            --time-good: #7fdbff;
            --time-warning: #f39c12;
            --time-bad: #e74c3c;
            
            /* Transiciones */
            --transition-speed: 0.3s;
            
            /* Fuentes */
            --font-main: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            --font-monospace: 'Menlo', monospace;
        }

        .dark-mode {
            --bg-color: #121212;
            --container-bg: #1e1e1e;
            --text-color: #e0e0e0;
            --header-bg: #c0392b;
            --header-text: #f0f0f0;
            --primary-btn: #2980b9;
            --primary-btn-text: #f0f0f0;
            --success-btn: #27ae60;
            --danger-btn: #c0392b;
            --warning-btn: #d35400;
            --info-btn: #2980b9;
            --border-color: #444;
            --table-header-bg: #2980b9;
            --table-header-text: #f0f0f0;
            --notification-bg: #27ae60;
            --highlight-bg: #2a2a2a;
            --shadow-color: rgba(0,0,0,0.3);
            --btn-hover: #3498db;
            
            /* Colores de tiempos en modo oscuro */
            --time-excellent: #27ae60;
            --time-good: #2980b9;
            --time-warning: #d35400;
            --time-bad: #c0392b;
        }

        /* Estilos generales */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: var(--font-main);
            margin: 0;
            padding: 15px;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color var(--transition-speed), color var(--transition-speed);
            line-height: 1.6;
            -webkit-user-select: none;
            user-select: none;
            overscroll-behavior: none;
            -webkit-overflow-scrolling: touch;
            touch-action: manipulation;
        }

        /* Encabezado */
        header {
            background-color: var(--header-bg);
            color: var(--header-text);
            padding: 15px;
            text-align: center;
            margin-bottom: 20px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px var(--shadow-color);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        header h1 {
            margin: 0;
            flex: 1;
            font-size: 1.5rem;
        }

        .header-controls {
            display: flex;
            gap: 10px;
        }

        .icon-btn {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--header-text);
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: background-color var(--transition-speed);
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: manipulation;
        }

        .icon-btn:active {
            background-color: rgba(255, 255, 255, 0.2);
        }

        /* Contenedor principal */
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding-bottom: 80px; /* Para evitar que el último elemento quede oculto detrás del dock de iOS */
        }

        /* Secciones */
        section {
            background-color: var(--container-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px var(--shadow-color);
            margin-bottom: 20px;
            transition: background-color var(--transition-speed);
        }

        /* Contenedor de categorías */
        .category-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .category-btn {
            background-color: var(--primary-btn);
            color: var(--primary-btn-text);
            border: none;
            padding: 15px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            height: 70px;
            transition: background-color var(--transition-speed), transform 0.2s;
            box-shadow: 0 2px 4px var(--shadow-color);
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: manipulation;
        }

        .category-btn:active {
            background-color: var(--btn-hover);
            transform: scale(0.98);
        }

        /* Sección de platillos */
        .dishes-section {
            display: none;
        }

        .dishes-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .dish-btn {
            background-color: var(--container-bg);
            color: var(--text-color);
            border: 1px solid var(--primary-btn);
            padding: 12px 10px;
            font-size: 14px;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: background-color var(--transition-speed), 
                        color var(--transition-speed), 
                        transform 0.2s;
            height: 60px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            touch-action: manipulation;
            position: relative;
        }

        .dish-btn:active {
            background-color: var(--primary-btn);
            color: var(--primary-btn-text);
            transform: scale(0.98);
        }

        .dish-btn.special-combo {
            border: 2px solid var(--danger-btn);
            position: relative;
        }

        .dish-btn.special-combo::after {
            content: "★";
            position: absolute;
            top: 5px;
            right: 5px;
            color: var(--danger-btn);
            font-size: 14px;
        }

        /* Sección de preparación */
        .preparation-section {
            display: none;
            background-color: var(--container-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 3px 10px var(--shadow-color);
            margin-top: 20px;
        }

        .option-group {
            margin-bottom: 20px;
        }

        .option-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--text-color);
            font-size: 1.1rem;
        }

        .option-btns {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .option-btn {
            background-color: var(--highlight-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color var(--transition-speed), color var(--transition-speed);
            font-size: 14px;
            flex: 1;
            min-width: 100px;
            text-align: center;
            touch-action: manipulation;
        }

        .option-btn.selected {
            background-color: var(--primary-btn);
            color: var(--primary-btn-text);
            border-color: var(--primary-btn);
        }

        /* Control de cantidad */
        .qty-control {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .qty-btn {
            background-color: var(--primary-btn);
            color: var(--primary-btn-text);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color var(--transition-speed);
            touch-action: manipulation;
        }

        .qty-btn:active {
            background-color: var(--btn-hover);
        }

        .qty-display {
            font-size: 20px;
            font-weight: bold;
            min-width: 40px;
            text-align: center;
            color: var(--text-color);
        }

        /* Área de notas */
        .notes-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background-color: var(--container-bg);
            color: var(--text-color);
            resize: vertical;
            min-height: 80px;
            font-family: var(--font-main);
            transition: border-color var(--transition-speed);
            font-size: 16px; /* Evita el zoom automático en iOS */
        }

        .notes-input:focus {
            outline: none;
            border-color: var(--primary-btn);
        }

        /* Botones de acción */
        .action-btns {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }

        .action-btn {
            flex: 1;
            padding: 14px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color var(--transition-speed), 
                        transform 0.2s,
                        box-shadow 0.2s;
            box-shadow: 0 2px 4px var(--shadow-color);
            touch-action: manipulation;
        }

        .action-btn:active {
            transform: scale(0.98);
            box-shadow: 0 1px 2px var(--shadow-color);
        }

        .cancel-btn {
            background-color: var(--danger-btn);
            color: white;
        }

        .start-btn {
            background-color: var(--success-btn);
            color: white;
        }

        .back-btn {
            background-color: var(--warning-btn);
            color: white;
            padding: 12px 18px;
            margin: 15px 0;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color var(--transition-speed), transform 0.2s;
            box-shadow: 0 2px 4px var(--shadow-color);
            touch-action: manipulation;
        }

        .back-btn:active {
            transform: scale(0.98);
        }

        /* Tablas */
        .pending-orders-section {
            margin-top: 30px;
            background-color: var(--container-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px var(--shadow-color);
        }

        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .timer-cell {
            font-weight: bold;
            color: var(--text-color);
            font-size: 16px;
            font-family: var(--font-monospace);
        }

        .timer-cell.warning {
            color: var(--time-warning);
        }

        .timer-cell.alert {
            color: var(--time-bad);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }

        .finish-btn {
            background-color: var(--success-btn);
            color: white;
            border: none;
            padding: 10px 8px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
            margin-bottom: 5px;
            transition: background-color var(--transition-speed), transform 0.2s;
            box-shadow: 0 2px 4px var(--shadow-color);
            font-size: 14px;
            touch-action: manipulation;
        }

        .finish-btn:active {
            transform: scale(0.98);
        }

        .finish-btn.hot-kitchen {
            background-color: var(--danger-btn);
        }

        .finish-btn.cold-kitchen {
            background-color: var(--info-btn);
        }

        .finish-btn.delivery {
            background-color: #f39c12;
        }

        .finish-btn.delivery-arrived {
            background-color: #3498db;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
            font-size: 14px;
        }

        th, td {
            border: 1px solid var(--border-color);
            padding: 8px 6px;
            text-align: left;
            color: var(--text-color);
            transition: background-color var(--transition-speed);
        }

        th {
            background-color: var(--table-header-bg);
            color: var(--table-header-text);
            position: sticky;
            top: 0;
            font-size: 12px;
        }

        tr:active td {
            background-color: var(--highlight-bg);
        }

        /* Clases para tiempos */
        .time-excellent {
            color: var(--time-excellent);
            font-weight: bold;
        }

        .time-good {
            color: var(--time-good);
        }

        .time-warning {
            color: var(--time-warning);
        }

        .time-bad {
            color: var(--time-bad);
            font-weight: bold;
        }

        /* Notificaciones */
        #notification {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--notification-bg);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px var(--shadow-color);
            max-width: 350px;
            z-index: 1000;
            display: none;
            animation: fadeIn 0.3s;
            font-weight: 500;
            text-align: center;
            width: 85%;
        }

        .notification-success {
            background-color: var(--success-btn);
        }

        .notification-warning {
            background-color: var(--warning-btn);
        }

        .notification-error {
            background-color: var(--danger-btn);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translate(-50%, 20px); }
            to { opacity: 1; transform: translate(-50%, 0); }
        }

        /* Mejoras de accesibilidad */
        :focus {
            outline: 2px solid var(--primary-btn);
            outline-offset: 2px;
        }

        /* Animaciones */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .dishes-section, .preparation-section {
            animation: fadeInUp 0.3s ease-out;
        }

        /* PWA mejoras */
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .button-group .back-btn {
            flex: 1;
            margin: 0;
            font-size: 14px;
            white-space: nowrap;
            padding: 10px;
            text-align: center;
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            z-index: 1001;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .modal.active {
            opacity: 1;
            pointer-events: all;
        }

        .modal-content {
            background-color: var(--container-bg);
            padding: 20px;
            border-radius: 8px;
            max-width: 90%;
            max-height: 90%;
            overflow: auto;
            -webkit-overflow-scrolling: touch;
            margin: 10px;
        }

        /* Filtros */
        .filter-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .filter-btn {
            background-color: var(--highlight-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color var(--transition-speed), 
                        color var(--transition-speed),
                        transform 0.2s;
            font-size: 14px;
            touch-action: manipulation;
        }

        .filter-btn:active {
            transform: scale(0.98);
        }

        .filter-btn.active {
            background-color: var(--primary-btn);
            color: var(--primary-btn-text);
            border-color: var(--primary-btn);
        }

        /* Encabezados */
        h2 {
            margin-bottom: 15px;
            color: var(--text-color);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 8px;
            font-size: 18px;
        }

        .section-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .count-badge {
            background-color: var(--primary-btn);
            color: white;
            font-size: 12px;
            padding: 3px 8px;
            border-radius: 10px;
            font-weight: bold;
        }

        /* Mensajes vacíos */
        .empty-message {
            text-align: center;
            color: #777;
            font-style: italic;
            padding: 15px;
        }

        /* Detalles de pedido */
        .details-cell {
            font-size: 12px;
            line-height: 1.3;
        }

        /* App instalación guía */
        .install-guide {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: rgba(0,0,0,0.85);
            color: white;
            padding: 15px;
            font-size: 14px;
            display: none;
            z-index: 10000;
        }

        .install-guide p {
            margin-bottom: 10px;
        }

        .install-guide button {
            background-color: white;
            color: black;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            touch-action: manipulation;
        }

        /* Mejoras específicas para iOS */
        @supports (-webkit-touch-callout: none) {
            /* CSS específico para iOS */
            input, button, textarea, select {
                font-size: 16px; /* Previene zoom automático */
            }
            
            /* Corrige el comportamiento de botones en iOS */
            button, .option-btn, .finish-btn, .action-btn, .back-btn, .category-btn, .dish-btn, .filter-btn {
                touch-action: manipulation;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>Avika - Temporizador</h1>
        <div class="header-controls">
            <button id="toggle-theme" class="icon-btn">🌙</button>
        </div>
    </header>
    
    <div class="container">
        <!-- Notificaciones -->
        <div id="notification"></div>
        
        <!-- Sección de categorías -->
        <div id="categories-section">
            <h2>Selecciona una categoría</h2>
            <div class="category-container">
                <button class="category-btn" id="btn-frio">Platillos Fríos</button>
                <button class="category-btn" id="btn-entrada-fria">Entradas Frías</button>
                <button class="category-btn" id="btn-caliente">Platillos Calientes</button>
                <button class="category-btn" id="btn-entrada-caliente">Entradas Calientes</button>
                <button class="category-btn" id="btn-combos">Combos</button>
            </div>
            
            <!-- Órdenes pendientes -->
            <div class="pending-orders-section">
                <div class="section-title">
                    <h2>Platillos en preparación</h2>
                    <div class="count-badge" id="pending-count">0</div>
                </div>
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Platillo</th>
                                <th>Inicio</th>
                                <th>Tiempo</th>
                                <th>Detalles</th>
                                <th>Acción</th>
                            </tr>
                        </thead>
                        <tbody id="pending-body">
                            <!-- Se llenará con JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Órdenes completadas -->
            <div class="pending-orders-section">
                <h2>Platillos completados</h2>
                <div class="filter-controls">
                    <button id="btn-show-all-history" class="filter-btn">Ver historial</button>
                    <button id="btn-show-recent" class="filter-btn active">Ver recientes</button>
                </div>
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Platillo</th>
                                <th>Inicio</th>
                                <th>Fin</th>
                                <th>Total</th>
                                <th>Detalles</th>
                            </tr>
                        </thead>
                        <tbody id="completed-body">
                            <!-- Se llenará con JavaScript -->
                        </tbody>
                    </table>
                </div>
                <div class="button-group">
                    <button class="back-btn" id="btn-promedios" style="background-color: #3498db;">Ver Promedios</button>
                    <button class="back-btn" id="btn-export">Exportar a Excel</button>
                    <button class="back-btn" id="btn-clear" style="background-color: #e74c3c;">Limpiar</button>
                </div>
            </div>
        </div>
        
        <!-- Sección de platillos -->
        <div id="dishes-section" style="display: none;">
            <h2 id="selected-category-title">Categoría</h2>
            <div id="dishes-container" class="dishes-container">
                <!-- Se llenará con JavaScript -->
            </div>
            
            <button class="back-btn" id="btn-back-to-categories">Volver a Categorías</button>
        </div>
        
        <!-- Sección de preparación -->
        <div id="preparation-section" class="preparation-section" style="display: none;">
            <h2 id="selected-dish-title">Platillo</h2>
            
            <div id="personalization-section">
                <div class="option-group">
                    <div class="option-title">Personalización</div>
                    <div class="option-btns" id="personalization-options">
                        <!-- Se llenará dinámicamente con JS -->
                    </div>
                </div>
            </div>
            
            <div class="option-group">
                <div class="option-title">Tipo de Servicio</div>
                <div class="option-btns">
                    <button class="option-btn selected" id="btn-comedor">Comedor</button>
                    <button class="option-btn" id="btn-domicilio">Domicilio</button>
                    <button class="option-btn" id="btn-para-llevar">Ordena y Espera</button>
                </div>
            </div>
            
            <div class="option-group">
                <div class="option-title">Cantidad</div>
                <div class="qty-control">
                    <button class="qty-btn" id="btn-decrease">-</button>
                    <span class="qty-display" id="quantity-display">1</span>
                    <button class="qty-btn" id="btn-increase">+</button>
                </div>
            </div>
            
            <div class="option-group">
                <div class="option-title">Notas Especiales</div>
                <textarea class="notes-input" id="notes-input" placeholder="Ej: Cliente alérgico a mariscos" rows="3"></textarea>
            </div>
            
            <div class="action-btns">
                <button class="action-btn cancel-btn" id="btn-cancel">Cancelar</button>
                <button class="action-btn start-btn" id="btn-start">Iniciar Preparación</button>
            </div>
            <button class="back-btn" id="btn-back-to-dishes" style="width: 100%; margin-top: 10px;">Atrás</button>
        </div>
    </div>
    
    <!-- Modal para promedios -->
    <div id="promedios-modal" class="modal">
        <div class="modal-content">
            <div id="promedios-contenido">
                <!-- Se llenará con JavaScript -->
            </div>
            <button class="back-btn" id="modal-close" style="width: 100%; margin-top: 15px;">Cerrar</button>
        </div>
    </div>
    
    <!-- Guía de instalación -->
    <div class="install-guide" id="install-guide">
        <p>Para una mejor experiencia, añade esta app a tu pantalla de inicio</p>
        <p>1. Toca el icono <strong>compartir</strong> <span style="font-size: 18px">⬆️</span> abajo</p>
        <p>2. Desplázate y selecciona <strong>"Añadir a pantalla de inicio"</strong></p>
        <button id="hide-guide">Entendido</button>
    </div>

    <script>
    // Variables globales (estado)
    var currentCategory = '';
    var currentDish = '';
    var currentCustomizations = [];
    var currentService = 'comedor';
    var currentQuantity = 1;
    var isSpecialCombo = false;

    // Arrays para almacenar pedidos
    var pendingOrders = [];
    var completedOrders = [];
    var timerInterval;

    // Opciones de personalización predeterminadas
    var customizationOptions = {
        'sin-alga': 'Sin Alga',
        'extra-picante': 'Extra Picante',
        'cambio-proteina': 'Cambiar Proteína'
    };

    // Datos de platillos
    var dishes = {
        'frio': [
            'Baby Squid', 'Tiradito de Atún Togarashi', 'Tiradito de Camarón', 'Maguro Peruano',
            'Tostadita Nikkei', 'Tostada de ceviche verde', 'Tostadita Tataki', 'Tostadita Crunchy',
            'Cocktail Avika', 'Ceviche Limeño', 'Ceviche Peruano',
            'Sashimi de Robalo', 'Sashimi de Atún', 'Sashimi Mixto', 'Sashimi de Salmón',
            'Kanikama Roll', 'Curry Roll', 'Philadelphia Roll', 'Spicy Roll', 'Aguacate Roll',
            'Avi Roll', 'Mango Roll', 'Mikuso Roll', 'Acevichado Roll', 'Dragon Roll', 
            'Furai Roll', 'Coco Roll', 'Red Fire Roll', 'Ebi Crunch Roll', 'Teriyaki Crunch Roll',
            'TNT Roll', 'Ika Ebi Roll', 'Tuna Roll', 'Rocotto Roll', 'Parrillero Roll',
            'Rib Eye Roll', 'Avika Roll'
        ],
        'entrada-fria': [
            'Baby Squid', 'Tiradito de Atún Togarashi', 'Tiradito de Camarón', 'Maguro Peruano',
            'Tostadita Nikkei', 'Tostada de ceviche verde', 'Tostadita Tataki', 'Tostadita Crunchy',
            'Cocktail Avika', 'Ceviche Limeño', 'Ceviche Peruano'
        ],
        'caliente': [
            'Arroz Yakimeshi', 'Arroz Peruano', 'Arroz Wok', 'Arroz Thai con Mariscos',
            'Teriyaki', 'Yakisoba', 'Nuggets', 'Pechuga Teriyaki', 'Lomo Saltado', 'Rib Eye Grill',
            'Camarón Nutty', 'Camarón Iwa', 'Pasta de Mar', 'Ebi Chips', 'Pulpo Marine',
            'Tuna Thai', 'Atún salsa Rocotto', 'Filete Thai Asia', 'Filete Ninjago',
            'Filete Zakana Thai', 'Salmón Kion', 'Sake New Style', 'Pargo al Ika Ebi'
        ],
        'entrada-caliente': [
            'Kushiage', 'Rollitos Kani', 'Toritos Tempura', 'Taquitos Crujientes', 
            'Miso Shiro', 'Sopa Udon', 'Sopa Ramen de Cerdo', 'Sopa Mariscos Thai',
            'Tacos Nikkei', 'Tacos de Costra de Queso', 'Brocheta Yakitori', 'Ika Ebi Togarashi'
        ],
        'combos': [
            'Combo Tokio', 'Combo Osaka', 'Combo Bagua', 'Combo Pisco', 'Combo Lima'
        ]
    };

    // Lista de platillos especiales
    var specialDishes = [
        'Baby Squid', 'Tiradito de Camarón', 'Maguro Peruano', 'Tostadita Crunchy',
        'Spicy Roll', 'Red Fire Roll', 'Ebi Crunch Roll', 'TNT Roll', 'Rib Eye Roll',
        'Avika Roll', 'Toritos Tempura', 'Taquitos Crujientes', 'Ika Ebi Togarashi',
        'Ebi Chips', 'Pulpo Marine', 'Filete Zakana Thai', 'Salmón Kion',
        'Combo Tokio', 'Combo Osaka', 'Combo Bagua'
    ];

    // Mostrar sección de categorías al inicio
    document.addEventListener('DOMContentLoaded', function() {
        // Cargar datos guardados
        cargarDatosLocales();
        
        // Actualizar tablas
        updatePendingTable();
        updateCompletedTable();
        
        // Iniciar timer para actualizar tiempos
        iniciarTimer();
        
        // Inicializar eventos
        setupEventListeners();
        
        // Aplicar tema guardado
        if (localStorage.getItem('avika_theme') === 'dark') {
            document.body.classList.add('dark-mode');
            document.getElementById('toggle-theme').textContent = '☀️';
        }
        
        // Mostrar guía de instalación si es necesario
        if (localStorage.getItem('avika_hideGuide') !== 'true') {
            document.getElementById('install-guide').style.display = 'block';
        }
    });

    // Configurar todos los eventos de la aplicación
    function setupEventListeners() {
        // Botones de categoría
        document.getElementById('btn-frio').addEventListener('click', function() {
            currentCategory = 'frio';
            mostrarPlatillos('frio', 'Platillos Fríos');
        });
        
        document.getElementById('btn-entrada-fria').addEventListener('click', function() {
            currentCategory = 'entrada-fria';
            mostrarPlatillos('entrada-fria', 'Entradas Frías');
        });
        
        document.getElementById('btn-caliente').addEventListener('click', function() {
            currentCategory = 'caliente';
            mostrarPlatillos('caliente', 'Platillos Calientes');
        });
        
        document.getElementById('btn-entrada-caliente').addEventListener('click', function() {
            currentCategory = 'entrada-caliente';
            mostrarPlatillos('entrada-caliente', 'Entradas Calientes');
        });
        
        document.getElementById('btn-combos').addEventListener('click', function() {
            currentCategory = 'combos';
            mostrarPlatillos('combos', 'Combos');
        });
        
        // Botón para volver a categorías
        document.getElementById('btn-back-to-categories').addEventListener('click', function() {
            document.getElementById('dishes-section').style.display = 'none';
            document.getElementById('categories-section').style.display = 'block';
        });
        
        // Botón para volver a platillos
        document.getElementById('btn-back-to-dishes').addEventListener('click', function() {
            document.getElementById('preparation-section').style.display = 'none';
            document.getElementById('dishes-section').style.display = 'block';
        });
        
        // Botones de servicio
        document.getElementById('btn-comedor').addEventListener('click', function() {
            document.querySelectorAll('.option-btn[id^="btn-"]').forEach(el => {
                el.classList.remove('selected');
            });
            this.classList.add('selected');
            currentService = 'comedor';
        });
        
        document.getElementById('btn-domicilio').addEventListener('click', function() {
            document.querySelectorAll('.option-btn[id^="btn-"]').forEach(el => {
                el.classList.remove('selected');
            });
            this.classList.add('selected');
            currentService = 'domicilio';
        });
        
        document.getElementById('btn-para-llevar').addEventListener('click', function() {
            document.querySelectorAll('.option-btn[id^="btn-"]').forEach(el => {
                el.classList.remove('selected');
            });
            this.classList.add('selected');
            currentService = 'para-llevar';
        });
        
        // Botones de cantidad
        document.getElementById('btn-decrease').addEventListener('click', function() {
            if (currentQuantity > 1) {
                currentQuantity--;
                document.getElementById('quantity-display').textContent = currentQuantity;
            }
        });
        
        document.getElementById('btn-increase').addEventListener('click', function() {
            currentQuantity++;
            document.getElementById('quantity-display').textContent = currentQuantity;
        });
        
        // Botones de acción
        document.getElementById('btn-start').addEventListener('click', startPreparation);
        document.getElementById('btn-cancel').addEventListener('click', resetApp);
        
        // Botones de filtro
        document.getElementById('btn-show-all-history').addEventListener('click', function() {
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            updateCompletedTable();
        });
        
        document.getElementById('btn-show-recent').addEventListener('click', function() {
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            updateCompletedTable();
        });
        
        // Botón de tema
        document.getElementById('toggle-theme').addEventListener('click', toggleTheme);
        
        // Botón de guía de instalación
        document.getElementById('hide-guide').addEventListener('click', function() {
            document.getElementById('install-guide').style.display = 'none';
            localStorage.setItem('avika_hideGuide', 'true');
        });
        
        // Botón de promedios
        document.getElementById('btn-promedios').addEventListener('click', showPromedios);
        document.getElementById('modal-close').addEventListener('click', function() {
            document.getElementById('promedios-modal').classList.remove('active');
        });
        
        // Botón de exportar
        document.getElementById('btn-export').addEventListener('click', exportToCSV);
        
        // Botón de limpiar
        document.getElementById('btn-clear').addEventListener('click', function() {
            if (confirm('¿Estás seguro de que deseas eliminar todos los datos? Esta acción no se puede deshacer.')) {
                pendingOrders = [];
                completedOrders = [];
                updatePendingTable();
                updateCompletedTable();
                guardarDatosLocales();
                showNotification('Todos los datos han sido eliminados', 'warning');
            }
        });
    }

    // Mostrar los platillos de una categoría
    function mostrarPlatillos(categoria, titulo) {
        document.getElementById('categories-section').style.display = 'none';
        document.getElementById('dishes-section').style.display = 'block';
        document.getElementById('selected-category-title').textContent = titulo;
        
        const container = document.getElementById('dishes-container');
        container.innerHTML = '';
        
        dishes[categoria].forEach(dish => {
            const btn = document.createElement('button');
            btn.className = 'dish-btn';
            btn.textContent = dish;
            
            // Si es un platillo especial, aplicar clase especial
            if (specialDishes.includes(dish)) {
                btn.className += ' special-combo';
                
                // Si es un combo, marcar como especial
                if (categoria === 'combos') {
                    isSpecialCombo = true;
                }
            }
            
            btn.addEventListener('click', function() {
                seleccionarPlatillo(dish);
            });
            
            container.appendChild(btn);
        });
    }

    // Seleccionar un platillo y mostrar opciones de personalización
    function seleccionarPlatillo(platillo) {
        currentDish = platillo;
        document.getElementById('dishes-section').style.display = 'none';
        document.getElementById('preparation-section').style.display = 'block';
        document.getElementById('selected-dish-title').textContent = platillo;
        
        // Cargar opciones de personalización
        const optionsContainer = document.getElementById('personalization-options');
        optionsContainer.innerHTML = '';
        
        for (const id in customizationOptions) {
            const btn = document.createElement('button');
            btn.className = 'option-btn';
            btn.textContent = customizationOptions[id];
            btn.setAttribute('data-option', id);
            
            btn.addEventListener('click', function() {
                this.classList.toggle('selected');
                updateCustomizations();
            });
            
            optionsContainer.appendChild(btn);
        }
    }

    // Actualizar lista de personalizaciones seleccionadas
    function updateCustomizations() {
        currentCustomizations = [];
        
        document.querySelectorAll('.option-btn.selected').forEach(el => {
            if (el.hasAttribute('data-option')) {
                currentCustomizations.push(customizationOptions[el.getAttribute('data-option')]);
            }
        });
    }

    // Iniciar preparación de un platillo
    function startPreparation() {
        // Crear el pedido
        const order = {
            id: generateId(),
            dish: currentDish,
            category: currentCategory,
            customizations: currentCustomizations,
            service: currentService,
            quantity: currentQuantity,
            notes: document.getElementById('notes-input').value,
            startTime: new Date(),
            startTimeFormatted: formatTime(new Date())
        };
        
        // Agregar a pendientes
        pendingOrders.push(order);
        
        // Actualizar tabla y mostrar notificación
        updatePendingTable();
        showNotification(`Nuevo pedido: ${order.dish} × ${order.quantity}`);
        
        // Regresar a la vista principal
        resetApp();
        guardarDatosLocales();
    }

    // Actualizar tabla de pedidos pendientes
    function updatePendingTable() {
        const tableBody = document.getElementById('pending-body');
        const pendingCount = document.getElementById('pending-count');
        
        // Actualizar contador
        pendingCount.textContent = pendingOrders.length;
        
        // Limpiar tabla
        tableBody.innerHTML = '';
        
        // Si no hay pedidos
        if (pendingOrders.length === 0) {
            const row = document.createElement('tr');
            row.innerHTML = '<td colspan="5" class="empty-message">No hay platillos en preparación</td>';
            tableBody.appendChild(row);
            return;
        }
        
        // Agregar cada pedido a la tabla
        pendingOrders.forEach(order => {
            const row = document.createElement('tr');
            
            // Calcular tiempo transcurrido
            const now = new Date();
            const startTime = new Date(order.startTime);
            const elapsedMs = now - startTime;
            const elapsedSecs = Math.floor(elapsedMs / 1000);
            const mins = Math.floor(elapsedSecs / 60);
            const secs = elapsedSecs % 60;
            
            // Determinar clase CSS según tiempo transcurrido
            let timerClass = '';
            if (mins >= 10) {
                timerClass = 'alert';
            } else if (mins >= 5) {
                timerClass = 'warning';
            }
            
            // Información a mostrar
            const customInfo = order.customizations.length > 0 
                ? `<strong>Personalización:</strong> ${order.customizations.join(', ')}<br>` 
                : '';
            const serviceInfo = `<strong>Servicio:</strong> ${getServiceName(order.service)}<br>`;
            const quantityInfo = order.quantity > 1 ? `<strong>Cantidad:</strong> ${order.quantity}<br>` : '';
            const notesInfo = order.notes ? `<strong>Notas:</strong> ${order.notes}` : '';
            
            row.innerHTML = `
                <td>${order.dish}</td>
                <td>${order.startTimeFormatted}</td>
                <td class="timer-cell ${timerClass}">${padZero(mins)}:${padZero(secs)}</td>
                <td class="details-cell">
                    ${customInfo}
                    ${serviceInfo}
                    ${quantityInfo}
                    ${notesInfo}
                </td>
                <td>
                    ${getActionButton(order)}
                </td>
            `;
            
            tableBody.appendChild(row);
        });
    }

    // Actualizar tabla de órdenes completadas
    function updateCompletedTable() {
        const tableBody = document.getElementById('completed-body');
        tableBody.innerHTML = '';
        
        // Si no hay pedidos completados
        if (completedOrders.length === 0) {
            const row = document.createElement('tr');
            row.innerHTML = '<td colspan="5" class="empty-message">No hay platillos completados</td>';
            tableBody.appendChild(row);
            return;
        }
        
        // Determina cuántos mostrar (todos o solo recientes)
        const showAllHistory = document.getElementById('btn-show-all-history').classList.contains('active');
        const ordersToShow = showAllHistory ? completedOrders : completedOrders.slice(0, 10);
        
        // Agregar cada pedido completado a la tabla
        ordersToShow.forEach(order => {
            const row = document.createElement('tr');
            
            // Información a mostrar
            const customInfo = order.customizations.length > 0 
                ? `<strong>Personalización:</strong> ${order.customizations.join(', ')}<br>` 
                : '';
            const serviceInfo = `<strong>Servicio:</strong> ${getServiceName(order.service)}<br>`;
            const quantityInfo = order.quantity > 1 ? `<strong>Cantidad:</strong> ${order.quantity}<br>` : '';
            const notesInfo = order.notes ? `<strong>Notas:</strong> ${order.notes}` : '';
            const deliveryInfo = order.deliveryTime ? `<strong>Tiempo de entrega:</strong> ${order.deliveryTime}<br>` : '';
            
            // Determina clase CSS según tiempo total
            let timeClass = 'time-excellent';
            const prepTime = order.prepTime || '';
            if (prepTime) {
                const mins = parseInt(prepTime.split(':')[0]);
                if (mins >= 15) {
                    timeClass = 'time-bad';
                } else if (mins >= 10) {
                    timeClass = 'time-warning';
                } else if (mins >= 5) {
                    timeClass = 'time-good';
                }
            }
            
            row.innerHTML = `
                <td>${order.dish}</td>
                <td>${order.startTimeFormatted}</td>
                <td>${order.endTimeFormatted}</td>
                <td class="${timeClass}">${order.prepTime}</td>
                <td class="details-cell">
                    ${customInfo}
                    ${serviceInfo}
                    ${quantityInfo}
                    ${deliveryInfo}
                    ${notesInfo}
                </td>
            `;
            
            tableBody.appendChild(row);
        });
    }

    // Finalizar preparación
    function finishPreparation(id) {
        const orderIndex = pendingOrders.findIndex(order => order.id === id);
        
        if (orderIndex === -1) return;
        
        const order = pendingOrders[orderIndex];
        
        const endTime = new Date();
        const prepTimeMillis = endTime - new Date(order.startTime);
        const prepTimeSecs = Math.floor(prepTimeMillis / 1000);
        const prepMins = Math.floor(prepTimeSecs / 60);
        const prepSecs = prepTimeSecs % 60;
        
        const prepTimeFormatted = padZero(prepMins) + ':' + padZero(prepSecs) + ' minutos';
        
        order.endTime = endTime;
        order.endTimeFormatted = formatTime(endTime);
        order.prepTime = prepTimeFormatted;
        
        completedOrders.unshift(order);
        pendingOrders.splice(orderIndex, 1);
        
        showNotification(`¡${order.dish} finalizado en ${prepTimeFormatted}!`);
        
        updatePendingTable();
        updateCompletedTable();
        guardarDatosLocales();
    }

    // Registra la salida del repartidor
    function markDeliveryDeparture(id) {
        const orderIndex = pendingOrders.findIndex(order => order.id === id);
        
        if (orderIndex === -1) return;
        
        const order = pendingOrders[orderIndex];
        
        // Registra el tiempo de salida
        order.deliveryDepartureTime = new Date();
        order.deliveryDepartureTimeFormatted = formatTime(order.deliveryDepartureTime);
        
        showNotification('Salida del repartidor registrada para ' + order.dish);
        updatePendingTable();
        guardarDatosLocales();
    }

    // Registra la entrega al cliente
    function markDeliveryArrival(id) {
        const orderIndex = pendingOrders.findIndex(order => order.id === id);
        
        if (orderIndex === -1) return;
        
        const order = pendingOrders[orderIndex];
        
        // Registra el tiempo de entrega
        order.deliveryArrivalTime = new Date();
        order.deliveryArrivalTimeFormatted = formatTime(order.deliveryArrivalTime);
        
        // Calcula tiempo total
        const endTime = order.deliveryArrivalTime;
        const prepTimeMillis = endTime - new Date(order.startTime);
        const prepTimeSecs = Math.floor(prepTimeMillis / 1000);
        const prepMins = Math.floor(prepTimeSecs / 60);
        const prepSecs = prepTimeSecs % 60;
        
        const prepTimeFormatted = padZero(prepMins) + ':' + padZero(prepSecs) + ' minutos';
        
        order.endTime = endTime;
        order.endTimeFormatted = formatTime(endTime);
        order.prepTime = prepTimeFormatted;
        
        // Calcula tiempo específico de entrega
        const deliveryTimeMillis = endTime - new Date(order.deliveryDepartureTime);
        const deliveryTimeSecs = Math.floor(deliveryTimeMillis / 1000);
        const deliveryMins = Math.floor(deliveryTimeSecs / 60);
        const deliverySecs = deliveryTimeSecs % 60;
        
        order.deliveryTime = padZero(deliveryMins) + ':' + padZero(deliverySecs) + ' minutos';
        
        completedOrders.unshift(order);
        pendingOrders.splice(orderIndex, 1);
        
        showNotification(`¡${order.dish} entregado al cliente! Tiempo total: ${prepTimeFormatted}`);
        
        updatePendingTable();
        updateCompletedTable();
        guardarDatosLocales();
    }